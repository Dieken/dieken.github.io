<!doctype html><html lang=en><head><meta charset=utf-8><title>如何禁用 LDAP 中的用户？</title><meta name=description content="如何禁用 LDAP 中的用户？"><meta name=author content="Yubao Liu"><meta name=viewport content="width=device-width,initial-scale=1"><noscript><link href="//fonts.googleapis.com/css?family=Source+Sans+Pro:400,600" rel=stylesheet type=text/css><link rel=stylesheet href=/css/fonts.css></noscript><style type=text/css media=screen>/*!Pure v3.0.0
Copyright 2013 Yahoo!
Licensed under the BSD License.
https://github.com/pure-css/pure/blob/master/LICENSE*//*!normalize.css v | MIT License | https://necolas.github.io/normalize.css/
Copyright (c) Nicolas Gallagher and Jonathan Neal*//*!normalize.css v8.0.1 | MIT License | github.com/necolas/normalize.css*/html{line-height:1.15;-webkit-text-size-adjust:100%}body{margin:0}main{display:block}h1{font-size:2em;margin:.67em 0}hr{box-sizing:content-box;height:0;overflow:visible}pre{font-family:monospace,monospace;font-size:1em}a{background-color:transparent}abbr[title]{border-bottom:none;text-decoration:underline;-webkit-text-decoration:underline dotted;text-decoration:underline dotted}b,strong{font-weight:bolder}code,kbd,samp{font-family:monospace,monospace;font-size:1em}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}img{border-style:none}button,input,optgroup,select,textarea{font-family:inherit;font-size:100%;line-height:1.15;margin:0}button,input{overflow:visible}button,select{text-transform:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}[type=button]::-moz-focus-inner,[type=reset]::-moz-focus-inner,[type=submit]::-moz-focus-inner,button::-moz-focus-inner{border-style:none;padding:0}[type=button]:-moz-focusring,[type=reset]:-moz-focusring,[type=submit]:-moz-focusring,button:-moz-focusring{outline:1px dotted ButtonText}fieldset{padding:.35em .75em .625em}legend{box-sizing:border-box;color:inherit;display:table;max-width:100%;padding:0;white-space:normal}progress{vertical-align:baseline}textarea{overflow:auto}[type=checkbox],[type=radio]{box-sizing:border-box;padding:0}[type=number]::-webkit-inner-spin-button,[type=number]::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}[type=search]::-webkit-search-decoration{-webkit-appearance:none}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}details{display:block}summary{display:list-item}template{display:none}[hidden]{display:none}html{font-family:sans-serif}.hidden,[hidden]{display:none !important}.pure-img{max-width:100%;height:auto;display:block}</style><style type=text/css media=screen>/*!Pure v3.0.0
Copyright 2013 Yahoo!
Licensed under the BSD License.
https://github.com/pure-css/pure/blob/master/LICENSE*/.pure-menu{box-sizing:border-box}.pure-menu-fixed{position:fixed;left:0;top:0;z-index:3}.pure-menu-item,.pure-menu-list{position:relative}.pure-menu-list{list-style:none;margin:0;padding:0}.pure-menu-item{padding:0;margin:0;height:100%}.pure-menu-heading,.pure-menu-link{display:block;text-decoration:none;white-space:nowrap}.pure-menu-horizontal{width:100%;white-space:nowrap}.pure-menu-horizontal .pure-menu-list{display:inline-block}.pure-menu-horizontal .pure-menu-heading,.pure-menu-horizontal .pure-menu-item,.pure-menu-horizontal .pure-menu-separator{display:inline-block;vertical-align:middle}.pure-menu-item .pure-menu-item{display:block}.pure-menu-children{display:none;position:absolute;left:100%;top:0;margin:0;padding:0;z-index:3}.pure-menu-horizontal .pure-menu-children{left:0;top:auto;width:inherit}.pure-menu-active>.pure-menu-children,.pure-menu-allow-hover:hover>.pure-menu-children{display:block;position:absolute}.pure-menu-has-children>.pure-menu-link:after{padding-left:.5em;content:"\25B8";font-size:small}.pure-menu-horizontal .pure-menu-has-children>.pure-menu-link:after{content:"\25BE"}.pure-menu-scrollable{overflow-y:scroll;overflow-x:hidden}.pure-menu-scrollable .pure-menu-list{display:block}.pure-menu-horizontal.pure-menu-scrollable .pure-menu-list{display:inline-block}.pure-menu-horizontal.pure-menu-scrollable{white-space:nowrap;overflow-y:hidden;overflow-x:auto;padding:.5em 0}.pure-menu-horizontal .pure-menu-children .pure-menu-separator,.pure-menu-separator{background-color:#ccc;height:1px;margin:.3em 0}.pure-menu-horizontal .pure-menu-separator{width:1px;height:1.3em;margin:0 .3em}.pure-menu-horizontal .pure-menu-children .pure-menu-separator{display:block;width:auto}.pure-menu-heading{text-transform:uppercase;color:#565d64}.pure-menu-link{color:#777}.pure-menu-children{background-color:#fff}.pure-menu-heading,.pure-menu-link{padding:.5em 1em}.pure-menu-disabled{opacity:.5}.pure-menu-disabled .pure-menu-link:hover{background-color:transparent;cursor:default}.pure-menu-active>.pure-menu-link,.pure-menu-link:focus,.pure-menu-link:hover{background-color:#eee}.pure-menu-selected>.pure-menu-link,.pure-menu-selected>.pure-menu-link:visited{color:#000}</style><style type=text/css media=screen>/*!Pure v3.0.0
Copyright 2013 Yahoo!
Licensed under the BSD License.
https://github.com/pure-css/pure/blob/master/LICENSE*/.pure-g{display:flex;flex-flow:row wrap;align-content:flex-start}.pure-u{display:inline-block;vertical-align:top}.pure-u-1,.pure-u-1-1,.pure-u-1-12,.pure-u-1-2,.pure-u-1-24,.pure-u-1-3,.pure-u-1-4,.pure-u-1-5,.pure-u-1-6,.pure-u-1-8,.pure-u-10-24,.pure-u-11-12,.pure-u-11-24,.pure-u-12-24,.pure-u-13-24,.pure-u-14-24,.pure-u-15-24,.pure-u-16-24,.pure-u-17-24,.pure-u-18-24,.pure-u-19-24,.pure-u-2-24,.pure-u-2-3,.pure-u-2-5,.pure-u-20-24,.pure-u-21-24,.pure-u-22-24,.pure-u-23-24,.pure-u-24-24,.pure-u-3-24,.pure-u-3-4,.pure-u-3-5,.pure-u-3-8,.pure-u-4-24,.pure-u-4-5,.pure-u-5-12,.pure-u-5-24,.pure-u-5-5,.pure-u-5-6,.pure-u-5-8,.pure-u-6-24,.pure-u-7-12,.pure-u-7-24,.pure-u-7-8,.pure-u-8-24,.pure-u-9-24{display:inline-block;letter-spacing:normal;word-spacing:normal;vertical-align:top;text-rendering:auto}.pure-u-1-24{width:4.1667%}.pure-u-1-12,.pure-u-2-24{width:8.3333%}.pure-u-1-8,.pure-u-3-24{width:12.5%}.pure-u-1-6,.pure-u-4-24{width:16.6667%}.pure-u-1-5{width:20%}.pure-u-5-24{width:20.8333%}.pure-u-1-4,.pure-u-6-24{width:25%}.pure-u-7-24{width:29.1667%}.pure-u-1-3,.pure-u-8-24{width:33.3333%}.pure-u-3-8,.pure-u-9-24{width:37.5%}.pure-u-2-5{width:40%}.pure-u-10-24,.pure-u-5-12{width:41.6667%}.pure-u-11-24{width:45.8333%}.pure-u-1-2,.pure-u-12-24{width:50%}.pure-u-13-24{width:54.1667%}.pure-u-14-24,.pure-u-7-12{width:58.3333%}.pure-u-3-5{width:60%}.pure-u-15-24,.pure-u-5-8{width:62.5%}.pure-u-16-24,.pure-u-2-3{width:66.6667%}.pure-u-17-24{width:70.8333%}.pure-u-18-24,.pure-u-3-4{width:75%}.pure-u-19-24{width:79.1667%}.pure-u-4-5{width:80%}.pure-u-20-24,.pure-u-5-6{width:83.3333%}.pure-u-21-24,.pure-u-7-8{width:87.5%}.pure-u-11-12,.pure-u-22-24{width:91.6667%}.pure-u-23-24{width:95.8333%}.pure-u-1,.pure-u-1-1,.pure-u-24-24,.pure-u-5-5{width:100%}</style><style type=text/css media=screen>/*!Pure v3.0.0
Copyright 2013 Yahoo!
Licensed under the BSD License.
https://github.com/pure-css/pure/blob/master/LICENSE*/.pure-table{border-collapse:collapse;border-spacing:0;empty-cells:show;border:1px solid #cbcbcb}.pure-table caption{color:#000;font:italic 85%/1 arial,sans-serif;padding:1em 0;text-align:center}.pure-table td,.pure-table th{border-left:1px solid #cbcbcb;border-width:0 0 0 1px;font-size:inherit;margin:0;overflow:visible;padding:.5em 1em}.pure-table thead{background-color:#e0e0e0;color:#000;text-align:left;vertical-align:bottom}.pure-table td{background-color:transparent}.pure-table-odd td{background-color:#f2f2f2}.pure-table-striped tr:nth-child(2n-1) td{background-color:#f2f2f2}.pure-table-bordered td{border-bottom:1px solid #cbcbcb}.pure-table-bordered tbody>tr:last-child>td{border-bottom-width:0}.pure-table-horizontal td,.pure-table-horizontal th{border-width:0 0 1px;border-bottom:1px solid #cbcbcb}.pure-table-horizontal tbody>tr:last-child>td{border-bottom-width:0}</style><style type=text/css media=screen>/*!Pure v1.0.0
Copyright 2013 Yahoo!
Licensed under the BSD License.
https://github.com/yahoo/pure/blob/master/LICENSE.md*/@media screen and (min-width:35.5em){.pure-u-sm-1,.pure-u-sm-1-1,.pure-u-sm-1-12,.pure-u-sm-1-2,.pure-u-sm-1-24,.pure-u-sm-1-3,.pure-u-sm-1-4,.pure-u-sm-1-5,.pure-u-sm-1-6,.pure-u-sm-1-8,.pure-u-sm-10-24,.pure-u-sm-11-12,.pure-u-sm-11-24,.pure-u-sm-12-24,.pure-u-sm-13-24,.pure-u-sm-14-24,.pure-u-sm-15-24,.pure-u-sm-16-24,.pure-u-sm-17-24,.pure-u-sm-18-24,.pure-u-sm-19-24,.pure-u-sm-2-24,.pure-u-sm-2-3,.pure-u-sm-2-5,.pure-u-sm-20-24,.pure-u-sm-21-24,.pure-u-sm-22-24,.pure-u-sm-23-24,.pure-u-sm-24-24,.pure-u-sm-3-24,.pure-u-sm-3-4,.pure-u-sm-3-5,.pure-u-sm-3-8,.pure-u-sm-4-24,.pure-u-sm-4-5,.pure-u-sm-5-12,.pure-u-sm-5-24,.pure-u-sm-5-5,.pure-u-sm-5-6,.pure-u-sm-5-8,.pure-u-sm-6-24,.pure-u-sm-7-12,.pure-u-sm-7-24,.pure-u-sm-7-8,.pure-u-sm-8-24,.pure-u-sm-9-24{display:inline-block;zoom:1;letter-spacing:normal;word-spacing:normal;vertical-align:top;text-rendering:auto}.pure-u-sm-1-24{width:4.1667%}.pure-u-sm-1-12,.pure-u-sm-2-24{width:8.3333%}.pure-u-sm-1-8,.pure-u-sm-3-24{width:12.5%}.pure-u-sm-1-6,.pure-u-sm-4-24{width:16.6667%}.pure-u-sm-1-5{width:20%}.pure-u-sm-5-24{width:20.8333%}.pure-u-sm-1-4,.pure-u-sm-6-24{width:25%}.pure-u-sm-7-24{width:29.1667%}.pure-u-sm-1-3,.pure-u-sm-8-24{width:33.3333%}.pure-u-sm-3-8,.pure-u-sm-9-24{width:37.5%}.pure-u-sm-2-5{width:40%}.pure-u-sm-10-24,.pure-u-sm-5-12{width:41.6667%}.pure-u-sm-11-24{width:45.8333%}.pure-u-sm-1-2,.pure-u-sm-12-24{width:50%}.pure-u-sm-13-24{width:54.1667%}.pure-u-sm-14-24,.pure-u-sm-7-12{width:58.3333%}.pure-u-sm-3-5{width:60%}.pure-u-sm-15-24,.pure-u-sm-5-8{width:62.5%}.pure-u-sm-16-24,.pure-u-sm-2-3{width:66.6667%}.pure-u-sm-17-24{width:70.8333%}.pure-u-sm-18-24,.pure-u-sm-3-4{width:75%}.pure-u-sm-19-24{width:79.1667%}.pure-u-sm-4-5{width:80%}.pure-u-sm-20-24,.pure-u-sm-5-6{width:83.3333%}.pure-u-sm-21-24,.pure-u-sm-7-8{width:87.5%}.pure-u-sm-11-12,.pure-u-sm-22-24{width:91.6667%}.pure-u-sm-23-24{width:95.8333%}.pure-u-sm-1,.pure-u-sm-1-1,.pure-u-sm-24-24,.pure-u-sm-5-5{width:100%}}@media screen and (min-width:48em){.pure-u-md-1,.pure-u-md-1-1,.pure-u-md-1-12,.pure-u-md-1-2,.pure-u-md-1-24,.pure-u-md-1-3,.pure-u-md-1-4,.pure-u-md-1-5,.pure-u-md-1-6,.pure-u-md-1-8,.pure-u-md-10-24,.pure-u-md-11-12,.pure-u-md-11-24,.pure-u-md-12-24,.pure-u-md-13-24,.pure-u-md-14-24,.pure-u-md-15-24,.pure-u-md-16-24,.pure-u-md-17-24,.pure-u-md-18-24,.pure-u-md-19-24,.pure-u-md-2-24,.pure-u-md-2-3,.pure-u-md-2-5,.pure-u-md-20-24,.pure-u-md-21-24,.pure-u-md-22-24,.pure-u-md-23-24,.pure-u-md-24-24,.pure-u-md-3-24,.pure-u-md-3-4,.pure-u-md-3-5,.pure-u-md-3-8,.pure-u-md-4-24,.pure-u-md-4-5,.pure-u-md-5-12,.pure-u-md-5-24,.pure-u-md-5-5,.pure-u-md-5-6,.pure-u-md-5-8,.pure-u-md-6-24,.pure-u-md-7-12,.pure-u-md-7-24,.pure-u-md-7-8,.pure-u-md-8-24,.pure-u-md-9-24{display:inline-block;zoom:1;letter-spacing:normal;word-spacing:normal;vertical-align:top;text-rendering:auto}.pure-u-md-1-24{width:4.1667%}.pure-u-md-1-12,.pure-u-md-2-24{width:8.3333%}.pure-u-md-1-8,.pure-u-md-3-24{width:12.5%}.pure-u-md-1-6,.pure-u-md-4-24{width:16.6667%}.pure-u-md-1-5{width:20%}.pure-u-md-5-24{width:20.8333%}.pure-u-md-1-4,.pure-u-md-6-24{width:25%}.pure-u-md-7-24{width:29.1667%}.pure-u-md-1-3,.pure-u-md-8-24{width:33.3333%}.pure-u-md-3-8,.pure-u-md-9-24{width:37.5%}.pure-u-md-2-5{width:40%}.pure-u-md-10-24,.pure-u-md-5-12{width:41.6667%}.pure-u-md-11-24{width:45.8333%}.pure-u-md-1-2,.pure-u-md-12-24{width:50%}.pure-u-md-13-24{width:54.1667%}.pure-u-md-14-24,.pure-u-md-7-12{width:58.3333%}.pure-u-md-3-5{width:60%}.pure-u-md-15-24,.pure-u-md-5-8{width:62.5%}.pure-u-md-16-24,.pure-u-md-2-3{width:66.6667%}.pure-u-md-17-24{width:70.8333%}.pure-u-md-18-24,.pure-u-md-3-4{width:75%}.pure-u-md-19-24{width:79.1667%}.pure-u-md-4-5{width:80%}.pure-u-md-20-24,.pure-u-md-5-6{width:83.3333%}.pure-u-md-21-24,.pure-u-md-7-8{width:87.5%}.pure-u-md-11-12,.pure-u-md-22-24{width:91.6667%}.pure-u-md-23-24{width:95.8333%}.pure-u-md-1,.pure-u-md-1-1,.pure-u-md-24-24,.pure-u-md-5-5{width:100%}}@media screen and (min-width:64em){.pure-u-lg-1,.pure-u-lg-1-1,.pure-u-lg-1-12,.pure-u-lg-1-2,.pure-u-lg-1-24,.pure-u-lg-1-3,.pure-u-lg-1-4,.pure-u-lg-1-5,.pure-u-lg-1-6,.pure-u-lg-1-8,.pure-u-lg-10-24,.pure-u-lg-11-12,.pure-u-lg-11-24,.pure-u-lg-12-24,.pure-u-lg-13-24,.pure-u-lg-14-24,.pure-u-lg-15-24,.pure-u-lg-16-24,.pure-u-lg-17-24,.pure-u-lg-18-24,.pure-u-lg-19-24,.pure-u-lg-2-24,.pure-u-lg-2-3,.pure-u-lg-2-5,.pure-u-lg-20-24,.pure-u-lg-21-24,.pure-u-lg-22-24,.pure-u-lg-23-24,.pure-u-lg-24-24,.pure-u-lg-3-24,.pure-u-lg-3-4,.pure-u-lg-3-5,.pure-u-lg-3-8,.pure-u-lg-4-24,.pure-u-lg-4-5,.pure-u-lg-5-12,.pure-u-lg-5-24,.pure-u-lg-5-5,.pure-u-lg-5-6,.pure-u-lg-5-8,.pure-u-lg-6-24,.pure-u-lg-7-12,.pure-u-lg-7-24,.pure-u-lg-7-8,.pure-u-lg-8-24,.pure-u-lg-9-24{display:inline-block;zoom:1;letter-spacing:normal;word-spacing:normal;vertical-align:top;text-rendering:auto}.pure-u-lg-1-24{width:4.1667%}.pure-u-lg-1-12,.pure-u-lg-2-24{width:8.3333%}.pure-u-lg-1-8,.pure-u-lg-3-24{width:12.5%}.pure-u-lg-1-6,.pure-u-lg-4-24{width:16.6667%}.pure-u-lg-1-5{width:20%}.pure-u-lg-5-24{width:20.8333%}.pure-u-lg-1-4,.pure-u-lg-6-24{width:25%}.pure-u-lg-7-24{width:29.1667%}.pure-u-lg-1-3,.pure-u-lg-8-24{width:33.3333%}.pure-u-lg-3-8,.pure-u-lg-9-24{width:37.5%}.pure-u-lg-2-5{width:40%}.pure-u-lg-10-24,.pure-u-lg-5-12{width:41.6667%}.pure-u-lg-11-24{width:45.8333%}.pure-u-lg-1-2,.pure-u-lg-12-24{width:50%}.pure-u-lg-13-24{width:54.1667%}.pure-u-lg-14-24,.pure-u-lg-7-12{width:58.3333%}.pure-u-lg-3-5{width:60%}.pure-u-lg-15-24,.pure-u-lg-5-8{width:62.5%}.pure-u-lg-16-24,.pure-u-lg-2-3{width:66.6667%}.pure-u-lg-17-24{width:70.8333%}.pure-u-lg-18-24,.pure-u-lg-3-4{width:75%}.pure-u-lg-19-24{width:79.1667%}.pure-u-lg-4-5{width:80%}.pure-u-lg-20-24,.pure-u-lg-5-6{width:83.3333%}.pure-u-lg-21-24,.pure-u-lg-7-8{width:87.5%}.pure-u-lg-11-12,.pure-u-lg-22-24{width:91.6667%}.pure-u-lg-23-24{width:95.8333%}.pure-u-lg-1,.pure-u-lg-1-1,.pure-u-lg-24-24,.pure-u-lg-5-5{width:100%}}@media screen and (min-width:80em){.pure-u-xl-1,.pure-u-xl-1-1,.pure-u-xl-1-12,.pure-u-xl-1-2,.pure-u-xl-1-24,.pure-u-xl-1-3,.pure-u-xl-1-4,.pure-u-xl-1-5,.pure-u-xl-1-6,.pure-u-xl-1-8,.pure-u-xl-10-24,.pure-u-xl-11-12,.pure-u-xl-11-24,.pure-u-xl-12-24,.pure-u-xl-13-24,.pure-u-xl-14-24,.pure-u-xl-15-24,.pure-u-xl-16-24,.pure-u-xl-17-24,.pure-u-xl-18-24,.pure-u-xl-19-24,.pure-u-xl-2-24,.pure-u-xl-2-3,.pure-u-xl-2-5,.pure-u-xl-20-24,.pure-u-xl-21-24,.pure-u-xl-22-24,.pure-u-xl-23-24,.pure-u-xl-24-24,.pure-u-xl-3-24,.pure-u-xl-3-4,.pure-u-xl-3-5,.pure-u-xl-3-8,.pure-u-xl-4-24,.pure-u-xl-4-5,.pure-u-xl-5-12,.pure-u-xl-5-24,.pure-u-xl-5-5,.pure-u-xl-5-6,.pure-u-xl-5-8,.pure-u-xl-6-24,.pure-u-xl-7-12,.pure-u-xl-7-24,.pure-u-xl-7-8,.pure-u-xl-8-24,.pure-u-xl-9-24{display:inline-block;zoom:1;letter-spacing:normal;word-spacing:normal;vertical-align:top;text-rendering:auto}.pure-u-xl-1-24{width:4.1667%}.pure-u-xl-1-12,.pure-u-xl-2-24{width:8.3333%}.pure-u-xl-1-8,.pure-u-xl-3-24{width:12.5%}.pure-u-xl-1-6,.pure-u-xl-4-24{width:16.6667%}.pure-u-xl-1-5{width:20%}.pure-u-xl-5-24{width:20.8333%}.pure-u-xl-1-4,.pure-u-xl-6-24{width:25%}.pure-u-xl-7-24{width:29.1667%}.pure-u-xl-1-3,.pure-u-xl-8-24{width:33.3333%}.pure-u-xl-3-8,.pure-u-xl-9-24{width:37.5%}.pure-u-xl-2-5{width:40%}.pure-u-xl-10-24,.pure-u-xl-5-12{width:41.6667%}.pure-u-xl-11-24{width:45.8333%}.pure-u-xl-1-2,.pure-u-xl-12-24{width:50%}.pure-u-xl-13-24{width:54.1667%}.pure-u-xl-14-24,.pure-u-xl-7-12{width:58.3333%}.pure-u-xl-3-5{width:60%}.pure-u-xl-15-24,.pure-u-xl-5-8{width:62.5%}.pure-u-xl-16-24,.pure-u-xl-2-3{width:66.6667%}.pure-u-xl-17-24{width:70.8333%}.pure-u-xl-18-24,.pure-u-xl-3-4{width:75%}.pure-u-xl-19-24{width:79.1667%}.pure-u-xl-4-5{width:80%}.pure-u-xl-20-24,.pure-u-xl-5-6{width:83.3333%}.pure-u-xl-21-24,.pure-u-xl-7-8{width:87.5%}.pure-u-xl-11-12,.pure-u-xl-22-24{width:91.6667%}.pure-u-xl-23-24{width:95.8333%}.pure-u-xl-1,.pure-u-xl-1-1,.pure-u-xl-24-24,.pure-u-xl-5-5{width:100%}}</style><style type=text/css media=screen>:root{--color:#484848;--color-footnote:#575757;--color-footer-content:#bbb;--background-color:rgb(252, 252, 252);--background-color-code:rgb(240, 240, 240);--background-color-toggle-content:rgb(249, 249, 249);--link-color:#c05b4d;--link-color-hover:#a5473a;--list-link-color:#336699;--border-navbar-and-footer:#e3e3e3}</style><style type=text/css media=screen>html{min-height:100%;width:100%;position:relative}body{background-color:#fcfcfc;background-color:var(--background-color);color:#484848;color:var(--color)}a{text-decoration:none}kbd,pre,code,samp{background-color:#f0f0f0;background-color:var(--background-color-code)}.nav-menu{margin-top:5px;padding-bottom:5px;border-bottom-width:1px;border-bottom-style:solid;border-bottom-color:#e3e3e3;border-bottom-color:var(--border-navbar-and-footer)}.pure-menu-heading{text-transform:none;font-size:large}.pure-menu-link:hover{background-color:unset}.header{text-align:left;color:#484848;color:var(--color);margin-bottom:.5em}.header ul li{height:auto}.header ul li a{font-weight:700;color:#484848;color:var(--color);font-family:source sans pro,helveticaneue,helvetica neue,Helvetica,Arial,sans-serif}.header{font-weight:700;color:#484848;color:var(--color);font-family:source sans pro,helveticaneue,helvetica neue,Helvetica,Arial,sans-serif}.site-title{color:#484848;color:var(--color);text-transform:none;font-weight:400;font-family:source sans pro,helveticaneue,helvetica neue,Helvetica,Arial,sans-serif}.pull-right{float:right}.posts-name{text-transform:capitalize;font-weight:700;padding-left:1em;margin-top:1em;font-family:source sans pro,helveticaneue,helvetica neue,Helvetica,Arial,sans-serif}.posts{font-family:verdana,arial,helvetica,sans-serif;list-style-type:none;padding-left:1em}.posts li p{margin-top:0}.posts li{margin-bottom:1em}.posts li>a{color:#369;color:var(--list-link-color);text-decoration:none}.post-list{font-size:large}.footnote{font-family:verdana,arial,helvetica,sans-serif;color:#575757;color:var(--color-footnote);font-size:.75em;margin-bottom:0}.footnote a{color:#575757;color:var(--color-footnote)}.footnote a:hover{text-decoration:underline;color:#369;color:var(--list-link-color)}.footer{position:absolute;z-index:2;height:auto;width:100%;bottom:0}.footer-content{border-top-width:1px;border-top-style:solid;border-top-color:#e3e3e3;border-top:1px solid var(--border-navbar-and-footer);font-size:80%;color:#bbb;color:var(--color-footer-content)}.footer-content a{color:#575757;color:var(--color-footnote)}.footer-content ul{height:auto;margin-top:0;margin-bottom:0;display:inline-block;padding-left:0}#TableOfContents>ul{list-style:none;margin:0;padding:0}#gototop-btn{display:inline-block}#foot-name{color:#484848;color:var(--color);text-transform:none}#foot-copyright{padding-left:1em;padding-bottom:.5em;margin:0}.post{font-family:proxima-nova,helvetica neue,Helvetica,Roboto,Arial,sans-serif;color:#484848;color:var(--color);letter-spacing:normal;padding-left:.5em}.post h1,h2,h3,h4,h5,h6{font-weight:700;letter-spacing:normal}.post-content{z-index:9;overflow:auto;padding:0;padding-bottom:3em;font-size:16px;line-height:1.4}.post-content img{max-width:100%;height:auto}.post-content pre{padding:.5em}.post a{color:#c05b4d;color:var(--link-color);text-decoration:none}.post a:hover{color:#a5473a;color:var(--link-color-hover);text-decoration:underline}.post h1{font-size:28px}.post h2{font-size:25px}.post h3{font-size:23px}.post h4{font-size:21px}.post h5{font-size:19px}.post h6{font-size:18px}.post-title{margin-top:0;margin-bottom:1em}.post-title h1{font-weight:700;font-size:39px;line-height:40px;margin-top:0;margin-bottom:0}@media screen and (max-width:768px){.desktop{display:none}.mobile{display:block}#toggle-btn{display:inline-block;float:right;padding:.5em 1em;text-decoration:none;color:#484848;color:var(--color);font-weight:700}#toggle-content li{clear:both;height:auto;background-color:#f9f9f9;background-color:var(--background-color-toggle-content)}#toggle-home{display:inline-block}}@media screen and (min-width:769px){.mobile{display:none}.desktop{display:block}}</style><link rel="shortcut icon" href=/img/favicon.ico type=image/x-icon></head><body><div class="header pure-g"><div class="pure-u-1-24 pure-u-md-2-24 pure-u-lg-5-24"></div><div class="pure-u-11-12 pure-u-md-20-24 pure-u-lg-7-12"><div class="desktop pure-menu pure-menu-horizontal nav-menu"><a href=/ class="site-title pure-menu-heading">随记</a><ul class="pure-menu-list pull-right"><li class=pure-menu-item><a href=/categories/development/ class=pure-menu-link>Development</a></li><li class=pure-menu-item><a href=/categories/os/ class=pure-menu-link>OS</a></li><li class=pure-menu-item><a href=/categories/reading/ class=pure-menu-link>Reading</a></li><li class=pure-menu-item><a href=/about/ class=pure-menu-link>About</a></li></ul></div><div class="mobile pure-menu nav-menu"><a href=/ class="site-title pure-menu-heading" id=toggle-home>随记</a>
<a href=# id=toggle-btn>&#9776;</a><ul class=pure-menu-list id=toggle-content style=display:none><li class=pure-menu-item><a href=/categories/development/ class=pure-menu-link>Development</a></li><li class=pure-menu-item><a href=/categories/os/ class=pure-menu-link>OS</a></li><li class=pure-menu-item><a href=/categories/reading/ class=pure-menu-link>Reading</a></li><li class=pure-menu-item><a href=/about class=pure-menu-link>About</a></li></ul></div></div><div class="pure-u-1-24 pure-u-md-2-24 pure-u-lg-5-24"></div></div><div class=pure-g><div class="pure-u-1-24 pure-u-md-2-24 pure-u-lg-5-24"></div><div class="pure-u-11-12 pure-u-md-20-24 pure-u-lg-7-12"><div class=post><div class=post-title><p class=footnote><time datetime="2020-12-24 21:28:08 +0800 CST">2020-12-24
</time>|
tags: [ <a href=/tags/ldap>LDAP</a> <a href=/tags/sso>SSO</a> ]
categories: [ <a href=/categories/os>OS</a> ]</p><h1>如何禁用 LDAP 中的用户？</h1></div><div class=post-content><nav id=TableOfContents><ul><li><a href=#背景>背景</a></li><li><a href=#方案>方案</a></li><li><a href=#操作>操作</a></li><li><a href=#效果>效果</a></li></ul></nav><h2 id=背景>背景</h2><p>使用 Atlassian 全家桶比如 Confluence、JIRA 的话，常用它家自带的单点登录方案 <a href=https://www.atlassian.com/software/crowd>Atlassian Crowd</a>，但 Crowd 的认证协议不是标准的，<del>其 <a href=https://jira.atlassian.com/browse/CWD-3995>OpenID Connect 支持</a> 和 <a href="https://marketplace.atlassian.com/apps/1216096/sso-for-atlassian-server-and-data-center?hosting=server&amp;tab=overview">SAML 支持</a>需要 Data Center license，比较贵</del>（其实只是作为 OIDC/SAML client，并不是作为 provider)。Redhat 家的 Keycloak 支持标准的 SAML 和 OpenID Connect 认证协议，而且 Crowd 和 Keycloak 都支持以 LDAP 目录服务来存储用户、用户组信息，这样我们可以把用户、组迁移到 LDAP 服务里，Crowd 和 Keycloak 并行运行逐步过渡，而 LDAP 认证也被许多 Unix/Linux 传统服务支持，整个方案完美！</p><p>但是一丢丢不足的是，Crowd 和 Keycloak 都支持禁用用户，这个禁用状态保存在 Crowd 和 Keycloak 自己的数据库里，这时直接通过 LDAP 做绑定认证依然是可以认证成功的，于是研究了下如何在 LDAP 里禁用用户，然后发现居然没有一个所有 LDAP 服务、客户端都遵守的标准做法！</p><h2 id=方案>方案</h2><p>(1) 在 Active Directory 的 schema 里，User 类 的 <a href=https://docs.microsoft.com/en-us/windows/win32/adschema/a-useraccountcontrol>UserAccountControl</a> 属性是位域类型(bit fields)，可以表达用户是否被禁止。</p><p>(2) 在 Active Directory Lightweight Directory Services(AD LDS) 的 schema 里，msDS-BindableObject 类的 <a href=https://docs.microsoft.com/en-us/windows/win32/adschema/a-msds-useraccountdisabled>msDS-UserAccountDisabled</a> 属性是布尔类型，可以表达用户是否被禁止。</p><p>(3) <a href=https://github.com/PADL/nss_ldap>libnss-ldap</a> 和 <a href=https://github.com/arthurdejong/nss-pam-ldapd>libnss-ldapd</a> 在 LDAP 里使用 <a href=https://ldapwiki.com/wiki/ShadowAccount>ShadowAccount</a> 类保存 /etc/shadow 里的信息，这个类的 shadowExpire 属性是日期类型，可以表达用户是否被禁止。<code>usermod --expiredate</code> 命令就是修改这个属性。ActiveDirectory 不支持。</p><p>(4) 使用 <a href=https://ldapwiki.com/wiki/PwdPolicy>pwdPolicy</a> 类来禁用用户。</p><p>LDAP server 对四种方案的支持情况：上面前两种是微软家专用（<a href=https://www.tecmint.com/install-samba4-active-directory-ubuntu/>Samba</a> 支持第一种)，第三种微软家不支持，第四种大家都支持。</p><p>Crowd 和 Keycloak 支持前两种，其中 Crowd 在使用 AD LDS 时<a href=https://jira.atlassian.com/browse/CWD-5572>不能打开增量同步</a>。 由于 Crowd 和 Keycloak 只是用了 AD 的纯 LDAP 部分功能，所以我们可以用其它 LDAP 服务器比如 Apache Directory Server 来假冒 AD：创建一个 schema，包含上面用到的 AD 属性（其实还有几个其它属性）以及对应的 object class，让 LDAP 里的用户信息额外使用这个 object class，于是就具备了所需的属性了。</p><h2 id=操作>操作</h2><p>于是开始令人窒息的「假冒伪劣」操作，Keycloak 开源源码，很容易找到对应的属性，Crowd 理论上也能反编译其 jar 包找到使用了哪些属性。</p><p><a href=https://github.com/keycloak/keycloak/blob/12.0.1/federation/ldap/src/main/java/org/keycloak/storage/ldap/mappers/msad/MSADUserAccountControlStorageMapper.java>https://github.com/keycloak/keycloak/blob/12.0.1/federation/ldap/src/main/java/org/keycloak/storage/ldap/mappers/msad/MSADUserAccountControlStorageMapper.java</a></p><p><a href=https://github.com/keycloak/keycloak/blob/12.0.1/federation/ldap/src/main/java/org/keycloak/storage/ldap/mappers/msadlds/MSADLDSUserAccountControlStorageMapper.java>https://github.com/keycloak/keycloak/blob/12.0.1/federation/ldap/src/main/java/org/keycloak/storage/ldap/mappers/msadlds/MSADLDSUserAccountControlStorageMapper.java</a></p><p>从源码里可以很容易发现除了 UserAccountControl 和 msDS-UserAccountDisabled 属性外，还必需 <a href=https://docs.microsoft.com/en-us/windows/win32/adschema/a-pwdlastset>pwdLastSet</a> 属性。根据微软的文档，约莫可以猜出这些 attribute type 和 object class 的定义。 这里多解释一下 LDAP 的 schema，在 LDAP schema 里最重要的成员就是 object class 和 attribute type，相当于 SQL table 和 SQL column，不同的是 LDAP schema 里 attribute type 是单独定义的，可以被多个 object class 共享，LDAP 里的目录节点（相当于 SQL row）可以使用多个 object class，而且 attribute type 之间、object class 之间支持继承，这些设计比 SQL 强大的多，但也注定了曲高和寡。跟 SQL column 有 data type 类似，LDAP attribute type 的类型称为 syntax，有整数、字符串等。</p><p>Attribute type 还有一些其它重要属性：</p><ul><li>Usage，包含 User Applications 和 Directory Operation，前者指正常属性，后者指此属性是目录服务器内部维护的状态。</li><li>Single-value，表示此属性是否允许多个值。</li><li>Matching rules，有点类似 SQL 里的 collation，表示比较、排序规则。</li></ul><p>object class 有个重要属性:</p><ul><li>Class type: Abstract - 抽象类, Structural - 具体类, Auxiliary - 辅助类，类似编程语言里的 mixin。如果给 LDAP 用的 user 使用了两个没有继承关系的 Structural object class，那么 Keycloak 在往 LDAP 里创建 user 节点时会报错 &ldquo;contains more than one STRUCTURAL ObjectClass&rdquo;，此时可以使用辅助类，或者继承用到的最新子类，比如 inetOrgPerson。</li><li>Superior Classes: 指定父类。</li></ul><p>然后开始正事了，首先下载一份 Apache DS 2.0，使用 <code>bin/apacheds.sh start</code> 启动，在下载一份 Apache Directory Studio，启动后创建 connection，认证的用户是 &ldquo;uid=admin,ou=system&rdquo;，默认密码是 &ldquo;secret&rdquo;。注意在查看 LDAP 中存储的节点数据时，有时候需要右键菜单里选择 &ldquo;Reload Entry&rdquo; 才会展开，比如在查看 &ldquo;ou=schema&rdquo; 下的 schema 定义时。</p><p>然后在 Apache Directory Studio 里通过菜单 Window -> Open Perspective -> Schema Editor (也可以点击工具栏最右边按钮) 切换到 Schema Editor 视图，在这个视图下新建 schema project，选择类型 &ldquo;Online schema from a Directory Server&rdquo;，然后新建 schema，然后在这个 schema 里新建 attribute type，再新建 object class 使用这些 attribute type，完成后选择这个 schema 导出成 LDIF:</p><pre tabindex=0><code># SCHEMA &#34;MSADLDS-SCHEMA&#34;
dn: cn=msadlds-schema, ou=schema
objectclass: metaSchema
objectclass: top
cn: msadlds-schema
m-dependencies: inetorgperson

dn: ou=attributetypes, cn=msadlds-schema, ou=schema
objectclass: organizationalUnit
objectclass: top
ou: attributetypes

dn: m-oid=1.2.840.113556.1.4.1853, ou=attributetypes, cn=msadlds-schema, ou=sche
 ma
objectclass: metaAttributeType
objectclass: metaTop
objectclass: top
m-oid: 1.2.840.113556.1.4.1853
m-name: msDS-UserAccountDisabled
m-name: ms-DS-User-Account-Disabled
m-description: https://docs.microsoft.com/en-us/windows/win32/adschema/a-msds-us
 eraccountdisabled
m-equality: booleanMatch
m-syntax: 1.3.6.1.4.1.1466.115.121.1.7
m-singleValue: TRUE

dn: m-oid=1.2.840.113556.1.4.96, ou=attributetypes, cn=msadlds-schema, ou=schema
objectclass: metaAttributeType
objectclass: metaTop
objectclass: top
m-oid: 1.2.840.113556.1.4.96
m-name: pwdLastSet
m-name: Pwd-Last-Set
m-description: https://docs.microsoft.com/en-us/windows/win32/adschema/a-pwdlast
 set
m-equality: integerMatch
m-ordering: integerOrderingMatch
m-syntax: 1.3.6.1.4.1.1466.115.121.1.27
m-singleValue: TRUE

dn: m-oid=1.2.840.113556.1.4.8, ou=attributetypes, cn=msadlds-schema, ou=schema
objectclass: metaAttributeType
objectclass: metaTop
objectclass: top
m-oid: 1.2.840.113556.1.4.8
m-name: userAccountControl
m-name: User-Account-Control
m-description: https://docs.microsoft.com/en-us/windows/win32/adschema/a-useracc
 ountcontrol
m-equality: integerMatch
m-ordering: integerOrderingMatch
m-syntax: 1.3.6.1.4.1.1466.115.121.1.27
m-singleValue: TRUE

dn: ou=comparators, cn=msadlds-schema, ou=schema
objectclass: organizationalUnit
objectclass: top
ou: comparators

dn: ou=ditcontentrules, cn=msadlds-schema, ou=schema
objectclass: organizationalUnit
objectclass: top
ou: ditcontentrules

dn: ou=ditstructurerules, cn=msadlds-schema, ou=schema
objectclass: organizationalUnit
objectclass: top
ou: ditstructurerules

dn: ou=matchingrules, cn=msadlds-schema, ou=schema
objectclass: organizationalUnit
objectclass: top
ou: matchingrules

dn: ou=matchingruleuse, cn=msadlds-schema, ou=schema
objectclass: organizationalUnit
objectclass: top
ou: matchingruleuse

dn: ou=nameforms, cn=msadlds-schema, ou=schema
objectclass: organizationalUnit
objectclass: top
ou: nameforms

dn: ou=normalizers, cn=msadlds-schema, ou=schema
objectclass: organizationalUnit
objectclass: top
ou: normalizers

dn: ou=objectclasses, cn=msadlds-schema, ou=schema
objectclass: organizationalUnit
objectclass: top
ou: objectClasses

dn: m-oid=1.2.840.113556.1.5.244, ou=objectclasses, cn=msadlds-schema, ou=schema
objectclass: metaObjectClass
objectclass: metaTop
objectclass: top
m-oid: 1.2.840.113556.1.5.244
m-name: msDS-BindableObject
m-name: ms-DS-Bindable-Object
m-description: https://docs.microsoft.com/en-us/windows/win32/adschema/c-msds-bi
 ndableobject
m-typeObjectClass: AUXILIARY
m-may: msDS-UserAccountDisabled
m-may: pwdLastSet

dn: m-oid=1.2.840.113556.1.5.9, ou=objectclasses, cn=msadlds-schema, ou=schema
objectclass: metaObjectClass
objectclass: metaTop
objectclass: top
m-oid: 1.2.840.113556.1.5.9
m-name: user
m-name: User
m-description: https://docs.microsoft.com/en-us/windows/win32/adschema/c-user
m-supObjectClass: inetOrgPerson
m-may: userAccountControl
m-may: pwdLastSet

dn: ou=syntaxcheckers, cn=msadlds-schema, ou=schema
objectclass: organizationalUnit
objectclass: top
ou: syntaxcheckers

dn: ou=syntaxes, cn=msadlds-schema, ou=schema
objectclass: organizationalUnit
objectclass: top
ou: syntaxes
</code></pre><p>通过 Apache Directory Studio 菜单 Window -> Open Perspective -> LDAP 切换会 LDAP 视图，在 ou=schema 处导入 LDIF。</p><p>接下来在 Keycloak 的 admin web console 里创建 LDAP 类型的 User Federation。</p><ol><li>在 Settings 标签页的 LDAP Vendor 选择 &ldquo;Other&rdquo;，如果是假冒 AD 则在 User Object Classes 输入框添加 &ldquo;,user&rdquo;，如果是假冒 AD LDS 则添加 &ldquo;,msDS-BindableObject&rdquo;</li><li>在 Mappers 标签页，如果是假冒 AD 则创建 msad-user-acccount-control-mapper，如果是假冒 AD LDS 则创建 msad-lds-user-account-control-mapper。</li></ol><p>由于 Apache DS 不支持写入属性 pwdLastSet: -1 时自动替换成当前时间，所以需要给 Keycloak-12.0.1 打个补丁，把判断 <code>getPwdLastSet() > 0</code>的地方去掉：</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-diff data-lang=diff><span style=display:flex><span><span style=color:navy;font-weight:700>diff --git a/federation/ldap/src/main/java/org/keycloak/storage/ldap/mappers/msad/MSADUserAccountControlStorageMapper.java b/federation/ldap/src/main/java/org/keycloak/storage/ldap/mappers/msad/MSADUserAccountControlStorageMapper.java
</span></span></span><span style=display:flex><span><span style=color:navy;font-weight:700>index fbd5b52e6e..ed9411fbb7 100644
</span></span></span><span style=display:flex><span><span style=color:navy;font-weight:700></span><span style=color:#a00000>--- a/federation/ldap/src/main/java/org/keycloak/storage/ldap/mappers/msad/MSADUserAccountControlStorageMapper.java
</span></span></span><span style=display:flex><span><span style=color:#a00000></span><span style=color:#00a000>+++ b/federation/ldap/src/main/java/org/keycloak/storage/ldap/mappers/msad/MSADUserAccountControlStorageMapper.java
</span></span></span><span style=display:flex><span><span style=color:#00a000></span><span style=color:purple;font-weight:700>@@ -220 +220 @@ public class MSADUserAccountControlStorageMapper extends AbstractLDAPStorageMapp
</span></span></span><span style=display:flex><span><span style=color:purple;font-weight:700></span><span style=color:#a00000>-            if (getPwdLastSet() &gt; 0) {
</span></span></span><span style=display:flex><span><span style=color:#a00000></span><span style=color:#00a000>+            //if (getPwdLastSet() &gt; 0) {
</span></span></span><span style=display:flex><span><span style=color:#00a000></span><span style=color:purple;font-weight:700>@@ -223,4 +223,4 @@ public class MSADUserAccountControlStorageMapper extends AbstractLDAPStorageMapp
</span></span></span><span style=display:flex><span><span style=color:purple;font-weight:700></span><span style=color:#a00000>-            } else {
</span></span></span><span style=display:flex><span><span style=color:#a00000>-                // If new MSAD user is created and pwdLastSet is still 0, MSAD account is in disabled state. So read just from Keycloak DB. User is not able to login via MSAD anyway
</span></span></span><span style=display:flex><span><span style=color:#a00000>-                return kcEnabled;
</span></span></span><span style=display:flex><span><span style=color:#a00000>-            }
</span></span></span><span style=display:flex><span><span style=color:#a00000></span><span style=color:#00a000>+            //} else {
</span></span></span><span style=display:flex><span><span style=color:#00a000>+            //    // If new MSAD user is created and pwdLastSet is still 0, MSAD account is in disabled state. So read just from Keycloak DB. User is not able to login via MSAD anyway
</span></span></span><span style=display:flex><span><span style=color:#00a000>+            //    return kcEnabled;
</span></span></span><span style=display:flex><span><span style=color:#00a000>+            //}
</span></span></span><span style=display:flex><span><span style=color:#00a000></span><span style=color:purple;font-weight:700>@@ -234 +234 @@ public class MSADUserAccountControlStorageMapper extends AbstractLDAPStorageMapp
</span></span></span><span style=display:flex><span><span style=color:purple;font-weight:700></span><span style=color:#a00000>-            if (ldapProvider.getEditMode() == UserStorageProvider.EditMode.WRITABLE &amp;&amp; getPwdLastSet() &gt; 0) {
</span></span></span><span style=display:flex><span><span style=color:#a00000></span><span style=color:#00a000>+            if (ldapProvider.getEditMode() == UserStorageProvider.EditMode.WRITABLE /*&amp;&amp; getPwdLastSet() &gt; 0*/) {
</span></span></span><span style=display:flex><span><span style=color:#00a000></span><span style=color:navy;font-weight:700>diff --git a/federation/ldap/src/main/java/org/keycloak/storage/ldap/mappers/msadlds/MSADLDSUserAccountControlStorageMapper.java b/federation/ldap/src/main/java/org/keycloak/storage/ldap/mappers/msadlds/MSADLDSUserAccountControlStorageMapper.java
</span></span></span><span style=display:flex><span><span style=color:navy;font-weight:700>index 38c5b728f1..0f55c11935 100644
</span></span></span><span style=display:flex><span><span style=color:navy;font-weight:700></span><span style=color:#a00000>--- a/federation/ldap/src/main/java/org/keycloak/storage/ldap/mappers/msadlds/MSADLDSUserAccountControlStorageMapper.java
</span></span></span><span style=display:flex><span><span style=color:#a00000></span><span style=color:#00a000>+++ b/federation/ldap/src/main/java/org/keycloak/storage/ldap/mappers/msadlds/MSADLDSUserAccountControlStorageMapper.java
</span></span></span><span style=display:flex><span><span style=color:#00a000></span><span style=color:purple;font-weight:700>@@ -183 +183 @@ public class MSADLDSUserAccountControlStorageMapper extends AbstractLDAPStorageM
</span></span></span><span style=display:flex><span><span style=color:purple;font-weight:700></span><span style=color:#a00000>-            if (getPwdLastSet() &gt; 0) {
</span></span></span><span style=display:flex><span><span style=color:#a00000></span><span style=color:#00a000>+            //if (getPwdLastSet() &gt; 0) {
</span></span></span><span style=display:flex><span><span style=color:#00a000></span><span style=color:purple;font-weight:700>@@ -186,4 +186,4 @@ public class MSADLDSUserAccountControlStorageMapper extends AbstractLDAPStorageM
</span></span></span><span style=display:flex><span><span style=color:purple;font-weight:700></span><span style=color:#a00000>-            } else {
</span></span></span><span style=display:flex><span><span style=color:#a00000>-                // If new MSAD LDS user is created and pwdLastSet is still 0, MSAD account is in disabled state. So read just from Keycloak DB. User is not able to login via MSAD anyway
</span></span></span><span style=display:flex><span><span style=color:#a00000>-                return kcEnabled;
</span></span></span><span style=display:flex><span><span style=color:#a00000>-            }
</span></span></span><span style=display:flex><span><span style=color:#a00000></span><span style=color:#00a000>+            //} else {
</span></span></span><span style=display:flex><span><span style=color:#00a000>+            //    // If new MSAD LDS user is created and pwdLastSet is still 0, MSAD account is in disabled state. So read just from Keycloak DB. User is not able to login via MSAD anyway
</span></span></span><span style=display:flex><span><span style=color:#00a000>+            //    return kcEnabled;
</span></span></span><span style=display:flex><span><span style=color:#00a000>+            //}
</span></span></span><span style=display:flex><span><span style=color:#00a000></span><span style=color:purple;font-weight:700>@@ -197 +197 @@ public class MSADLDSUserAccountControlStorageMapper extends AbstractLDAPStorageM
</span></span></span><span style=display:flex><span><span style=color:purple;font-weight:700></span><span style=color:#a00000>-            if (ldapProvider.getEditMode() == UserStorageProvider.EditMode.WRITABLE &amp;&amp; getPwdLastSet() &gt; 0) {
</span></span></span><span style=display:flex><span><span style=color:#a00000></span><span style=color:#00a000>+            if (ldapProvider.getEditMode() == UserStorageProvider.EditMode.WRITABLE /*&amp;&amp; getPwdLastSet() &gt; 0*/) {
</span></span></span></code></pre></div><p>在 keycloak/federation/ldap 下执行 <code>mvn clean package</code> ，然后把 target/keycloak-ldap-federation-12.0.1.jar 替换掉官方下载的二进制包里的 keycloak-12.0.1/modules/system/layers/keycloak/org/keycloak/keycloak-ldap-federation/main/keycloak-ldap-federation-12.0.1.jar。</p><h2 id=效果>效果</h2><p>这么 hack 一下的结果是：</p><ol><li><p>LDAP -> Keycloak 同步 enabled 标志：如果在 LDAP 里把 msDS-UserAccountDisabled 设置成 <code>TRUE</code>（假冒 AD LDS) 或者把 userAccountControl 设置成 <code>userAccountControl | 2</code>(可以简化设置成 2，假冒 AD)，则 Keycloak 里此用户被禁用；如果设置成 <code>FALSE</code> 或者 <code>userAccountControl & ~2</code>(可以简化设置成 0)，并且在 Keycloak 里也 enable 一下此用户（上面补丁里可以看到 Keycloak 判断了两个开关），则用户解禁。</p></li><li><p>Keycloak -> LDAP 同步 enabled 标志：Keycloak 里解禁、禁用用户，会立刻反映到 LDAP 里。</p></li></ol></div></div></div><div class="pure-u-1-24 pure-u-md-2-24 pure-u-lg-5-24"></div></div><div class="footer pure-g"><div class="pure-u-1-24 pure-u-md-2-24 pure-u-lg-5-24"></div><div class="pure-u-11-12 pure-u-md-20-24 pure-u-lg-7-12"><div class=footer-content><div class="pure-menu pure-menu-horizontal"><ul><li class=pure-menu-item id=foot-name>© Yubao Liu</li></ul><a href=# class="pure-menu-link pull-right" id=gototop-btn>↑↑</a></div></div></div><div class="pure-u-1-24 pure-u-md-2-24 pure-u-lg-5-24"></div></div><script type=text/javascript>go(),window.addEventListener("resize",go);function go(){var e=document.querySelector(".desktop");document.documentElement.clientWidth>768?e.style.display="":e.style.display="none"}</script><script type=text/javascript>var a=document.querySelector("#toggle-btn"),b=document.querySelector("#toggle-content");a.addEventListener("click",function(){""==b.style.display?(b.style.display="none",a.innerHTML="☰"):(b.style.display="",a.innerHTML="X")})</script></body></html>