<!doctype html><html lang=en><head><meta charset=utf-8><title>《The Rust Programming Language》笔记</title><meta name=description content="《The Rust Programming Language》笔记"><meta name=author content="Yubao Liu"><meta name=viewport content="width=device-width,initial-scale=1"><noscript><link href="//fonts.googleapis.com/css?family=Source+Sans+Pro:400,600" rel=stylesheet type=text/css><link rel=stylesheet href=/css/fonts.css></noscript><style type=text/css media=screen>/*!Pure v3.0.0
Copyright 2013 Yahoo!
Licensed under the BSD License.
https://github.com/pure-css/pure/blob/master/LICENSE*//*!normalize.css v | MIT License | https://necolas.github.io/normalize.css/
Copyright (c) Nicolas Gallagher and Jonathan Neal*//*!normalize.css v8.0.1 | MIT License | github.com/necolas/normalize.css*/html{line-height:1.15;-webkit-text-size-adjust:100%}body{margin:0}main{display:block}h1{font-size:2em;margin:.67em 0}hr{box-sizing:content-box;height:0;overflow:visible}pre{font-family:monospace,monospace;font-size:1em}a{background-color:transparent}abbr[title]{border-bottom:none;text-decoration:underline;-webkit-text-decoration:underline dotted;text-decoration:underline dotted}b,strong{font-weight:bolder}code,kbd,samp{font-family:monospace,monospace;font-size:1em}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}img{border-style:none}button,input,optgroup,select,textarea{font-family:inherit;font-size:100%;line-height:1.15;margin:0}button,input{overflow:visible}button,select{text-transform:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}[type=button]::-moz-focus-inner,[type=reset]::-moz-focus-inner,[type=submit]::-moz-focus-inner,button::-moz-focus-inner{border-style:none;padding:0}[type=button]:-moz-focusring,[type=reset]:-moz-focusring,[type=submit]:-moz-focusring,button:-moz-focusring{outline:1px dotted ButtonText}fieldset{padding:.35em .75em .625em}legend{box-sizing:border-box;color:inherit;display:table;max-width:100%;padding:0;white-space:normal}progress{vertical-align:baseline}textarea{overflow:auto}[type=checkbox],[type=radio]{box-sizing:border-box;padding:0}[type=number]::-webkit-inner-spin-button,[type=number]::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}[type=search]::-webkit-search-decoration{-webkit-appearance:none}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}details{display:block}summary{display:list-item}template{display:none}[hidden]{display:none}html{font-family:sans-serif}.hidden,[hidden]{display:none !important}.pure-img{max-width:100%;height:auto;display:block}</style><style type=text/css media=screen>/*!Pure v3.0.0
Copyright 2013 Yahoo!
Licensed under the BSD License.
https://github.com/pure-css/pure/blob/master/LICENSE*/.pure-menu{box-sizing:border-box}.pure-menu-fixed{position:fixed;left:0;top:0;z-index:3}.pure-menu-item,.pure-menu-list{position:relative}.pure-menu-list{list-style:none;margin:0;padding:0}.pure-menu-item{padding:0;margin:0;height:100%}.pure-menu-heading,.pure-menu-link{display:block;text-decoration:none;white-space:nowrap}.pure-menu-horizontal{width:100%;white-space:nowrap}.pure-menu-horizontal .pure-menu-list{display:inline-block}.pure-menu-horizontal .pure-menu-heading,.pure-menu-horizontal .pure-menu-item,.pure-menu-horizontal .pure-menu-separator{display:inline-block;vertical-align:middle}.pure-menu-item .pure-menu-item{display:block}.pure-menu-children{display:none;position:absolute;left:100%;top:0;margin:0;padding:0;z-index:3}.pure-menu-horizontal .pure-menu-children{left:0;top:auto;width:inherit}.pure-menu-active>.pure-menu-children,.pure-menu-allow-hover:hover>.pure-menu-children{display:block;position:absolute}.pure-menu-has-children>.pure-menu-link:after{padding-left:.5em;content:"\25B8";font-size:small}.pure-menu-horizontal .pure-menu-has-children>.pure-menu-link:after{content:"\25BE"}.pure-menu-scrollable{overflow-y:scroll;overflow-x:hidden}.pure-menu-scrollable .pure-menu-list{display:block}.pure-menu-horizontal.pure-menu-scrollable .pure-menu-list{display:inline-block}.pure-menu-horizontal.pure-menu-scrollable{white-space:nowrap;overflow-y:hidden;overflow-x:auto;padding:.5em 0}.pure-menu-horizontal .pure-menu-children .pure-menu-separator,.pure-menu-separator{background-color:#ccc;height:1px;margin:.3em 0}.pure-menu-horizontal .pure-menu-separator{width:1px;height:1.3em;margin:0 .3em}.pure-menu-horizontal .pure-menu-children .pure-menu-separator{display:block;width:auto}.pure-menu-heading{text-transform:uppercase;color:#565d64}.pure-menu-link{color:#777}.pure-menu-children{background-color:#fff}.pure-menu-heading,.pure-menu-link{padding:.5em 1em}.pure-menu-disabled{opacity:.5}.pure-menu-disabled .pure-menu-link:hover{background-color:transparent;cursor:default}.pure-menu-active>.pure-menu-link,.pure-menu-link:focus,.pure-menu-link:hover{background-color:#eee}.pure-menu-selected>.pure-menu-link,.pure-menu-selected>.pure-menu-link:visited{color:#000}</style><style type=text/css media=screen>/*!Pure v3.0.0
Copyright 2013 Yahoo!
Licensed under the BSD License.
https://github.com/pure-css/pure/blob/master/LICENSE*/.pure-g{display:flex;flex-flow:row wrap;align-content:flex-start}.pure-u{display:inline-block;vertical-align:top}.pure-u-1,.pure-u-1-1,.pure-u-1-12,.pure-u-1-2,.pure-u-1-24,.pure-u-1-3,.pure-u-1-4,.pure-u-1-5,.pure-u-1-6,.pure-u-1-8,.pure-u-10-24,.pure-u-11-12,.pure-u-11-24,.pure-u-12-24,.pure-u-13-24,.pure-u-14-24,.pure-u-15-24,.pure-u-16-24,.pure-u-17-24,.pure-u-18-24,.pure-u-19-24,.pure-u-2-24,.pure-u-2-3,.pure-u-2-5,.pure-u-20-24,.pure-u-21-24,.pure-u-22-24,.pure-u-23-24,.pure-u-24-24,.pure-u-3-24,.pure-u-3-4,.pure-u-3-5,.pure-u-3-8,.pure-u-4-24,.pure-u-4-5,.pure-u-5-12,.pure-u-5-24,.pure-u-5-5,.pure-u-5-6,.pure-u-5-8,.pure-u-6-24,.pure-u-7-12,.pure-u-7-24,.pure-u-7-8,.pure-u-8-24,.pure-u-9-24{display:inline-block;letter-spacing:normal;word-spacing:normal;vertical-align:top;text-rendering:auto}.pure-u-1-24{width:4.1667%}.pure-u-1-12,.pure-u-2-24{width:8.3333%}.pure-u-1-8,.pure-u-3-24{width:12.5%}.pure-u-1-6,.pure-u-4-24{width:16.6667%}.pure-u-1-5{width:20%}.pure-u-5-24{width:20.8333%}.pure-u-1-4,.pure-u-6-24{width:25%}.pure-u-7-24{width:29.1667%}.pure-u-1-3,.pure-u-8-24{width:33.3333%}.pure-u-3-8,.pure-u-9-24{width:37.5%}.pure-u-2-5{width:40%}.pure-u-10-24,.pure-u-5-12{width:41.6667%}.pure-u-11-24{width:45.8333%}.pure-u-1-2,.pure-u-12-24{width:50%}.pure-u-13-24{width:54.1667%}.pure-u-14-24,.pure-u-7-12{width:58.3333%}.pure-u-3-5{width:60%}.pure-u-15-24,.pure-u-5-8{width:62.5%}.pure-u-16-24,.pure-u-2-3{width:66.6667%}.pure-u-17-24{width:70.8333%}.pure-u-18-24,.pure-u-3-4{width:75%}.pure-u-19-24{width:79.1667%}.pure-u-4-5{width:80%}.pure-u-20-24,.pure-u-5-6{width:83.3333%}.pure-u-21-24,.pure-u-7-8{width:87.5%}.pure-u-11-12,.pure-u-22-24{width:91.6667%}.pure-u-23-24{width:95.8333%}.pure-u-1,.pure-u-1-1,.pure-u-24-24,.pure-u-5-5{width:100%}</style><style type=text/css media=screen>/*!Pure v3.0.0
Copyright 2013 Yahoo!
Licensed under the BSD License.
https://github.com/pure-css/pure/blob/master/LICENSE*/.pure-table{border-collapse:collapse;border-spacing:0;empty-cells:show;border:1px solid #cbcbcb}.pure-table caption{color:#000;font:italic 85%/1 arial,sans-serif;padding:1em 0;text-align:center}.pure-table td,.pure-table th{border-left:1px solid #cbcbcb;border-width:0 0 0 1px;font-size:inherit;margin:0;overflow:visible;padding:.5em 1em}.pure-table thead{background-color:#e0e0e0;color:#000;text-align:left;vertical-align:bottom}.pure-table td{background-color:transparent}.pure-table-odd td{background-color:#f2f2f2}.pure-table-striped tr:nth-child(2n-1) td{background-color:#f2f2f2}.pure-table-bordered td{border-bottom:1px solid #cbcbcb}.pure-table-bordered tbody>tr:last-child>td{border-bottom-width:0}.pure-table-horizontal td,.pure-table-horizontal th{border-width:0 0 1px;border-bottom:1px solid #cbcbcb}.pure-table-horizontal tbody>tr:last-child>td{border-bottom-width:0}</style><style type=text/css media=screen>/*!Pure v1.0.0
Copyright 2013 Yahoo!
Licensed under the BSD License.
https://github.com/yahoo/pure/blob/master/LICENSE.md*/@media screen and (min-width:35.5em){.pure-u-sm-1,.pure-u-sm-1-1,.pure-u-sm-1-12,.pure-u-sm-1-2,.pure-u-sm-1-24,.pure-u-sm-1-3,.pure-u-sm-1-4,.pure-u-sm-1-5,.pure-u-sm-1-6,.pure-u-sm-1-8,.pure-u-sm-10-24,.pure-u-sm-11-12,.pure-u-sm-11-24,.pure-u-sm-12-24,.pure-u-sm-13-24,.pure-u-sm-14-24,.pure-u-sm-15-24,.pure-u-sm-16-24,.pure-u-sm-17-24,.pure-u-sm-18-24,.pure-u-sm-19-24,.pure-u-sm-2-24,.pure-u-sm-2-3,.pure-u-sm-2-5,.pure-u-sm-20-24,.pure-u-sm-21-24,.pure-u-sm-22-24,.pure-u-sm-23-24,.pure-u-sm-24-24,.pure-u-sm-3-24,.pure-u-sm-3-4,.pure-u-sm-3-5,.pure-u-sm-3-8,.pure-u-sm-4-24,.pure-u-sm-4-5,.pure-u-sm-5-12,.pure-u-sm-5-24,.pure-u-sm-5-5,.pure-u-sm-5-6,.pure-u-sm-5-8,.pure-u-sm-6-24,.pure-u-sm-7-12,.pure-u-sm-7-24,.pure-u-sm-7-8,.pure-u-sm-8-24,.pure-u-sm-9-24{display:inline-block;zoom:1;letter-spacing:normal;word-spacing:normal;vertical-align:top;text-rendering:auto}.pure-u-sm-1-24{width:4.1667%}.pure-u-sm-1-12,.pure-u-sm-2-24{width:8.3333%}.pure-u-sm-1-8,.pure-u-sm-3-24{width:12.5%}.pure-u-sm-1-6,.pure-u-sm-4-24{width:16.6667%}.pure-u-sm-1-5{width:20%}.pure-u-sm-5-24{width:20.8333%}.pure-u-sm-1-4,.pure-u-sm-6-24{width:25%}.pure-u-sm-7-24{width:29.1667%}.pure-u-sm-1-3,.pure-u-sm-8-24{width:33.3333%}.pure-u-sm-3-8,.pure-u-sm-9-24{width:37.5%}.pure-u-sm-2-5{width:40%}.pure-u-sm-10-24,.pure-u-sm-5-12{width:41.6667%}.pure-u-sm-11-24{width:45.8333%}.pure-u-sm-1-2,.pure-u-sm-12-24{width:50%}.pure-u-sm-13-24{width:54.1667%}.pure-u-sm-14-24,.pure-u-sm-7-12{width:58.3333%}.pure-u-sm-3-5{width:60%}.pure-u-sm-15-24,.pure-u-sm-5-8{width:62.5%}.pure-u-sm-16-24,.pure-u-sm-2-3{width:66.6667%}.pure-u-sm-17-24{width:70.8333%}.pure-u-sm-18-24,.pure-u-sm-3-4{width:75%}.pure-u-sm-19-24{width:79.1667%}.pure-u-sm-4-5{width:80%}.pure-u-sm-20-24,.pure-u-sm-5-6{width:83.3333%}.pure-u-sm-21-24,.pure-u-sm-7-8{width:87.5%}.pure-u-sm-11-12,.pure-u-sm-22-24{width:91.6667%}.pure-u-sm-23-24{width:95.8333%}.pure-u-sm-1,.pure-u-sm-1-1,.pure-u-sm-24-24,.pure-u-sm-5-5{width:100%}}@media screen and (min-width:48em){.pure-u-md-1,.pure-u-md-1-1,.pure-u-md-1-12,.pure-u-md-1-2,.pure-u-md-1-24,.pure-u-md-1-3,.pure-u-md-1-4,.pure-u-md-1-5,.pure-u-md-1-6,.pure-u-md-1-8,.pure-u-md-10-24,.pure-u-md-11-12,.pure-u-md-11-24,.pure-u-md-12-24,.pure-u-md-13-24,.pure-u-md-14-24,.pure-u-md-15-24,.pure-u-md-16-24,.pure-u-md-17-24,.pure-u-md-18-24,.pure-u-md-19-24,.pure-u-md-2-24,.pure-u-md-2-3,.pure-u-md-2-5,.pure-u-md-20-24,.pure-u-md-21-24,.pure-u-md-22-24,.pure-u-md-23-24,.pure-u-md-24-24,.pure-u-md-3-24,.pure-u-md-3-4,.pure-u-md-3-5,.pure-u-md-3-8,.pure-u-md-4-24,.pure-u-md-4-5,.pure-u-md-5-12,.pure-u-md-5-24,.pure-u-md-5-5,.pure-u-md-5-6,.pure-u-md-5-8,.pure-u-md-6-24,.pure-u-md-7-12,.pure-u-md-7-24,.pure-u-md-7-8,.pure-u-md-8-24,.pure-u-md-9-24{display:inline-block;zoom:1;letter-spacing:normal;word-spacing:normal;vertical-align:top;text-rendering:auto}.pure-u-md-1-24{width:4.1667%}.pure-u-md-1-12,.pure-u-md-2-24{width:8.3333%}.pure-u-md-1-8,.pure-u-md-3-24{width:12.5%}.pure-u-md-1-6,.pure-u-md-4-24{width:16.6667%}.pure-u-md-1-5{width:20%}.pure-u-md-5-24{width:20.8333%}.pure-u-md-1-4,.pure-u-md-6-24{width:25%}.pure-u-md-7-24{width:29.1667%}.pure-u-md-1-3,.pure-u-md-8-24{width:33.3333%}.pure-u-md-3-8,.pure-u-md-9-24{width:37.5%}.pure-u-md-2-5{width:40%}.pure-u-md-10-24,.pure-u-md-5-12{width:41.6667%}.pure-u-md-11-24{width:45.8333%}.pure-u-md-1-2,.pure-u-md-12-24{width:50%}.pure-u-md-13-24{width:54.1667%}.pure-u-md-14-24,.pure-u-md-7-12{width:58.3333%}.pure-u-md-3-5{width:60%}.pure-u-md-15-24,.pure-u-md-5-8{width:62.5%}.pure-u-md-16-24,.pure-u-md-2-3{width:66.6667%}.pure-u-md-17-24{width:70.8333%}.pure-u-md-18-24,.pure-u-md-3-4{width:75%}.pure-u-md-19-24{width:79.1667%}.pure-u-md-4-5{width:80%}.pure-u-md-20-24,.pure-u-md-5-6{width:83.3333%}.pure-u-md-21-24,.pure-u-md-7-8{width:87.5%}.pure-u-md-11-12,.pure-u-md-22-24{width:91.6667%}.pure-u-md-23-24{width:95.8333%}.pure-u-md-1,.pure-u-md-1-1,.pure-u-md-24-24,.pure-u-md-5-5{width:100%}}@media screen and (min-width:64em){.pure-u-lg-1,.pure-u-lg-1-1,.pure-u-lg-1-12,.pure-u-lg-1-2,.pure-u-lg-1-24,.pure-u-lg-1-3,.pure-u-lg-1-4,.pure-u-lg-1-5,.pure-u-lg-1-6,.pure-u-lg-1-8,.pure-u-lg-10-24,.pure-u-lg-11-12,.pure-u-lg-11-24,.pure-u-lg-12-24,.pure-u-lg-13-24,.pure-u-lg-14-24,.pure-u-lg-15-24,.pure-u-lg-16-24,.pure-u-lg-17-24,.pure-u-lg-18-24,.pure-u-lg-19-24,.pure-u-lg-2-24,.pure-u-lg-2-3,.pure-u-lg-2-5,.pure-u-lg-20-24,.pure-u-lg-21-24,.pure-u-lg-22-24,.pure-u-lg-23-24,.pure-u-lg-24-24,.pure-u-lg-3-24,.pure-u-lg-3-4,.pure-u-lg-3-5,.pure-u-lg-3-8,.pure-u-lg-4-24,.pure-u-lg-4-5,.pure-u-lg-5-12,.pure-u-lg-5-24,.pure-u-lg-5-5,.pure-u-lg-5-6,.pure-u-lg-5-8,.pure-u-lg-6-24,.pure-u-lg-7-12,.pure-u-lg-7-24,.pure-u-lg-7-8,.pure-u-lg-8-24,.pure-u-lg-9-24{display:inline-block;zoom:1;letter-spacing:normal;word-spacing:normal;vertical-align:top;text-rendering:auto}.pure-u-lg-1-24{width:4.1667%}.pure-u-lg-1-12,.pure-u-lg-2-24{width:8.3333%}.pure-u-lg-1-8,.pure-u-lg-3-24{width:12.5%}.pure-u-lg-1-6,.pure-u-lg-4-24{width:16.6667%}.pure-u-lg-1-5{width:20%}.pure-u-lg-5-24{width:20.8333%}.pure-u-lg-1-4,.pure-u-lg-6-24{width:25%}.pure-u-lg-7-24{width:29.1667%}.pure-u-lg-1-3,.pure-u-lg-8-24{width:33.3333%}.pure-u-lg-3-8,.pure-u-lg-9-24{width:37.5%}.pure-u-lg-2-5{width:40%}.pure-u-lg-10-24,.pure-u-lg-5-12{width:41.6667%}.pure-u-lg-11-24{width:45.8333%}.pure-u-lg-1-2,.pure-u-lg-12-24{width:50%}.pure-u-lg-13-24{width:54.1667%}.pure-u-lg-14-24,.pure-u-lg-7-12{width:58.3333%}.pure-u-lg-3-5{width:60%}.pure-u-lg-15-24,.pure-u-lg-5-8{width:62.5%}.pure-u-lg-16-24,.pure-u-lg-2-3{width:66.6667%}.pure-u-lg-17-24{width:70.8333%}.pure-u-lg-18-24,.pure-u-lg-3-4{width:75%}.pure-u-lg-19-24{width:79.1667%}.pure-u-lg-4-5{width:80%}.pure-u-lg-20-24,.pure-u-lg-5-6{width:83.3333%}.pure-u-lg-21-24,.pure-u-lg-7-8{width:87.5%}.pure-u-lg-11-12,.pure-u-lg-22-24{width:91.6667%}.pure-u-lg-23-24{width:95.8333%}.pure-u-lg-1,.pure-u-lg-1-1,.pure-u-lg-24-24,.pure-u-lg-5-5{width:100%}}@media screen and (min-width:80em){.pure-u-xl-1,.pure-u-xl-1-1,.pure-u-xl-1-12,.pure-u-xl-1-2,.pure-u-xl-1-24,.pure-u-xl-1-3,.pure-u-xl-1-4,.pure-u-xl-1-5,.pure-u-xl-1-6,.pure-u-xl-1-8,.pure-u-xl-10-24,.pure-u-xl-11-12,.pure-u-xl-11-24,.pure-u-xl-12-24,.pure-u-xl-13-24,.pure-u-xl-14-24,.pure-u-xl-15-24,.pure-u-xl-16-24,.pure-u-xl-17-24,.pure-u-xl-18-24,.pure-u-xl-19-24,.pure-u-xl-2-24,.pure-u-xl-2-3,.pure-u-xl-2-5,.pure-u-xl-20-24,.pure-u-xl-21-24,.pure-u-xl-22-24,.pure-u-xl-23-24,.pure-u-xl-24-24,.pure-u-xl-3-24,.pure-u-xl-3-4,.pure-u-xl-3-5,.pure-u-xl-3-8,.pure-u-xl-4-24,.pure-u-xl-4-5,.pure-u-xl-5-12,.pure-u-xl-5-24,.pure-u-xl-5-5,.pure-u-xl-5-6,.pure-u-xl-5-8,.pure-u-xl-6-24,.pure-u-xl-7-12,.pure-u-xl-7-24,.pure-u-xl-7-8,.pure-u-xl-8-24,.pure-u-xl-9-24{display:inline-block;zoom:1;letter-spacing:normal;word-spacing:normal;vertical-align:top;text-rendering:auto}.pure-u-xl-1-24{width:4.1667%}.pure-u-xl-1-12,.pure-u-xl-2-24{width:8.3333%}.pure-u-xl-1-8,.pure-u-xl-3-24{width:12.5%}.pure-u-xl-1-6,.pure-u-xl-4-24{width:16.6667%}.pure-u-xl-1-5{width:20%}.pure-u-xl-5-24{width:20.8333%}.pure-u-xl-1-4,.pure-u-xl-6-24{width:25%}.pure-u-xl-7-24{width:29.1667%}.pure-u-xl-1-3,.pure-u-xl-8-24{width:33.3333%}.pure-u-xl-3-8,.pure-u-xl-9-24{width:37.5%}.pure-u-xl-2-5{width:40%}.pure-u-xl-10-24,.pure-u-xl-5-12{width:41.6667%}.pure-u-xl-11-24{width:45.8333%}.pure-u-xl-1-2,.pure-u-xl-12-24{width:50%}.pure-u-xl-13-24{width:54.1667%}.pure-u-xl-14-24,.pure-u-xl-7-12{width:58.3333%}.pure-u-xl-3-5{width:60%}.pure-u-xl-15-24,.pure-u-xl-5-8{width:62.5%}.pure-u-xl-16-24,.pure-u-xl-2-3{width:66.6667%}.pure-u-xl-17-24{width:70.8333%}.pure-u-xl-18-24,.pure-u-xl-3-4{width:75%}.pure-u-xl-19-24{width:79.1667%}.pure-u-xl-4-5{width:80%}.pure-u-xl-20-24,.pure-u-xl-5-6{width:83.3333%}.pure-u-xl-21-24,.pure-u-xl-7-8{width:87.5%}.pure-u-xl-11-12,.pure-u-xl-22-24{width:91.6667%}.pure-u-xl-23-24{width:95.8333%}.pure-u-xl-1,.pure-u-xl-1-1,.pure-u-xl-24-24,.pure-u-xl-5-5{width:100%}}</style><style type=text/css media=screen>:root{--color:#484848;--color-footnote:#575757;--color-footer-content:#bbb;--background-color:rgb(252, 252, 252);--background-color-code:rgb(240, 240, 240);--background-color-toggle-content:rgb(249, 249, 249);--link-color:#c05b4d;--link-color-hover:#a5473a;--list-link-color:#336699;--border-navbar-and-footer:#e3e3e3}</style><style type=text/css media=screen>html{min-height:100%;width:100%;position:relative}body{background-color:#fcfcfc;background-color:var(--background-color);color:#484848;color:var(--color)}a{text-decoration:none}kbd,pre,code,samp{background-color:#f0f0f0;background-color:var(--background-color-code)}.nav-menu{margin-top:5px;padding-bottom:5px;border-bottom-width:1px;border-bottom-style:solid;border-bottom-color:#e3e3e3;border-bottom-color:var(--border-navbar-and-footer)}.pure-menu-heading{text-transform:none;font-size:large}.pure-menu-link:hover{background-color:unset}.header{text-align:left;color:#484848;color:var(--color);margin-bottom:.5em}.header ul li{height:auto}.header ul li a{font-weight:700;color:#484848;color:var(--color);font-family:source sans pro,helveticaneue,helvetica neue,Helvetica,Arial,sans-serif}.header{font-weight:700;color:#484848;color:var(--color);font-family:source sans pro,helveticaneue,helvetica neue,Helvetica,Arial,sans-serif}.site-title{color:#484848;color:var(--color);text-transform:none;font-weight:400;font-family:source sans pro,helveticaneue,helvetica neue,Helvetica,Arial,sans-serif}.pull-right{float:right}.posts-name{text-transform:capitalize;font-weight:700;padding-left:1em;margin-top:1em;font-family:source sans pro,helveticaneue,helvetica neue,Helvetica,Arial,sans-serif}.posts{font-family:verdana,arial,helvetica,sans-serif;list-style-type:none;padding-left:1em}.posts li p{margin-top:0}.posts li{margin-bottom:1em}.posts li>a{color:#369;color:var(--list-link-color);text-decoration:none}.post-list{font-size:large}.footnote{font-family:verdana,arial,helvetica,sans-serif;color:#575757;color:var(--color-footnote);font-size:.75em;margin-bottom:0}.footnote a{color:#575757;color:var(--color-footnote)}.footnote a:hover{text-decoration:underline;color:#369;color:var(--list-link-color)}.footer{position:absolute;z-index:2;height:auto;width:100%;bottom:0}.footer-content{border-top-width:1px;border-top-style:solid;border-top-color:#e3e3e3;border-top:1px solid var(--border-navbar-and-footer);font-size:80%;color:#bbb;color:var(--color-footer-content)}.footer-content a{color:#575757;color:var(--color-footnote)}.footer-content ul{height:auto;margin-top:0;margin-bottom:0;display:inline-block;padding-left:0}#TableOfContents>ul{list-style:none;margin:0;padding:0}#gototop-btn{display:inline-block}#foot-name{color:#484848;color:var(--color);text-transform:none}#foot-copyright{padding-left:1em;padding-bottom:.5em;margin:0}.post{font-family:proxima-nova,helvetica neue,Helvetica,Roboto,Arial,sans-serif;color:#484848;color:var(--color);letter-spacing:normal;padding-left:.5em}.post h1,h2,h3,h4,h5,h6{font-weight:700;letter-spacing:normal}.post-content{z-index:9;overflow:auto;padding:0;padding-bottom:3em;font-size:16px;line-height:1.4}.post-content img{max-width:100%;height:auto}.post-content pre{padding:.5em}.post a{color:#c05b4d;color:var(--link-color);text-decoration:none}.post a:hover{color:#a5473a;color:var(--link-color-hover);text-decoration:underline}.post h1{font-size:28px}.post h2{font-size:25px}.post h3{font-size:23px}.post h4{font-size:21px}.post h5{font-size:19px}.post h6{font-size:18px}.post-title{margin-top:0;margin-bottom:1em}.post-title h1{font-weight:700;font-size:39px;line-height:40px;margin-top:0;margin-bottom:0}@media screen and (max-width:768px){.desktop{display:none}.mobile{display:block}#toggle-btn{display:inline-block;float:right;padding:.5em 1em;text-decoration:none;color:#484848;color:var(--color);font-weight:700}#toggle-content li{clear:both;height:auto;background-color:#f9f9f9;background-color:var(--background-color-toggle-content)}#toggle-home{display:inline-block}}@media screen and (min-width:769px){.mobile{display:none}.desktop{display:block}}</style><link rel="shortcut icon" href=/img/favicon.ico type=image/x-icon></head><body><div class="header pure-g"><div class="pure-u-1-24 pure-u-md-2-24 pure-u-lg-5-24"></div><div class="pure-u-11-12 pure-u-md-20-24 pure-u-lg-7-12"><div class="desktop pure-menu pure-menu-horizontal nav-menu"><a href=/ class="site-title pure-menu-heading">随记</a><ul class="pure-menu-list pull-right"><li class=pure-menu-item><a href=/categories/development/ class=pure-menu-link>Development</a></li><li class=pure-menu-item><a href=/categories/os/ class=pure-menu-link>OS</a></li><li class=pure-menu-item><a href=/categories/reading/ class=pure-menu-link>Reading</a></li><li class=pure-menu-item><a href=/about/ class=pure-menu-link>About</a></li></ul></div><div class="mobile pure-menu nav-menu"><a href=/ class="site-title pure-menu-heading" id=toggle-home>随记</a>
<a href=# id=toggle-btn>&#9776;</a><ul class=pure-menu-list id=toggle-content style=display:none><li class=pure-menu-item><a href=/categories/development/ class=pure-menu-link>Development</a></li><li class=pure-menu-item><a href=/categories/os/ class=pure-menu-link>OS</a></li><li class=pure-menu-item><a href=/categories/reading/ class=pure-menu-link>Reading</a></li><li class=pure-menu-item><a href=/about class=pure-menu-link>About</a></li></ul></div></div><div class="pure-u-1-24 pure-u-md-2-24 pure-u-lg-5-24"></div></div><div class=pure-g><div class="pure-u-1-24 pure-u-md-2-24 pure-u-lg-5-24"></div><div class="pure-u-11-12 pure-u-md-20-24 pure-u-lg-7-12"><div class=post><div class=post-title><p class=footnote><time datetime="2020-01-23 23:43:30 +0800 CST">2020-01-23
</time>|
tags: [ <a href=/tags/rust>Rust</a> ]
categories: [ <a href=/categories/reading>Reading</a> ]</p><h1>《The Rust Programming Language》笔记</h1></div><div class=post-content><nav id=TableOfContents><ul><li><a href=#1-getting-started>1. Getting Started</a></li><li><a href=#2-programming-a-guessing-game>2. Programming a Guessing Game</a></li><li><a href=#3-common-programming-concepts>3. Common Programming Concepts</a></li><li><a href=#4-understanding-ownership>4. Understanding Ownership</a></li><li><a href=#5-using-structs-to-structure-related-data>5. Using Structs to Structure Related Data</a></li><li><a href=#6-enums-and-pattern-matching>6. Enums and Pattern Matching</a></li><li><a href=#7-managing-growing-projects-with-packages-crates-and-modules>7. Managing Growing Projects with Packages, Crates, and Modules</a></li><li><a href=#8-common-collections>8. Common Collections</a></li><li><a href=#9-error-handling>9. Error Handling</a></li><li><a href=#10-generic-types-traits-and-lifetimes>10. Generic Types, Traits, and Lifetimes</a></li><li><a href=#11-writing-automated-tests>11. Writing Automated Tests</a></li><li><a href=#12-an-io-project-building-a-command-line-program>12. An I/O Project: Building a Command Line Program</a></li><li><a href=#13-functional-language-features-iterators-and-closures>13. Functional Language Features: Iterators and Closures</a></li><li><a href=#14-more-about-cargo-and-cratesio>14. More About Cargo and Crates.io</a></li><li><a href=#15-smart-pointers>15. Smart Pointers</a></li><li><a href=#16-fearless-concurrency>16. Fearless Concurrency</a></li><li><a href=#17-object-oriented-programming-features-of-rust>17. Object Oriented Programming Features of Rust</a></li><li><a href=#18-patterns-and-matching>18. Patterns and Matching</a></li><li><a href=#19-advanced-features>19. Advanced Features</a></li></ul></nav><h2 id=1-getting-started>1. Getting Started</h2><ol><li>使用 <code>rustup</code> 安装，默认安装在 <code>$HOME/.cargo</code> 和 <code>$HOME/.rustup</code> 下</li><li><code>rustup update</code></li><li><code>rustup self uninstall</code></li><li>cargo 常用命令<ol><li><code>cargo new PROJECT</code></li><li><code>cargo build [--release]</code></li><li><code>cargo run</code></li></ol></li></ol><h2 id=2-programming-a-guessing-game>2. Programming a Guessing Game</h2><ol><li><code>Cargo.toml</code> 里依赖部分的版本号 &ldquo;MAJOR.MINOR.PATCH&rdquo; 实际是 &ldquo;^MAJOR.MINOR.PATCH&rdquo; 的简写，表示允许语义版本的升级</li><li><code>cargo update</code> 默认只升级 PATCH 部分</li><li><code>cargo doc --open</code> 查看文档</li></ol><h2 id=3-common-programming-concepts>3. Common Programming Concepts</h2><ol><li>不可变变量：<code>let VAR: TYPE = VALUE;</code></li><li>可变变量：<code>let mut VAR: TYPE = VALUE;</code></li><li>常量：<code>const FOO_BAR: TYPE = VALUE;</code></li><li>Shadowing: 同一作用域里，同名变量可以重复声明，之前声明的变量被遮蔽。</li><li>Scalar types:<ol><li>Integer types: i8, u8, i16, u16, i32, u32, i64, u64, i128, u128, isize, usize，后两者长度跟机器相关，一般用于集合、数组的索引和长度。Debug 模式下溢出回绕会panic，Release模式下溢出回绕不报错。使用标准库里类型 Wrapping 显示表明期望溢出回绕行为。</li><li>Integer literals: 98_222, 0xff, 0o77, 0b1111_0000, b&rsquo;A&rsquo;，除了 byte literal，其它字面量都支持类型后缀，比如 57u8 表示一个 u8 类型的值 57。<strong>整型字面量默认类型为 i32</strong>。</li><li>Floating-point types: f32, f64，<strong>默认为 f64</strong>。</li><li>Boolean type: bool, true, false。布尔类型长度为一字节。</li><li>Character type: char，四个字节，表示一个 Unicode Scalar Value, 范围为 [U+0000, U+D7FF] 和 [U+E000, U+10FFFF]。</li></ol></li><li>Compound Types<ol><li>Tuple: (x, y, z)，类型声明 (t1, t2, t3)</li><li>Array: [x, y, z]，类型声明 [t; size]。 使用语法 [x; n] 创建 n 个 x 值的数组。数据访问会检查是否越界。</li></ol></li><li>Functions: <code>fn foo(x:t1, y:t2) -> t3 { ... }</code></li><li>Control flow:<ol><li><code>if condition { ... } else if condition { ... } else { ... }</code></li><li><code>loop { .... break VALUE; ... }</code></li><li><code>while condition { ... }</code></li><li><code>for VAR in ITER { ... }</code></li></ol></li></ol><h2 id=4-understanding-ownership>4. Understanding Ownership</h2><ol><li><p>Ownership rules：没有实现 Copy trait 的类型，变量赋值时是 move 语义，owner 超出作用域时自动调用 drop()</p><ol><li>Each value in Rust has a variable that&rsquo;s called its <em>owner</em>.</li><li>There can only be one owner at a time.</li><li>When the owner goes out of scope, the value will be dropped.</li></ol></li><li><p>Reference: borrow 语义</p><ol><li>多个只读引用可以同时指向一个变量</li><li>同时只能有一个<strong>可写</strong>引用指向一个变量，不能有其它<strong>只读</strong>或者<strong>可写</strong>引用指向同一个变量</li><li>Non-Lexical Lifetimes(NLL): 引用的作用域从声明开始，直到它最后一次被使用位置，并不是按照词法作用域判断</li></ol></li><li><p>Slice: borrow 语义</p><ol><li><code>&amp;s[i..j]</code> 表示 <code>[i, j)</code> 范围</li><li><code>&amp;str</code> 表示 string slice，定义字符串函数时，经常使用 <code>&amp;str</code> 作为参数类型，以同时支持 String 和 &amp;str</li><li>slice 记录第一个元素的引用，以及一个长度字段</li></ol></li></ol><h2 id=5-using-structs-to-structure-related-data>5. Using Structs to Structure Related Data</h2><ol><li><p>定义结构体：<code>struct Xxx { f1: t1, f2: t2 }</code></p></li><li><p>新建实例：<code>Xxx { f1: v1, f2: v2 }</code></p></li><li><p>当变量名与字段名同名时可以简写 <code>Xxx { f1, f2: v2}</code>等价于 <code>Xxx { f1: f1, f2: v2}</code>。</p></li><li><p>根据已有结构体实例修改部分字段以创建新实例：<code>Xxx { f1: v1, ..xxx}</code>，xxx 为已有实例</p></li><li><p>Tuple Struct: <code>struct Point(i32, i32, i32)</code> 可以使用 <code>point.0</code>, <code>point.1</code> 来引用字段。</p></li><li><p>Unit-like struct: <code>()</code>，没有任何字段。</p></li><li><p>在结构体定义时使用 annotation <code>#[derive(Debug)]</code> 可以让它能被 <code>println!</code> 的 <code>{:?}</code> 或者 <code>{:#?}</code> 置位符输出。</p></li><li><p>定义方法：</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#007020;font-weight:700>impl</span><span style=color:#bbb> </span>Rectangle<span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#007020;font-weight:700>fn</span> <span style=color:#06287e>area</span>(<span style=color:#666>&amp;</span><span style=color:#007020>self</span>)<span style=color:#bbb> </span>-&gt; <span style=color:#902000>u32</span> {<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:#007020>self</span>.width<span style=color:#bbb> </span><span style=color:#666>*</span><span style=color:#bbb> </span><span style=color:#007020>self</span>.height<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>}<span style=color:#bbb>
</span></span></span></code></pre></div></li><li><p>同一个结构体可以有多个 <code>impl</code> 块。</p></li></ol><h2 id=6-enums-and-pattern-matching>6. Enums and Pattern Matching</h2><ol><li><p>定义：</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#007020;font-weight:700>enum</span> <span style=color:#0e84b5;font-weight:700>Message</span><span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>Quit,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>Move<span style=color:#bbb> </span>{<span style=color:#bbb> </span>x: <span style=color:#902000>i32</span>,<span style=color:#bbb> </span>y: <span style=color:#902000>i32</span> },<span style=color:#bbb>		</span><span style=color:#60a0b0;font-style:italic>// 匿名 struct
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span><span style=color:#bbb>    </span>Write(<span style=color:#007020>String</span>),<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>ChangeColor(<span style=color:#902000>i32</span>,<span style=color:#bbb> </span><span style=color:#902000>i32</span>,<span style=color:#bbb> </span><span style=color:#902000>i32</span>),<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>}<span style=color:#bbb>
</span></span></span></code></pre></div></li><li><p>enum 跟 struct 一样，也可以用 <code>impl</code> 定义 method</p></li><li><p><code>Option</code>类型包含在 prelude 中，可以直接使用 <code>Option</code> 甚至它的 variants <code>Some</code> 和 <code>None</code>。</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#007020;font-weight:700>enum</span> <span style=color:#007020>Option</span><span style=color:#666>&lt;</span>T<span style=color:#666>&gt;</span><span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#007020>Some</span>(T),<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#007020>None</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>}<span style=color:#bbb>
</span></span></span></code></pre></div></li><li><p>match 表达式：</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#007020;font-weight:700>match</span><span style=color:#bbb> </span>expr<span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>pattern<span style=color:#bbb> </span><span style=color:#666>=&gt;</span><span style=color:#bbb> </span><span style=color:#666>..</span>.,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>_<span style=color:#bbb> </span><span style=color:#666>=&gt;</span><span style=color:#bbb> </span><span style=color:#666>..</span>.,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>}<span style=color:#bbb>
</span></span></span></code></pre></div></li><li><p>if let 表达式：</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#007020;font-weight:700>if</span><span style=color:#bbb> </span><span style=color:#007020;font-weight:700>let</span><span style=color:#bbb> </span>pattern<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span>expr<span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#666>..</span>.;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>}<span style=color:#bbb> </span><span style=color:#007020;font-weight:700>else</span><span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#666>..</span>.;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>}<span style=color:#bbb>
</span></span></span></code></pre></div></li></ol><h2 id=7-managing-growing-projects-with-packages-crates-and-modules>7. Managing Growing Projects with Packages, Crates, and Modules</h2><ol><li><p>Rust <em>module system</em>:</p><ol><li><strong>Packages:</strong> A Cargo feature that lets you build, test, and share crates</li><li><strong>Crates:</strong> A tree of modules that produces a library or executable</li><li><strong>Modules</strong> and <strong>use:</strong> Let you control the organization, scope, and privacy of paths</li><li><strong>Paths:</strong> A way of naming an item, such as a struct, function, or module</li></ol></li><li><p>一个 package 的目录结构如下，src/lib.rs 和 src/main.rs 的 crate name 与 package 同名</p><pre tabindex=0><code>package/   一个 package 最多有一个 library crate，可以有多个 binary crate
├── Cargo.toml
└── src
    ├── bin
    │   ├── bar.rs	# 额外的 binary crate，隐含 module &#34;crate&#34;，此文件称为 crate root
    │   └── foo.rs	# 额外的 binary crate，隐含 module &#34;crate&#34;，此文件称为 crate root
    ├── lib.rs    	# 默认的 library crate，隐含 module &#34;crate&#34;，此文件称为 crate root
    └── main.rs   	# 默认的 binary crate，隐含 module &#34;crate&#34;，此文件称为 crate root
</code></pre></li><li><p>module tree 和 directory tree 不是一一对应的，一个 <code>.rs</code> 文件里可以定义平行或者嵌套的多个 module。module tree 里的 path 规则：</p><ol><li>绝对路径：当前 crate <code>crate::...</code> ，其它 crate <code>some_crate::...</code></li><li>相对路径：<code>self::...</code>, <code>super::...</code>, <code>some_identifier</code></li></ol></li><li><p>符号的可见性</p><ol><li>所有符号，包括 mod, struct, enum, fn, const 默认都是私有的，需要用 pub 修饰符公开</li><li>child mod 可以看到 parent mod 的所有符号，parent mod 只能看到 child mod 公开的符号</li><li>pub struct 的 field 需要额外加 pub 才是公开的，而 pub enum 的 variants 都是公开的</li></ol></li><li><p>使用 <code>use</code> 导入 path，类似于文件系统中 <code>ln -s PATH .</code></p><ol><li>习惯上，导入 function 时，导入到 mod 级别，使用 <code>some_mod::some_fn</code> 调用，以容易识别函数来自哪个模块</li><li>习惯上，导入 struct 和 enum 时，导入到符号本身级别，比如 <code>use std::collectioons::HashMap;</code></li><li>使用 <code>as</code> 关键字导入为别名：<code>use std::io::Result as IoResult;</code></li><li><code>use</code> 导入的符号默认为私有，使用 <code>pub use</code> 达到 re-exporting 为公开的效果。</li><li>Nested paths: <code>use std::{cmp::Ordering, io};</code> 等价于 <code>use std::cmp::Ordering; use std::io;</code>， <code>use std::io::{self, Write};</code> 等价于 <code>use std::io; use std::io::Write;</code></li><li>引入一个 mod 里的所有公开符号：<code>use std::collections::*;</code> ，一般用于单元测试代码里。</li></ol></li><li><p>切分 modules 到不同文件</p><ol><li><code>mod xxx;</code> 等价于 <code>mod xxx { ...加载 module/path/to/xxx.rs 文件内容.... }</code><ol><li>在 crate root 里，<code>mod xxx</code>; 等价于 <code>mod xxx { ...load xxx.rs... }</code></li><li>在 crate::foo::bar 里，<code>mod xxx;</code> 等价于 <code>mod xxx { ... load foo/bar/xxx.rs... }</code></li></ol></li><li><code>use</code> 只是做符号连接，并不会加载模块</li></ol></li></ol><h2 id=8-common-collections>8. Common Collections</h2><ol><li><p><code>Vec&lt;T></code>: 创建实例 <code>Vec::new()</code>, <code>vec![1, 2, 3, 4]</code></p></li><li><p><code>v[i]</code> 在 i 越界时会 panic，<code>v.get(i)</code> 返回 <code>Option&lt;T></code>，因此在越界时返回 None。</p></li><li><p>字符串的 <code>+</code> 调用的 <code>fn add(self, s: &amp;str) -> String</code>，第一个参数的所有权会被拿走，后面的参数必须是引用。</p></li><li><p><code>format!(...)</code> 拼接字符串，不拿走任何参数的所有权。</p></li><li><p>字符串的 <code>len()</code> 返回的是「<strong>字节数</strong>」不是「字符数」！ 使用 <code>s.chars().count()</code> 可以拿到 unicode scalar value 个数，而通常人为感知的「字符」指 grapheme cluster，需要用第三方库处理。</p></li><li><p>HashMap:</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#007020;font-weight:700>use</span><span style=color:#bbb> </span>std::collections::HashMap;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#007020;font-weight:700>let</span><span style=color:#bbb> </span><span style=color:#007020;font-weight:700>mut</span><span style=color:#bbb> </span>scores<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span>HashMap::new();<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>scores.insert(<span style=color:#007020>String</span>::from(<span style=color:#4070a0>&#34;Blue&#34;</span>),<span style=color:#bbb> </span><span style=color:#40a070>10</span>);<span style=color:#bbb>	</span><span style=color:#60a0b0;font-style:italic>// 如果已经存在，则会覆盖
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#007020;font-weight:700>let</span><span style=color:#bbb> </span>team_name<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span><span style=color:#007020>String</span>::from(<span style=color:#4070a0>&#34;Blue&#34;</span>);<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#007020;font-weight:700>let</span><span style=color:#bbb> </span>score<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span>scores.get(<span style=color:#666>&amp;</span>team_name);<span style=color:#bbb>		</span><span style=color:#60a0b0;font-style:italic>// 返回 Option&lt;&amp;V&gt;
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#007020;font-weight:700>for</span><span style=color:#bbb> </span>(key,<span style=color:#bbb> </span>value)<span style=color:#bbb> </span><span style=color:#007020;font-weight:700>in</span><span style=color:#bbb> </span><span style=color:#666>&amp;</span>scores<span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#666>..</span>.<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#60a0b0;font-style:italic>// 不存在时才插入，返回 &amp;mut V
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span><span style=color:#007020;font-weight:700>let</span><span style=color:#bbb> </span>score<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span>scores.entry(<span style=color:#007020>String</span>::from(<span style=color:#4070a0>&#34;Blue&#34;</span>)).or_insert(<span style=color:#40a070>50</span>);<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#666>*</span>score<span style=color:#bbb> </span><span style=color:#666>+=</span><span style=color:#bbb> </span><span style=color:#40a070>10</span>;<span style=color:#bbb>
</span></span></span></code></pre></div></li><li><p>HashMap 默认使用 cryptographically strong <strong>SipHash</strong>，如果感觉性能更重要，可以换用其它 hasher。</p></li></ol><h2 id=9-error-handling>9. Error Handling</h2><ol><li><p>不可恢复错误：<code>panic!</code>，默认使用 unwind 策略，释放栈上的对象，在 Cargo.toml 里使用 profile 换成 abort 策略，也即立即退出。</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-toml data-lang=toml><span style=display:flex><span>[profile.release]
</span></span><span style=display:flex><span>panic = <span style=color:#4070a0>&#39;abort&#39;</span>
</span></span></code></pre></div></li><li><p>使用 <code>RUST_BACKTRACE=1</code> 环境变量在 panic 时打印调用栈</p></li><li><p>可恢复错误：</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#007020;font-weight:700>enum</span> <span style=color:#007020>Result</span><span style=color:#666>&lt;</span>T,<span style=color:#bbb> </span>E<span style=color:#666>&gt;</span><span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#007020>Ok</span>(T),<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#007020>Err</span>(E),<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>}<span style=color:#bbb>
</span></span></span></code></pre></div></li><li><p><code>?</code> 操作符：<code>someResult?</code> 表示如果是 Ok 则返回 T，如果是 Err，则转换成当前函数返回类型（必须是Result）并返回。</p></li></ol><h2 id=10-generic-types-traits-and-lifetimes>10. Generic Types, Traits, and Lifetimes</h2><ol><li><p>struct, enum, fn 都可以使用泛型，在类型或者函数名字后面使用 <code>&lt;T1, T2, ...></code> 添加泛型参数。</p></li><li><p><code>impl&lt;T> Point&lt;T> { ... }</code> 中 impl 后的泛型参数，表示 <code>Point&lt;T></code> 里的<code>T</code> 是泛型参数，而不是具体参数。</p></li><li><p>Trait 很像其它语言的 interface，支持默认实现。</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#60a0b0;font-style:italic>// 定义 trait
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span><span style=color:#007020;font-weight:700>trait</span><span style=color:#bbb> </span>Summary<span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#007020;font-weight:700>fn</span> <span style=color:#06287e>summarize</span>(<span style=color:#666>&amp;</span><span style=color:#007020>self</span>)<span style=color:#bbb> </span>-&gt; <span style=color:#007020>String</span>;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#007020;font-weight:700>fn</span> <span style=color:#06287e>abstract</span>(<span style=color:#666>&amp;</span><span style=color:#007020>self</span>)<span style=color:#bbb> </span>-&gt; <span style=color:#007020>String</span> {<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:#007020>String</span>::from(<span style=color:#4070a0>&#34;....&#34;</span>)<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#60a0b0;font-style:italic>// 为某个 struct or enum 实现 trait
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span><span style=color:#007020;font-weight:700>impl</span><span style=color:#bbb> </span>Summary<span style=color:#bbb> </span><span style=color:#007020;font-weight:700>for</span><span style=color:#bbb> </span>Tweet<span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#007020;font-weight:700>fn</span> <span style=color:#06287e>summarize</span>(<span style=color:#666>&amp;</span><span style=color:#007020>self</span>)<span style=color:#bbb> </span>-&gt; <span style=color:#007020>String</span> {<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:#06287e>format!</span>(<span style=color:#4070a0>&#34;...&#34;</span>,<span style=color:#bbb> </span><span style=color:#666>..</span>.)<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#60a0b0;font-style:italic>// 要求函数参数满足某个 trait，这种写法一般用在参数个数少的情况
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span><span style=color:#007020;font-weight:700>fn</span> <span style=color:#06287e>notify</span>(item: <span style=color:#0e84b5;font-weight:700>impl</span><span style=color:#bbb> </span>Summary)<span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>   </span><span style=color:#666>....</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#60a0b0;font-style:italic>// 更通用的 Trait 约束语法
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span><span style=color:#007020;font-weight:700>fn</span> <span style=color:#06287e>notify</span><span style=color:#666>&lt;</span>T: <span style=color:#0e84b5;font-weight:700>Summary</span><span style=color:#666>&gt;</span>(item: <span style=color:#0e84b5;font-weight:700>T</span>)<span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#666>..</span>.<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#60a0b0;font-style:italic>// 满足多个 trait
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span><span style=color:#007020;font-weight:700>fn</span> <span style=color:#06287e>notify</span>(item: <span style=color:#0e84b5;font-weight:700>impl</span><span style=color:#bbb> </span>Summary<span style=color:#bbb> </span><span style=color:#666>+</span><span style=color:#bbb> </span>Display)<span style=color:#bbb> </span>{<span style=color:#bbb> </span><span style=color:#666>..</span>.<span style=color:#bbb> </span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#007020;font-weight:700>fn</span> <span style=color:#06287e>notify</span><span style=color:#666>&lt;</span>T: <span style=color:#0e84b5;font-weight:700>Summary</span><span style=color:#bbb> </span><span style=color:#666>+</span><span style=color:#bbb> </span>Display<span style=color:#666>&gt;</span>(item: <span style=color:#0e84b5;font-weight:700>T</span>)<span style=color:#bbb> </span>{<span style=color:#bbb> </span><span style=color:#666>..</span>.<span style=color:#bbb> </span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#007020;font-weight:700>fn</span> <span style=color:#06287e>notify</span><span style=color:#666>&lt;</span>T<span style=color:#666>&gt;</span>(item: <span style=color:#0e84b5;font-weight:700>T</span>)<span style=color:#bbb> </span><span style=color:#007020;font-weight:700>where</span><span style=color:#bbb> </span>T: <span style=color:#0e84b5;font-weight:700>Summary</span><span style=color:#bbb> </span><span style=color:#666>+</span><span style=color:#bbb> </span>Display<span style=color:#bbb> </span>{<span style=color:#bbb> </span><span style=color:#666>..</span>.<span style=color:#bbb> </span>}<span style=color:#bbb>  </span><span style=color:#60a0b0;font-style:italic>// 更容易阅读函数签名
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#60a0b0;font-style:italic>// 函数返回值满足某个 trait，注意由于 Rust 编译器实现限制，
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic>// impl Summary 返回值约束下，函数只能固定返回某种固定的具体类型！
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span><span style=color:#007020;font-weight:700>fn</span> <span style=color:#06287e>return_summarizable</span>()<span style=color:#bbb> </span>-&gt; <span style=color:#0e84b5;font-weight:700>impl</span><span style=color:#bbb> </span>Summary<span style=color:#bbb> </span>{<span style=color:#bbb> </span><span style=color:#666>..</span>.<span style=color:#bbb> </span>}<span style=color:#bbb>
</span></span></span></code></pre></div></li><li><p>利用 trait bound 来条件化的实现方法</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#007020;font-weight:700>use</span><span style=color:#bbb> </span>std::fmt::Display;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#007020;font-weight:700>struct</span> <span style=color:#0e84b5;font-weight:700>Pair</span><span style=color:#666>&lt;</span>T<span style=color:#666>&gt;</span><span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>x: <span style=color:#0e84b5;font-weight:700>T</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>y: <span style=color:#0e84b5;font-weight:700>T</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#007020;font-weight:700>impl</span><span style=color:#666>&lt;</span>T<span style=color:#666>&gt;</span><span style=color:#bbb> </span>Pair<span style=color:#666>&lt;</span>T<span style=color:#666>&gt;</span><span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#007020;font-weight:700>fn</span> <span style=color:#06287e>new</span>(x: <span style=color:#0e84b5;font-weight:700>T</span>,<span style=color:#bbb> </span>y: <span style=color:#0e84b5;font-weight:700>T</span>)<span style=color:#bbb> </span>-&gt; <span style=color:#0e84b5;font-weight:700>Self</span><span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:#007020>Self</span><span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span>x,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span>y,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#007020;font-weight:700>impl</span><span style=color:#666>&lt;</span>T: <span style=color:#0e84b5;font-weight:700>Display</span><span style=color:#bbb> </span><span style=color:#666>+</span><span style=color:#bbb> </span><span style=color:#007020>PartialOrd</span><span style=color:#666>&gt;</span><span style=color:#bbb> </span>Pair<span style=color:#666>&lt;</span>T<span style=color:#666>&gt;</span><span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#007020;font-weight:700>fn</span> <span style=color:#06287e>cmp_display</span>(<span style=color:#666>&amp;</span><span style=color:#007020>self</span>)<span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:#007020;font-weight:700>if</span><span style=color:#bbb> </span><span style=color:#007020>self</span>.x<span style=color:#bbb> </span><span style=color:#666>&gt;=</span><span style=color:#bbb> </span><span style=color:#007020>self</span>.y<span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:#06287e>println!</span>(<span style=color:#4070a0>&#34;The largest member is x = </span><span style=color:#70a0d0>{}</span><span style=color:#4070a0>&#34;</span>,<span style=color:#bbb> </span><span style=color:#007020>self</span>.x);<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>}<span style=color:#bbb> </span><span style=color:#007020;font-weight:700>else</span><span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:#06287e>println!</span>(<span style=color:#4070a0>&#34;The largest member is y = </span><span style=color:#70a0d0>{}</span><span style=color:#4070a0>&#34;</span>,<span style=color:#bbb> </span><span style=color:#007020>self</span>.y);<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>}<span style=color:#bbb>
</span></span></span></code></pre></div></li><li><p>blanket implentation: 为满足某个 trait bound 的<strong>所有类型</strong>实现 method。</p><pre tabindex=0><code>impl&lt;T: Display&gt; ToString for T {
    fn to_string(&amp;self) -&gt; String { ... }
}
</code></pre></li><li><p>Lifetime 也是一种泛型参数，修饰于引用类型上，比如 <code>&'a TYPE</code>，lifetime 名字紧接 <code>&</code> 后面，以单引号开头，任意字符串作为名字，习惯上跟泛型类型参数一样用单个字符。作为泛型参数的一种，其也需要在 struct, enum, fn 的名字后面用 <code>&lt;'a, 'b></code> 这样指定上， 对于 <code>impl&lt;'a, 'b>'</code> 也如此。</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#007020;font-weight:700>fn</span> <span style=color:#06287e>longest</span><span style=color:#666>&lt;</span><span style=color:#4070a0>&#39;a</span><span style=color:#666>&gt;</span>(x: <span style=color:#007020>&amp;</span><span style=color:#4070a0>&#39;a</span> <span style=color:#902000>str</span>,<span style=color:#bbb> </span>y: <span style=color:#007020>&amp;</span><span style=color:#4070a0>&#39;a</span> <span style=color:#902000>str</span>)<span style=color:#bbb> </span>-&gt; <span style=color:#007020>&amp;</span><span style=color:#4070a0>&#39;a</span> <span style=color:#902000>str</span> {<span style=color:#bbb> </span><span style=color:#666>..</span>.<span style=color:#bbb> </span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#007020;font-weight:700>struct</span> <span style=color:#0e84b5;font-weight:700>ImportantExcerpt</span><span style=color:#666>&lt;</span><span style=color:#4070a0>&#39;a</span><span style=color:#666>&gt;</span><span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>part: <span style=color:#007020>&amp;</span><span style=color:#4070a0>&#39;a</span> <span style=color:#902000>str</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#007020;font-weight:700>impl</span><span style=color:#666>&lt;</span><span style=color:#4070a0>&#39;a</span><span style=color:#666>&gt;</span><span style=color:#bbb> </span>ImportantExcerpt<span style=color:#666>&lt;</span><span style=color:#4070a0>&#39;a</span><span style=color:#666>&gt;</span><span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#666>..</span>.<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>}<span style=color:#bbb>
</span></span></span></code></pre></div></li><li><p>函数签名 lifetime 省略的三条规则（Rust 编译器以后可能加入更多规则以方便代码编写）。当 lifetime annotation 没有针对函数的输入参数(对应input lifetime parameter)和返回值(对应output lifetime parameter) 指定时：</p><ol><li>每个没有指定 lifetime 的<strong>输入</strong>参数获得自己<strong>独有</strong>的 lifetime</li><li>如果只有一个输入参数，且返回值没有指定 lifetime，则返回值和输入参数有同样的 lifetime</li><li>如果第一个参数是 <code>&amp;self</code> or<code> &amp;mut self</code>(意味着这个函数是个method)，且返回值没有指定 lifetime，则返回值和 self 有同样的 lifetime</li></ol></li><li><p><code>'static</code> 称为静态生命周期，指代一个引用在整个程序运行期间都有效，比如字面字符串的引用，其隐含了 <code>'static</code> 生命周期。注意编译器在提示 &ldquo;lifetime <code>'static</code> required&rdquo; 时往往是错的，程序员应该正确指定合适的 lifetime。</p></li></ol><h2 id=11-writing-automated-tests>11. Writing Automated Tests</h2><ol><li><p>单元测试代码示例：</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#007020>#[cfg(test)]</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#007020;font-weight:700>mod</span> <span style=color:#0e84b5;font-weight:700>tests</span><span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#007020;font-weight:700>use</span><span style=color:#bbb> </span><span style=color:#007020;font-weight:700>super</span>::<span style=color:#666>*</span>;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#007020>#[test]</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#007020>#[should_panic(expected = </span><span style=color:#4070a0>&#34;...some error message...&#34;</span><span style=color:#007020>)]</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#007020;font-weight:700>fn</span> <span style=color:#06287e>it_works</span>()<span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:#06287e>assert_eq!</span>(<span style=color:#40a070>2</span><span style=color:#bbb> </span><span style=color:#666>+</span><span style=color:#bbb> </span><span style=color:#40a070>2</span>,<span style=color:#bbb> </span><span style=color:#40a070>4</span>);<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>}<span style=color:#bbb>
</span></span></span></code></pre></div></li><li><p><code>assert!</code>, <code>assert_eq!</code>, <code>assert_ne!</code> 都可以接受额外的错误消息模板以及参数，类似 <code>format!</code></p></li><li><p>测试函数可以返回 Result&lt;(), String>，成功时返回 <code>Ok(())</code>，失败时返回 <code>Err(String::from("..."))</code></p></li><li><p><strong>对于 library crate</strong>，<code>tests/</code> 目录下每个 <code>.rs</code> 文件被当作一个 crate，<code>cargo test</code> 会执行每个文件里的测试函数。通用的 setup 代码可以放到 <code>tests/common/mod.rs</code> 里，不要放到 <code>tests/common.rs</code> 因为这样会被当作一个集成测试文件。</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#007020;font-weight:700>use</span><span style=color:#bbb> </span>adder;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#007020;font-weight:700>mod</span> <span style=color:#0e84b5;font-weight:700>common</span>;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#007020>#[test]</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#007020;font-weight:700>fn</span> <span style=color:#06287e>it_adds_two</span>()<span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>common::setup();<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#06287e>assert_eq!</span>(<span style=color:#40a070>4</span>,<span style=color:#bbb> </span>adder::add_two(<span style=color:#40a070>2</span>));<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>}<span style=color:#bbb>
</span></span></span></code></pre></div></li></ol><h2 id=12-an-io-project-building-a-command-line-program>12. An I/O Project: Building a Command Line Program</h2><ol><li><p><code>std::env::args()</code> 需要命令行参数是合法的 Unicode，否则会 panic。对非 Unicode 字符集使用 <code>std::env::args_os()</code></p></li><li><p><code>std::fs</code> 操作文件</p></li><li><p><code>std::process::exit(i32)</code> 退出进程</p></li><li><p>可能遇到任意错误的返回值：</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#007020;font-weight:700>use</span><span style=color:#bbb> </span>std::error::Error;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#007020;font-weight:700>fn</span> <span style=color:#06287e>main</span>()<span style=color:#bbb> </span>-&gt; <span style=color:#007020>Result</span><span style=color:#666>&lt;</span>(),<span style=color:#bbb> </span><span style=color:#007020>Box</span><span style=color:#666>&lt;</span><span style=color:#007020;font-weight:700>dyn</span><span style=color:#bbb> </span>Error<span style=color:#666>&gt;&gt;</span><span style=color:#bbb> </span>{<span style=color:#bbb> </span><span style=color:#666>..</span>.<span style=color:#bbb> </span>}<span style=color:#bbb>
</span></span></span></code></pre></div></li><li><p><code>std::env::var(KEY)</code> 获取环境变量</p></li><li><p><code>eprintln!(...)</code> 输出到 stderr</p></li></ol><h2 id=13-functional-language-features-iterators-and-closures>13. Functional Language Features: Iterators and Closures</h2><ol><li><p>Closure 语法:</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#007020;font-weight:700>fn</span>  <span style=color:#06287e>add_one_v1</span><span style=color:#bbb>   </span>(x: <span style=color:#902000>u32</span>)<span style=color:#bbb> </span>-&gt; <span style=color:#902000>u32</span> {<span style=color:#bbb> </span>x<span style=color:#bbb> </span><span style=color:#666>+</span><span style=color:#bbb> </span><span style=color:#40a070>1</span><span style=color:#bbb> </span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#007020;font-weight:700>let</span><span style=color:#bbb> </span>add_one_v2<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span><span style=color:#666>|</span>x: <span style=color:#902000>u32</span><span style=color:#666>|</span><span style=color:#bbb> </span>-&gt; <span style=color:#902000>u32</span> {<span style=color:#bbb> </span>x<span style=color:#bbb> </span><span style=color:#666>+</span><span style=color:#bbb> </span><span style=color:#40a070>1</span><span style=color:#bbb> </span>};<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#007020;font-weight:700>let</span><span style=color:#bbb> </span>add_one_v3<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span><span style=color:#666>|</span>x<span style=color:#666>|</span><span style=color:#bbb>             </span>{<span style=color:#bbb> </span>x<span style=color:#bbb> </span><span style=color:#666>+</span><span style=color:#bbb> </span><span style=color:#40a070>1</span><span style=color:#bbb> </span>};<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#007020;font-weight:700>let</span><span style=color:#bbb> </span>add_one_v4<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span><span style=color:#666>|</span>x<span style=color:#666>|</span><span style=color:#bbb>               </span>x<span style=color:#bbb> </span><span style=color:#666>+</span><span style=color:#bbb> </span><span style=color:#40a070>1</span><span style=color:#bbb>  </span>;<span style=color:#bbb>
</span></span></span></code></pre></div></li><li><p>Closure 的参数、返回值类型在第一次使用 closure 时才推断确定。</p></li><li><p>Closure 在实现时，实际是创建了一个匿名 struct，实现了 trait <code>FnOnce</code>, <code>FnMut</code>, <code>Fn</code> 中的一个，并保存了捕获的上下文变量。</p></li><li><p>在 closure 参数列表前加 <code>move</code> 表示显式的将<strong>捕获的环境变量</strong>的所有权转移到 closure 上，这种用法一般用在把 closure 传递给另一个线程时。</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#007020;font-weight:700>let</span><span style=color:#bbb> </span>x<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span><span style=color:#06287e>vec!</span>[<span style=color:#40a070>1</span>,<span style=color:#bbb> </span><span style=color:#40a070>2</span>,<span style=color:#bbb> </span><span style=color:#40a070>3</span>];<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#007020;font-weight:700>let</span><span style=color:#bbb> </span>equal_to_x<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span><span style=color:#007020;font-weight:700>move</span><span style=color:#bbb> </span><span style=color:#666>|</span>z<span style=color:#666>|</span><span style=color:#bbb> </span>z<span style=color:#bbb> </span><span style=color:#666>==</span><span style=color:#bbb> </span>x;<span style=color:#bbb>
</span></span></span></code></pre></div></li><li><p>Iterator trait:</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#007020;font-weight:700>pub</span><span style=color:#bbb> </span><span style=color:#007020;font-weight:700>trait</span><span style=color:#bbb> </span><span style=color:#007020>Iterator</span><span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#007020;font-weight:700>type</span> <span style=color:#0e84b5;font-weight:700>Item</span>;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#007020;font-weight:700>fn</span> <span style=color:#06287e>next</span>(<span style=color:#666>&amp;</span><span style=color:#007020;font-weight:700>mut</span><span style=color:#bbb> </span><span style=color:#007020>self</span>)<span style=color:#bbb> </span>-&gt; <span style=color:#007020>Option</span><span style=color:#666>&lt;</span><span style=color:#007020>Self</span>::Item<span style=color:#666>&gt;</span>;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#60a0b0;font-style:italic>// methods with default implementations elided
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span>}<span style=color:#bbb>
</span></span></span></code></pre></div></li><li><p>Iterator 的三个构造方法：</p><ol><li><strong>iter()</strong>: return immutable reference</li><li><strong>iter_mut()</strong>: return mutable reference</li><li><strong>into_iter()</strong>: take ownership and return owned value</li></ol></li></ol><h2 id=14-more-about-cargo-and-cratesio>14. More About Cargo and Crates.io</h2><ol><li><p>crate 级别(src/lib.rs) 开头以及 module 开头，使用 <code>//! ...</code> 编写 Markdown 文档</p></li><li><p>struct, enum, fn 之类前面使用 <code>/// ...</code> 编写 Markdown 文档，一般包含:</p><ul><li><code># Examples</code>: 使用 ``` 包围的代码段，在执行 <code>cargo test</code> 时会被当成测试用例执行</li><li><code># Panics</code>: 是否调用了 panic!</li><li><code># Errors</code>: 对 Result 返回值什么情况下返回 Err 的阐述</li><li><code># Safefy</code>: 如何使用 unsafe</li></ul></li><li><p>Cargo workspace: 在顶层目录创建 Cargo.toml，然后在此目录下再 <code>cargo new</code> 创建 package，所有 package 共享顶层目录的 Cargo.lock，但各自的 Cargo.toml 完全独立。</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-toml data-lang=toml><span style=display:flex><span>[workspace]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>members = [
</span></span><span style=display:flex><span>    <span style=color:#4070a0>&#34;pkg1&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#4070a0>&#34;pkg2&#34;</span>
</span></span><span style=display:flex><span>]
</span></span></code></pre></div></li><li><p>Cargo workspace 里 package 之间的 library crate 依赖：</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-toml data-lang=toml><span style=display:flex><span><span style=color:#60a0b0;font-style:italic># pkg1/Cargo.toml</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>[dependencies]
</span></span><span style=display:flex><span>pkg2 = { path = <span style=color:#4070a0>&#34;../pkg2&#34;</span> }
</span></span></code></pre></div></li><li><p>使用 <code>cargo run -p PKG</code> 和 <code>cargo test -p PKG</code> 局限于单个 package。</p></li><li><p>使用 <code>cargo install PKG</code> 安装 binary crate</p></li><li><p>PATH 里带有 <code>cargo-</code> 前缀的命令都自动成为 <code>cargo</code> 的子命令，可以用这个方式扩展 Cargo。</p></li></ol><h2 id=15-smart-pointers>15. Smart Pointers</h2><ol><li><p>smart pointers 指实现了 trait <code>Deref</code> 和 <code>Drop</code> 的 struct，从这个意义上讲，<code>String</code> 和 <code>Vec</code> 也是。</p><ol><li><code>Box&lt;T></code>: 在堆上分配内存</li><li><code>Rc&lt;T></code>: 引用技术，支持多个 owner</li><li><code>Ref&lt;T></code>, <code>RefMut&lt;T></code> 使用 <code>RefCell&lt;T></code> 访问，运行时应用 borrowing 规则</li></ol></li><li><p>实现一个智能指针</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#007020;font-weight:700>use</span><span style=color:#bbb> </span>std::ops::Deref;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#007020;font-weight:700>struct</span> <span style=color:#0e84b5;font-weight:700>MyBox</span><span style=color:#666>&lt;</span>T<span style=color:#666>&gt;</span>(T);<span style=color:#bbb>		</span><span style=color:#60a0b0;font-style:italic>// 定义 tuple struct
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#007020;font-weight:700>impl</span><span style=color:#666>&lt;</span>T<span style=color:#666>&gt;</span><span style=color:#bbb> </span>Deref<span style=color:#bbb> </span><span style=color:#007020;font-weight:700>for</span><span style=color:#bbb> </span>MyBox<span style=color:#666>&lt;</span>T<span style=color:#666>&gt;</span><span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#007020;font-weight:700>fn</span> <span style=color:#06287e>new</span>(x: <span style=color:#0e84b5;font-weight:700>T</span>)<span style=color:#bbb> </span>-&gt; <span style=color:#0e84b5;font-weight:700>MyBox</span><span style=color:#666>&lt;</span>T<span style=color:#666>&gt;</span><span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>MyBox(x)<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#007020;font-weight:700>type</span> <span style=color:#0e84b5;font-weight:700>Target</span><span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span>T;<span style=color:#bbb>		</span><span style=color:#60a0b0;font-style:italic>// 需要类型
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#007020;font-weight:700>fn</span> <span style=color:#06287e>deref</span>(<span style=color:#666>&amp;</span><span style=color:#007020>self</span>)<span style=color:#bbb> </span>-&gt; <span style=color:#007020>&amp;</span><span style=color:#0e84b5;font-weight:700>T</span><span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:#666>&amp;</span><span style=color:#007020>self</span>.<span style=color:#40a070>0</span><span style=color:#bbb>					</span><span style=color:#60a0b0;font-style:italic>// 返回 tuple 第一个元素的引用
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span><span style=color:#bbb>    </span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>}<span style=color:#bbb>
</span></span></span></code></pre></div></li><li><p>创建 Box<t>:</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#007020;font-weight:700>let</span><span style=color:#bbb> </span>x<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span><span style=color:#007020>Box</span>::new(<span style=color:#007020>String</span>::from(<span style=color:#4070a0>&#34;xxx&#34;</span>));<span style=color:#bbb>
</span></span></span></code></pre></div></li><li><p>隐式的 Deref Coercion：</p><ol><li>From <code>&amp;T</code> to <code>&amp;U</code> when <code>T: Deref</code></li><li>From <code>&amp;mut T</code> to <code>&amp;mut U</code> when <code>T: DerefMut</code></li><li>From <code>&amp;mut T</code> to <code>&amp;U</code> when <code>T: Deref</code></li></ol></li><li><p>使用 <code>drop</code> 函数提前显式地析构对象。</p></li><li><p>引用计数</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#007020;font-weight:700>use</span><span style=color:#bbb> </span>std::rc::Rc;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#007020;font-weight:700>let</span><span style=color:#bbb> </span>x<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span>Rc::new(<span style=color:#007020>String</span>::from(<span style=color:#4070a0>&#34;xxx&#34;</span>));<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#007020;font-weight:700>let</span><span style=color:#bbb> </span>y<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span>Rc::clone(<span style=color:#666>&amp;</span>x);<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#06287e>println!</span>(<span style=color:#4070a0>&#34;y&#39;s strong_count=</span><span style=color:#70a0d0>{}</span><span style=color:#4070a0>&#34;</span>,<span style=color:#bbb> </span>Rc::strong_count(<span style=color:#666>&amp;</span>y));<span style=color:#bbb>
</span></span></span></code></pre></div></li><li><p>Rc<t> 只能用在单线程里，并且只能共享不可变引用。std::cell::RefCell<t> 也只能用在单线程。</p></li><li><p><code>interior mutability</code> 指不可变的类型内部通过 unsafe 代码可以安全的修改数据，<code>RefCell</code> 是一个典型的例子。</p></li><li><p>The reasons to choose <code>Box</code>, <code>Rc</code>, or <code>RefCell</code>:</p><ul><li><code>Rc</code> enables multiple owners of the same data; <code>Box</code> and <code>RefCell</code> have single owners.</li><li><code>Box</code> allows immutable or mutable borrows checked at compile time; <code>Rc</code> allows only immutable borrows checked at compile time; <code>RefCell</code> allows immutable or mutable borrows checked at runtime.</li><li>Because <code>RefCell</code> allows mutable borrows checked at runtime, you can mutate the value inside the <code>RefCell</code> even when the <code>RefCell</code> is immutable.</li></ul></li><li><p><code>RefCell&lt;T>::borrow()</code> 返回 <code>Ref&lt;T></code>， <code>RefCell&lt;T>::borrow_mut()</code>返回 <code>RefMut&lt;T></code>，两个函数可以当作 <code>&</code> 和 <code>&amp;mut</code> 看待。</p></li><li><p><code>Rc&lt;T></code> 用于多个 owner 对同一个数据的只读访问， <code>Rc&lt;RefCell&lt;T>></code>用于多个 owner 对同一个数据的可写访问。</p></li><li><p><code>Rc::downgrade(&amp;Rc&lt;T>)</code> 得到 <code>Weak&lt;T></code> 引用，用 <code>Rc::upgrade(&amp;Weak&lt;T>)</code> 得到 <code>Option&lt;Rc&lt;T>></code>。</p></li></ol><h2 id=16-fearless-concurrency>16. Fearless Concurrency</h2><ol><li><p>新建线程：</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#007020;font-weight:700>use</span><span style=color:#bbb> </span>std::thread;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#007020;font-weight:700>fn</span> <span style=color:#06287e>main</span>()<span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#007020;font-weight:700>let</span><span style=color:#bbb> </span>handle<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span>thread::spawn(<span style=color:#007020;font-weight:700>move</span><span style=color:#bbb> </span><span style=color:#666>||</span><span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#666>..</span>.<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>});<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>handle.join().unwrap();<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>}<span style=color:#bbb>
</span></span></span></code></pre></div></li><li><p>使用 multiple producer, single consumer channel 跨线程通讯</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#007020;font-weight:700>use</span><span style=color:#bbb> </span>std::sync::mpsc;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#007020;font-weight:700>use</span><span style=color:#bbb> </span>std::thread;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#007020;font-weight:700>use</span><span style=color:#bbb> </span>std::time::Duration;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#007020;font-weight:700>fn</span> <span style=color:#06287e>main</span>()<span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#007020;font-weight:700>let</span><span style=color:#bbb> </span>(tx,<span style=color:#bbb> </span>rx)<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span>mpsc::channel();<span style=color:#bbb> </span><span style=color:#60a0b0;font-style:italic>// tx 指 transmiter, rx 指 reciever
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span><span style=color:#bbb>    </span><span style=color:#007020;font-weight:700>let</span><span style=color:#bbb> </span>tx2<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span>mpsc::Sender::clone(<span style=color:#666>&amp;</span>tx);<span style=color:#bbb> </span><span style=color:#60a0b0;font-style:italic>// multiple producer
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>thread::spawn(<span style=color:#007020;font-weight:700>move</span><span style=color:#bbb> </span><span style=color:#666>||</span><span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>tx.send(<span style=color:#007020>String</span>::from(<span style=color:#4070a0>&#34;hello&#34;</span>)).unwrap();<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>thread::sleep(Duration::from_secs(<span style=color:#40a070>1</span>));<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>});<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>thread::spawn(<span style=color:#007020;font-weight:700>move</span><span style=color:#bbb> </span><span style=color:#666>||</span><span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>tx2.send(<span style=color:#007020>String</span>::from(<span style=color:#4070a0>&#34;world&#34;</span>)).unwrap();<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>thread::sleep(Duration::from_secs(<span style=color:#40a070>1</span>));<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>});<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#007020;font-weight:700>let</span><span style=color:#bbb> </span>received<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span>rx.recv().unwrap();<span style=color:#bbb>	</span><span style=color:#60a0b0;font-style:italic>// 阻塞式 recv(), 非阻塞式 try_recv()
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span><span style=color:#bbb>    </span><span style=color:#06287e>println!</span>(<span style=color:#4070a0>&#34;Got: </span><span style=color:#70a0d0>{}</span><span style=color:#4070a0>&#34;</span>,<span style=color:#bbb> </span>received);<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#007020;font-weight:700>for</span><span style=color:#bbb> </span>received<span style=color:#bbb> </span><span style=color:#007020;font-weight:700>in</span><span style=color:#bbb> </span>rx<span style=color:#bbb> </span>{<span style=color:#bbb> </span><span style=color:#60a0b0;font-style:italic>// 迭代器方式
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span><span style=color:#bbb>        </span><span style=color:#06287e>println!</span>(<span style=color:#4070a0>&#34;Got: </span><span style=color:#70a0d0>{}</span><span style=color:#4070a0>&#34;</span>,<span style=color:#bbb> </span>received);<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>}<span style=color:#bbb>
</span></span></span></code></pre></div></li><li><p>类似 <code>Rc&lt;RefCell&lt;T>></code>达到同一个线程里多个owner对同一个数据的内部修改性，使用 <code>Arc&lt;Mutex&lt;T>></code> 达到多个线程对同一个数据的互斥修改：</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#007020;font-weight:700>use</span><span style=color:#bbb> </span>std::sync::{Arc,<span style=color:#bbb> </span>Mutex};<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#007020;font-weight:700>use</span><span style=color:#bbb> </span>std::thread;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#007020;font-weight:700>fn</span> <span style=color:#06287e>main</span>()<span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#60a0b0;font-style:italic>// Arc:  // atomically reference counted type
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span><span style=color:#bbb>    </span><span style=color:#007020;font-weight:700>let</span><span style=color:#bbb> </span>counter<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span>Arc::new(Mutex::new(<span style=color:#40a070>2</span><span style=color:#007020;font-weight:700>i64</span>));<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#007020;font-weight:700>let</span><span style=color:#bbb> </span><span style=color:#007020;font-weight:700>mut</span><span style=color:#bbb> </span>handles<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span><span style=color:#06287e>vec!</span>[];<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#007020;font-weight:700>for</span><span style=color:#bbb> </span>_<span style=color:#bbb> </span><span style=color:#007020;font-weight:700>in</span><span style=color:#bbb> </span><span style=color:#40a070>0</span><span style=color:#666>..</span><span style=color:#40a070>10</span><span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:#007020;font-weight:700>let</span><span style=color:#bbb> </span>counter<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span>Arc::clone(<span style=color:#666>&amp;</span>counter);<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:#007020;font-weight:700>let</span><span style=color:#bbb> </span>handle<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span>thread::spawn(<span style=color:#007020;font-weight:700>move</span><span style=color:#bbb> </span><span style=color:#666>||</span><span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:#007020;font-weight:700>let</span><span style=color:#bbb> </span><span style=color:#007020;font-weight:700>mut</span><span style=color:#bbb> </span>num<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span>counter.lock().unwrap();<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:#666>*</span>num<span style=color:#bbb> </span><span style=color:#666>+=</span><span style=color:#bbb> </span><span style=color:#40a070>2</span>;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>});<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>handles.push(handle);<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#007020;font-weight:700>for</span><span style=color:#bbb> </span>handle<span style=color:#bbb> </span><span style=color:#007020;font-weight:700>in</span><span style=color:#bbb> </span>handles<span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>handle.join().unwrap();<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#06287e>println!</span>(<span style=color:#4070a0>&#34;result=</span><span style=color:#70a0d0>{}</span><span style=color:#4070a0>&#34;</span>,<span style=color:#bbb> </span>counter.lock().unwrap());<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>}<span style=color:#bbb>
</span></span></span></code></pre></div></li><li><p>Trait <code>std::marker::Send</code> 表示一个类型的 ownership 是否可以安全的转到另一个线程里。</p><ul><li>除了原始指针外，其它基本类型都是 <code>Send</code> 。</li><li>成员全是 <code>Send</code> 的复合类型也是 <code>Send</code> 。</li><li><code>Rc&lt;T></code> 和 <code>RefCell&lt;T></code> 不是 <code>Send</code> ，不能跨线程传递。</li></ul></li><li><p>Trait <code>std::marker::Sync</code> 表示一个类型是否可以安全的从多个线程里引用。</p><ul><li>如果 <code>&amp;T</code> 是 <code>Send</code>，那么 <code>T</code> 是 <code>Sync</code>。</li><li>成员全是 <code>Sync</code> 的复合类型也是 <code>Sync</code>。</li><li>基本类型是 <code>Sync</code>。</li><li><code>Rc&lt;T></code>和 <code>RefCell&lt;T></code> 不是 Sync。</li></ul></li></ol><h2 id=17-object-oriented-programming-features-of-rust>17. Object Oriented Programming Features of Rust</h2><ol><li>Rust 的 struct 成员默认是私有的，只能通过方法访问，因此 Rust 具备 OOP 里的封装语义；</li><li>Rust 不支持 OOP 风格的继承来重用代码，只能通过 trait 里的默认方法来实现有限的继承语义；</li><li>trait object 使用 <code>dyn SomeTrait</code> 声明，在使用时需要是引用或者智能指针，比如 <code>Vec&lt;Box&lt;dyn Error>></code>。</li><li>trait object 用来实现 OOP 的运行时多态，采用 dymaic dispatch，也即运行时才能知道调用哪个方法。</li><li>trait object 需要 trait 满足 object safety 约束，最重要的两条：<ul><li>trait 里的方法不能返回 <code>Self</code> 类型，比如 <code>dyn Clone</code> 就不能作为 trait object 使用</li><li>trait 里不能有泛型参数</li></ul></li></ol><h2 id=18-patterns-and-matching>18. Patterns and Matching</h2><ol><li><p>可以使用模式匹配的地方：</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#007020;font-weight:700>match</span><span style=color:#bbb> </span><span style=color:#60add5>VALUE</span><span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#60add5>PATTERN</span><span style=color:#bbb> </span><span style=color:#666>=&gt;</span><span style=color:#bbb> </span><span style=color:#60add5>EXPRESSION</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#60add5>PATTERN</span><span style=color:#bbb> </span><span style=color:#666>=&gt;</span><span style=color:#bbb> </span><span style=color:#60add5>EXPRESSION</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#60add5>PATTERN</span><span style=color:#bbb> </span><span style=color:#666>=&gt;</span><span style=color:#bbb> </span><span style=color:#60add5>EXPRESSION</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#007020;font-weight:700>if</span><span style=color:#bbb> </span><span style=color:#007020;font-weight:700>let</span><span style=color:#bbb> </span><span style=color:#60add5>PATTERN</span><span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span><span style=color:#60add5>EXPRESSION</span><span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#007020;font-weight:700>while</span><span style=color:#bbb> </span><span style=color:#007020;font-weight:700>let</span><span style=color:#bbb> </span><span style=color:#60add5>PATTERN</span><span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span><span style=color:#60add5>EXPRESSION</span><span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#007020;font-weight:700>for</span><span style=color:#bbb> </span><span style=color:#60add5>PATTERN</span><span style=color:#bbb> </span><span style=color:#007020;font-weight:700>in</span><span style=color:#bbb> </span><span style=color:#60add5>EXPRESSION</span><span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#007020;font-weight:700>let</span><span style=color:#bbb> </span><span style=color:#60add5>PATTERN</span><span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span><span style=color:#60add5>EXPRESSION</span>;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#007020;font-weight:700>fn</span> <span style=color:#06287e>print_coordinates</span>(<span style=color:#666>&amp;</span>(x,<span style=color:#bbb> </span>y): <span style=color:#007020>&amp;</span>(<span style=color:#902000>i32</span>,<span style=color:#bbb> </span><span style=color:#902000>i32</span>))<span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#06287e>println!</span>(<span style=color:#4070a0>&#34;Current location: (</span><span style=color:#70a0d0>{}</span><span style=color:#4070a0>, </span><span style=color:#70a0d0>{}</span><span style=color:#4070a0>)&#34;</span>,<span style=color:#bbb> </span>x,<span style=color:#bbb> </span>y);<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>}<span style=color:#bbb>
</span></span></span></code></pre></div></li><li><p>PATTERN 的语法</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span>P1<span style=color:#bbb> </span><span style=color:#666>|</span><span style=color:#bbb> </span>P2<span style=color:#bbb>      </span><span>表示「或」</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#40a070>1</span><span style=color:#666>..=</span><span style=color:#40a070>5</span><span style=color:#bbb>				 </span><span>表示闭区间，只适用于整数和</span><span style=color:#902000>char</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#007020;font-weight:700>let</span><span style=color:#bbb> </span>Point<span style=color:#bbb> </span>{x: <span style=color:#0e84b5;font-weight:700>a</span>,<span style=color:#bbb> </span>y: <span style=color:#0e84b5;font-weight:700>b</span>}<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span>Point<span style=color:#bbb> </span>{x: <span style=color:#40a070>1</span>,<span style=color:#bbb> </span>y: <span style=color:#40a070>2</span>};<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#007020;font-weight:700>let</span><span style=color:#bbb> </span>Point<span style=color:#bbb> </span>{x,<span style=color:#bbb> </span>y}<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span>Point<span style=color:#bbb> </span>{x: <span style=color:#40a070>1</span>,<span style=color:#bbb> </span>y: <span style=color:#40a070>2</span>};<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>_<span style=color:#bbb>    				 </span><span>忽略</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>_x<span style=color:#bbb>				   </span><span>绑定，忽略未使用变量</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#666>..</span><span style=color:#bbb>			     </span><span>忽略剩余部分</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#60a0b0;font-style:italic>// match guard
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span><span style=color:#007020;font-weight:700>match</span><span style=color:#bbb> </span><span style=color:#60add5>VALUE</span><span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#60add5>PATTERN</span><span style=color:#bbb> </span><span style=color:#007020;font-weight:700>if</span><span style=color:#bbb> </span><span style=color:#60add5>CONDITION</span><span style=color:#bbb> </span><span style=color:#666>=&gt;</span><span style=color:#bbb> </span><span style=color:#60add5>EXPRESSION</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#60a0b0;font-style:italic>// 使用 @ 在匹配时赋值
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span><span style=color:#007020;font-weight:700>enum</span> <span style=color:#0e84b5;font-weight:700>Message</span><span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>Hello<span style=color:#bbb> </span>{<span style=color:#bbb> </span>id: <span style=color:#902000>i32</span> },<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#007020;font-weight:700>let</span><span style=color:#bbb> </span>msg<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span>Message::Hello<span style=color:#bbb> </span>{<span style=color:#bbb> </span>id: <span style=color:#40a070>5</span><span style=color:#bbb> </span>};<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#007020;font-weight:700>match</span><span style=color:#bbb> </span>msg<span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>Message::Hello<span style=color:#bbb> </span>{<span style=color:#bbb> </span>id: <span style=color:#0e84b5;font-weight:700>id_variable</span><span style=color:#bbb> </span><span style=color:#666>@</span><span style=color:#bbb> </span><span style=color:#40a070>3</span><span style=color:#666>..=</span><span style=color:#40a070>7</span><span style=color:#bbb> </span>}<span style=color:#bbb> </span><span style=color:#666>=&gt;</span><span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:#06287e>println!</span>(<span style=color:#4070a0>&#34;Found an id in range: </span><span style=color:#70a0d0>{}</span><span style=color:#4070a0>&#34;</span>,<span style=color:#bbb> </span>id_variable)<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>},<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>Message::Hello<span style=color:#bbb> </span>{<span style=color:#bbb> </span>id: <span style=color:#40a070>10</span><span style=color:#666>..=</span><span style=color:#40a070>12</span><span style=color:#bbb> </span>}<span style=color:#bbb> </span><span style=color:#666>=&gt;</span><span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:#06287e>println!</span>(<span style=color:#4070a0>&#34;Found an id in another range&#34;</span>)<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>},<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>Message::Hello<span style=color:#bbb> </span>{<span style=color:#bbb> </span>id<span style=color:#bbb> </span>}<span style=color:#bbb> </span><span style=color:#666>=&gt;</span><span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:#06287e>println!</span>(<span style=color:#4070a0>&#34;Found some other id: </span><span style=color:#70a0d0>{}</span><span style=color:#4070a0>&#34;</span>,<span style=color:#bbb> </span>id)<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>},<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>}<span style=color:#bbb>
</span></span></span></code></pre></div></li></ol><h2 id=19-advanced-features>19. Advanced Features</h2><ol><li><p><code>unsafe</code> 可以获得额外的能力：</p><ul><li>Dereference a raw pointer</li><li>Call an unsafe function or method</li><li>Access or modify a mutable static variable</li><li>Implement an unsafe trait</li><li>Access fields of <code>union</code>s</li></ul></li><li><p>trait 关联类型，默认泛型参数，操作符重载：</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#007020;font-weight:700>use</span><span style=color:#bbb> </span>std::ops::Add;<span style=color:#bbb>	</span><span style=color:#60a0b0;font-style:italic>// std::ops 中的操作符可以重载
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#60a0b0;font-style:italic>/*
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic>trait Add&lt;RHS=Self&gt; {	// 默认泛型参数
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic>    type Output;    	// 关联类型
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic>
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic>    fn add(self, rhs: RHS) -&gt; Self::Output;
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic>}
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic>*/</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#007020>#[derive(Debug, PartialEq)]</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#007020;font-weight:700>struct</span> <span style=color:#0e84b5;font-weight:700>Point</span><span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>x: <span style=color:#902000>i32</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>y: <span style=color:#902000>i32</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#007020;font-weight:700>impl</span><span style=color:#bbb> </span>Add<span style=color:#bbb> </span><span style=color:#007020;font-weight:700>for</span><span style=color:#bbb> </span>Point<span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#007020;font-weight:700>type</span> <span style=color:#0e84b5;font-weight:700>Output</span><span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span>Point;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#007020;font-weight:700>fn</span> <span style=color:#06287e>add</span>(<span style=color:#007020>self</span>,<span style=color:#bbb> </span>other: <span style=color:#0e84b5;font-weight:700>Point</span>)<span style=color:#bbb> </span>-&gt; <span style=color:#0e84b5;font-weight:700>Point</span><span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>Point<span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span>x: <span style=color:#0e84b5;font-weight:700>self</span>.x<span style=color:#bbb> </span><span style=color:#666>+</span><span style=color:#bbb> </span>other.x,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span>y: <span style=color:#0e84b5;font-weight:700>self</span>.y<span style=color:#bbb> </span><span style=color:#666>+</span><span style=color:#bbb> </span>other.y,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>}<span style=color:#bbb>
</span></span></span></code></pre></div></li><li><p>使用方法全名来区分 struct 以及实现的 trait 的同名函数</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#007020;font-weight:700>struct</span> <span style=color:#0e84b5;font-weight:700>Dog</span>;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#007020;font-weight:700>trait</span><span style=color:#bbb> </span>Animal<span style=color:#bbb> </span>{<span style=color:#bbb> </span><span style=color:#666>..</span>.<span style=color:#bbb> </span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#007020;font-weight:700>let</span><span style=color:#bbb> </span>dog<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span>Dog;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>dog.method()<span style=color:#bbb>		</span><span style=color:#60a0b0;font-style:italic>// 调用 Dog struct 上直接 impl 的方法 fn method(&amp;self)
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span>Animal::method(<span style=color:#666>&amp;</span>dog)<span style=color:#bbb>	</span><span style=color:#60a0b0;font-style:italic>// 调用 Dog struct 上 impl Animal 的方法 fn method(&amp;self)
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>Dog::func()<span style=color:#bbb>			</span><span style=color:#60a0b0;font-style:italic>// 调用 Dog struct 上直接 impl 的函数 fn func()
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span><span style=color:#666>&lt;</span>Dog<span style=color:#bbb> </span><span style=color:#007020;font-weight:700>as</span><span style=color:#bbb> </span>Animal<span style=color:#666>&gt;</span>::func()<span style=color:#bbb>	</span><span style=color:#60a0b0;font-style:italic>// 调用 Dog struct 上 impl Animal 的函数 fn func()
</span></span></span></code></pre></div></li><li><p>supertrait</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#007020;font-weight:700>trait</span><span style=color:#bbb> </span>B: <span style=color:#0e84b5;font-weight:700>A</span><span style=color:#bbb> </span>{<span style=color:#bbb> </span><span style=color:#666>..</span>.<span style=color:#bbb> </span>}<span style=color:#bbb>   </span><span style=color:#60a0b0;font-style:italic>// 实现了 trait B 的 struct 必须也要实现 trait A
</span></span></span></code></pre></div></li><li><p><code>impl Trait on Type</code> 只有当 Trait 和 Type 至少有一个是当前 crate 定义的时才被允许，如果 Trait 和 Type 都是外部 crate 的，要想扩展 Type 则需要使用 newtype 模式，也就在包装的 tuple struct 类型上实现 trait，Rust 编译器在编译时会自动消除这层包装。如果想要 wrapper 类型包含目标类型的所有方法，则可以实现 <code>Deref</code> trait。</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#007020;font-weight:700>use</span><span style=color:#bbb> </span>std::fmt;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#007020;font-weight:700>struct</span> <span style=color:#0e84b5;font-weight:700>Wrapper</span>(<span style=color:#007020>Vec</span><span style=color:#666>&lt;</span><span style=color:#007020>String</span><span style=color:#666>&gt;</span>);<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#007020;font-weight:700>impl</span><span style=color:#bbb> </span>fmt::Display<span style=color:#bbb> </span><span style=color:#007020;font-weight:700>for</span><span style=color:#bbb> </span>Wrapper<span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#007020;font-weight:700>fn</span> <span style=color:#06287e>fmt</span>(<span style=color:#666>&amp;</span><span style=color:#007020>self</span>,<span style=color:#bbb> </span>f: <span style=color:#007020>&amp;</span><span style=color:#0e84b5;font-weight:700>mut</span><span style=color:#bbb> </span>fmt::Formatter)<span style=color:#bbb> </span>-&gt; <span style=color:#0e84b5;font-weight:700>fmt</span>::<span style=color:#007020>Result</span><span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:#06287e>write!</span>(f,<span style=color:#bbb> </span><span style=color:#4070a0>&#34;[{}]&#34;</span>,<span style=color:#bbb> </span><span style=color:#007020>self</span>.<span style=color:#40a070>0.</span>join(<span style=color:#4070a0>&#34;, &#34;</span>))<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#007020;font-weight:700>fn</span> <span style=color:#06287e>main</span>()<span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#007020;font-weight:700>let</span><span style=color:#bbb> </span>w<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span>Wrapper(<span style=color:#06287e>vec!</span>[<span style=color:#007020>String</span>::from(<span style=color:#4070a0>&#34;hello&#34;</span>),<span style=color:#bbb> </span><span style=color:#007020>String</span>::from(<span style=color:#4070a0>&#34;world&#34;</span>)]);<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#06287e>println!</span>(<span style=color:#4070a0>&#34;w = </span><span style=color:#70a0d0>{}</span><span style=color:#4070a0>&#34;</span>,<span style=color:#bbb> </span>w);<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>}<span style=color:#bbb>
</span></span></span></code></pre></div></li><li><p>type alias: <code>type Result&lt;T> = std::result::Result&lt;T, std::io::Error>;</code></p></li><li><p>never type: <code>!</code> 表示 empty type，比如在 match 的某个分支里使用 <code>continue</code> 或者 <code>panic!</code>，这个分支的返回值类型就是 <code>!</code>，比如在函数里有无限循环 <code>loop { ... }</code>，此函数的返回值类型就是 <code>!</code>。</p></li><li><p>trait <code>Sized</code> 表示编译时知道类型大小，特殊语法 <code>?Sized</code> 表示可能知道也可能不知道类型大小。</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#007020;font-weight:700>fn</span> <span style=color:#06287e>foo</span><span style=color:#666>&lt;</span>T<span style=color:#666>&gt;</span>(t: <span style=color:#0e84b5;font-weight:700>T</span>)<span style=color:#bbb> </span>{}<span style=color:#bbb> </span><span style=color:#60a0b0;font-style:italic>// 相当于 fn foo&lt;T: Sized&gt;(t: T) {}
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span><span style=color:#007020;font-weight:700>fn</span> <span style=color:#06287e>bar</span><span style=color:#666>&lt;</span>T: <span style=color:#666>?</span><span style=color:#007020>Sized</span><span style=color:#666>&gt;</span>(t: <span style=color:#007020>&amp;</span><span style=color:#0e84b5;font-weight:700>T</span>)<span style=color:#bbb> </span>{}<span style=color:#bbb>   </span><span style=color:#60a0b0;font-style:italic>// 由于 T 的大小未知，所以用 &amp;T 类型作为参数，也可以用 Box&lt;T&gt;
</span></span></span></code></pre></div></li><li><p>function pointer: <code>fn(n: i32) -> i32</code>，可以省略参数名字，function pointer 实现了 closure trait <code>Fn</code>, <code>FnMut</code>, <code>FnOnce</code>，所以在以函数作为参数时，推荐使用 closure trait 以支持 function pointer 和 closure 两种。但在与 C 语言交互时，只能使用 function pointer，因为 C 语言不支持 closure。</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#007020;font-weight:700>fn</span> <span style=color:#06287e>foo</span>(f: <span style=color:#0e84b5;font-weight:700>impl</span><span style=color:#bbb> </span><span style=color:#007020>Fn</span>(<span style=color:#902000>i32</span>)<span style=color:#bbb> </span>-&gt; <span style=color:#902000>i32</span>,<span style=color:#bbb> </span>n: <span style=color:#902000>i32</span>)<span style=color:#bbb> </span>-&gt; <span style=color:#902000>i32</span> {<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>f(n)<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#60a0b0;font-style:italic>// 返回 closure：
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic>// 第一种返回 trait object，允许函数里不同分支返回不同具体类型的closure 或者函数指针;
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic>// 第二种和第三种类似，只能返回一种具体类型
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic>// 由于 Box 实现了 Deref trait，所以使用上都可以写 foo()(12)
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span><span style=color:#007020;font-weight:700>fn</span> <span style=color:#06287e>foo</span>()<span style=color:#bbb> </span>-&gt; <span style=color:#007020>Box</span><span style=color:#666>&lt;</span><span style=color:#007020;font-weight:700>dyn</span><span style=color:#bbb> </span><span style=color:#007020>Fn</span>(<span style=color:#902000>i32</span>)<span style=color:#bbb> </span>-&gt; <span style=color:#902000>i32</span><span style=color:#666>&gt;</span><span style=color:#bbb> </span>{<span style=color:#bbb> </span><span style=color:#007020>Box</span>::new(<span style=color:#666>|</span>x<span style=color:#666>|</span><span style=color:#bbb> </span>x<span style=color:#bbb> </span><span style=color:#666>+</span><span style=color:#bbb> </span>x)<span style=color:#bbb> </span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#007020;font-weight:700>fn</span> <span style=color:#06287e>foo</span>()<span style=color:#bbb> </span>-&gt; <span style=color:#0e84b5;font-weight:700>impl</span><span style=color:#bbb> </span><span style=color:#007020>Fn</span>(<span style=color:#902000>i32</span>)<span style=color:#bbb> </span>-&gt; <span style=color:#902000>i32</span> {<span style=color:#bbb> </span><span style=color:#007020>Box</span>::new(<span style=color:#666>|</span>x<span style=color:#666>|</span><span style=color:#bbb> </span>x<span style=color:#bbb> </span><span style=color:#666>+</span><span style=color:#bbb> </span>x)<span style=color:#bbb> </span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#007020;font-weight:700>fn</span> <span style=color:#06287e>foo</span>()<span style=color:#bbb> </span>-&gt; <span style=color:#0e84b5;font-weight:700>impl</span><span style=color:#bbb> </span><span style=color:#007020>Fn</span>(<span style=color:#902000>i32</span>)<span style=color:#bbb> </span>-&gt; <span style=color:#902000>i32</span> {<span style=color:#bbb> </span><span style=color:#666>|</span>x<span style=color:#666>|</span><span style=color:#bbb> </span>x<span style=color:#bbb> </span><span style=color:#666>+</span><span style=color:#bbb> </span>x<span style=color:#bbb> </span>}<span style=color:#bbb>
</span></span></span></code></pre></div></li><li><p>declarative macro, aka macro by example, aka pattern macro</p><ul><li><code>macro_rules!</code>将被废弃，新的设计参考：<ul><li><a href=https://github.com/rust-lang/rfcs/blob/master/text/1584-macros.md>https://github.com/rust-lang/rfcs/blob/master/text/1584-macros.md</a></li><li><a href=https://github.com/rust-lang/rfcs/blob/master/text/1681-macros-1.1.md>https://github.com/rust-lang/rfcs/blob/master/text/1681-macros-1.1.md</a></li></ul></li></ul></li><li><p>procedural macro, aka syntax extension, aka compiler plugin</p><ul><li>custom <code>#[derive]</code> macro</li><li>attribute-like macro</li><li>function-like macro</li></ul></li></ol><hr><p>Cheat sheets:</p><ol><li><a href=https://cheats.rs/>https://cheats.rs/</a></li><li><a href=https://upsuper.github.io/rust-cheatsheet/>https://upsuper.github.io/rust-cheatsheet/</a></li></ol></div></div></div><div class="pure-u-1-24 pure-u-md-2-24 pure-u-lg-5-24"></div></div><div class="footer pure-g"><div class="pure-u-1-24 pure-u-md-2-24 pure-u-lg-5-24"></div><div class="pure-u-11-12 pure-u-md-20-24 pure-u-lg-7-12"><div class=footer-content><div class="pure-menu pure-menu-horizontal"><ul><li class=pure-menu-item id=foot-name>© Yubao Liu</li></ul><a href=# class="pure-menu-link pull-right" id=gototop-btn>↑↑</a></div></div></div><div class="pure-u-1-24 pure-u-md-2-24 pure-u-lg-5-24"></div></div><script type=text/javascript>go(),window.addEventListener("resize",go);function go(){var e=document.querySelector(".desktop");document.documentElement.clientWidth>768?e.style.display="":e.style.display="none"}</script><script type=text/javascript>var a=document.querySelector("#toggle-btn"),b=document.querySelector("#toggle-content");a.addEventListener("click",function(){""==b.style.display?(b.style.display="none",a.innerHTML="☰"):(b.style.display="",a.innerHTML="X")})</script></body></html>