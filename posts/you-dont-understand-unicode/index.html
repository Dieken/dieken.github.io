<!doctype html><html lang=en><head><meta charset=utf-8><title>其实你并不懂 Unicode</title><meta name=description content="其实你并不懂 Unicode"><meta name=author content="Yubao Liu"><meta name=viewport content="width=device-width,initial-scale=1"><noscript><link href="//fonts.googleapis.com/css?family=Source+Sans+Pro:400,600" rel=stylesheet type=text/css><link rel=stylesheet href=/css/fonts.css></noscript><style type=text/css media=screen>/*!Pure v3.0.0
Copyright 2013 Yahoo!
Licensed under the BSD License.
https://github.com/pure-css/pure/blob/master/LICENSE*//*!normalize.css v | MIT License | https://necolas.github.io/normalize.css/
Copyright (c) Nicolas Gallagher and Jonathan Neal*//*!normalize.css v8.0.1 | MIT License | github.com/necolas/normalize.css*/html{line-height:1.15;-webkit-text-size-adjust:100%}body{margin:0}main{display:block}h1{font-size:2em;margin:.67em 0}hr{box-sizing:content-box;height:0;overflow:visible}pre{font-family:monospace,monospace;font-size:1em}a{background-color:transparent}abbr[title]{border-bottom:none;text-decoration:underline;-webkit-text-decoration:underline dotted;text-decoration:underline dotted}b,strong{font-weight:bolder}code,kbd,samp{font-family:monospace,monospace;font-size:1em}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}img{border-style:none}button,input,optgroup,select,textarea{font-family:inherit;font-size:100%;line-height:1.15;margin:0}button,input{overflow:visible}button,select{text-transform:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}[type=button]::-moz-focus-inner,[type=reset]::-moz-focus-inner,[type=submit]::-moz-focus-inner,button::-moz-focus-inner{border-style:none;padding:0}[type=button]:-moz-focusring,[type=reset]:-moz-focusring,[type=submit]:-moz-focusring,button:-moz-focusring{outline:1px dotted ButtonText}fieldset{padding:.35em .75em .625em}legend{box-sizing:border-box;color:inherit;display:table;max-width:100%;padding:0;white-space:normal}progress{vertical-align:baseline}textarea{overflow:auto}[type=checkbox],[type=radio]{box-sizing:border-box;padding:0}[type=number]::-webkit-inner-spin-button,[type=number]::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}[type=search]::-webkit-search-decoration{-webkit-appearance:none}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}details{display:block}summary{display:list-item}template{display:none}[hidden]{display:none}html{font-family:sans-serif}.hidden,[hidden]{display:none !important}.pure-img{max-width:100%;height:auto;display:block}</style><style type=text/css media=screen>/*!Pure v3.0.0
Copyright 2013 Yahoo!
Licensed under the BSD License.
https://github.com/pure-css/pure/blob/master/LICENSE*/.pure-menu{box-sizing:border-box}.pure-menu-fixed{position:fixed;left:0;top:0;z-index:3}.pure-menu-item,.pure-menu-list{position:relative}.pure-menu-list{list-style:none;margin:0;padding:0}.pure-menu-item{padding:0;margin:0;height:100%}.pure-menu-heading,.pure-menu-link{display:block;text-decoration:none;white-space:nowrap}.pure-menu-horizontal{width:100%;white-space:nowrap}.pure-menu-horizontal .pure-menu-list{display:inline-block}.pure-menu-horizontal .pure-menu-heading,.pure-menu-horizontal .pure-menu-item,.pure-menu-horizontal .pure-menu-separator{display:inline-block;vertical-align:middle}.pure-menu-item .pure-menu-item{display:block}.pure-menu-children{display:none;position:absolute;left:100%;top:0;margin:0;padding:0;z-index:3}.pure-menu-horizontal .pure-menu-children{left:0;top:auto;width:inherit}.pure-menu-active>.pure-menu-children,.pure-menu-allow-hover:hover>.pure-menu-children{display:block;position:absolute}.pure-menu-has-children>.pure-menu-link:after{padding-left:.5em;content:"\25B8";font-size:small}.pure-menu-horizontal .pure-menu-has-children>.pure-menu-link:after{content:"\25BE"}.pure-menu-scrollable{overflow-y:scroll;overflow-x:hidden}.pure-menu-scrollable .pure-menu-list{display:block}.pure-menu-horizontal.pure-menu-scrollable .pure-menu-list{display:inline-block}.pure-menu-horizontal.pure-menu-scrollable{white-space:nowrap;overflow-y:hidden;overflow-x:auto;padding:.5em 0}.pure-menu-horizontal .pure-menu-children .pure-menu-separator,.pure-menu-separator{background-color:#ccc;height:1px;margin:.3em 0}.pure-menu-horizontal .pure-menu-separator{width:1px;height:1.3em;margin:0 .3em}.pure-menu-horizontal .pure-menu-children .pure-menu-separator{display:block;width:auto}.pure-menu-heading{text-transform:uppercase;color:#565d64}.pure-menu-link{color:#777}.pure-menu-children{background-color:#fff}.pure-menu-heading,.pure-menu-link{padding:.5em 1em}.pure-menu-disabled{opacity:.5}.pure-menu-disabled .pure-menu-link:hover{background-color:transparent;cursor:default}.pure-menu-active>.pure-menu-link,.pure-menu-link:focus,.pure-menu-link:hover{background-color:#eee}.pure-menu-selected>.pure-menu-link,.pure-menu-selected>.pure-menu-link:visited{color:#000}</style><style type=text/css media=screen>/*!Pure v3.0.0
Copyright 2013 Yahoo!
Licensed under the BSD License.
https://github.com/pure-css/pure/blob/master/LICENSE*/.pure-g{display:flex;flex-flow:row wrap;align-content:flex-start}.pure-u{display:inline-block;vertical-align:top}.pure-u-1,.pure-u-1-1,.pure-u-1-12,.pure-u-1-2,.pure-u-1-24,.pure-u-1-3,.pure-u-1-4,.pure-u-1-5,.pure-u-1-6,.pure-u-1-8,.pure-u-10-24,.pure-u-11-12,.pure-u-11-24,.pure-u-12-24,.pure-u-13-24,.pure-u-14-24,.pure-u-15-24,.pure-u-16-24,.pure-u-17-24,.pure-u-18-24,.pure-u-19-24,.pure-u-2-24,.pure-u-2-3,.pure-u-2-5,.pure-u-20-24,.pure-u-21-24,.pure-u-22-24,.pure-u-23-24,.pure-u-24-24,.pure-u-3-24,.pure-u-3-4,.pure-u-3-5,.pure-u-3-8,.pure-u-4-24,.pure-u-4-5,.pure-u-5-12,.pure-u-5-24,.pure-u-5-5,.pure-u-5-6,.pure-u-5-8,.pure-u-6-24,.pure-u-7-12,.pure-u-7-24,.pure-u-7-8,.pure-u-8-24,.pure-u-9-24{display:inline-block;letter-spacing:normal;word-spacing:normal;vertical-align:top;text-rendering:auto}.pure-u-1-24{width:4.1667%}.pure-u-1-12,.pure-u-2-24{width:8.3333%}.pure-u-1-8,.pure-u-3-24{width:12.5%}.pure-u-1-6,.pure-u-4-24{width:16.6667%}.pure-u-1-5{width:20%}.pure-u-5-24{width:20.8333%}.pure-u-1-4,.pure-u-6-24{width:25%}.pure-u-7-24{width:29.1667%}.pure-u-1-3,.pure-u-8-24{width:33.3333%}.pure-u-3-8,.pure-u-9-24{width:37.5%}.pure-u-2-5{width:40%}.pure-u-10-24,.pure-u-5-12{width:41.6667%}.pure-u-11-24{width:45.8333%}.pure-u-1-2,.pure-u-12-24{width:50%}.pure-u-13-24{width:54.1667%}.pure-u-14-24,.pure-u-7-12{width:58.3333%}.pure-u-3-5{width:60%}.pure-u-15-24,.pure-u-5-8{width:62.5%}.pure-u-16-24,.pure-u-2-3{width:66.6667%}.pure-u-17-24{width:70.8333%}.pure-u-18-24,.pure-u-3-4{width:75%}.pure-u-19-24{width:79.1667%}.pure-u-4-5{width:80%}.pure-u-20-24,.pure-u-5-6{width:83.3333%}.pure-u-21-24,.pure-u-7-8{width:87.5%}.pure-u-11-12,.pure-u-22-24{width:91.6667%}.pure-u-23-24{width:95.8333%}.pure-u-1,.pure-u-1-1,.pure-u-24-24,.pure-u-5-5{width:100%}</style><style type=text/css media=screen>/*!Pure v3.0.0
Copyright 2013 Yahoo!
Licensed under the BSD License.
https://github.com/pure-css/pure/blob/master/LICENSE*/.pure-table{border-collapse:collapse;border-spacing:0;empty-cells:show;border:1px solid #cbcbcb}.pure-table caption{color:#000;font:italic 85%/1 arial,sans-serif;padding:1em 0;text-align:center}.pure-table td,.pure-table th{border-left:1px solid #cbcbcb;border-width:0 0 0 1px;font-size:inherit;margin:0;overflow:visible;padding:.5em 1em}.pure-table thead{background-color:#e0e0e0;color:#000;text-align:left;vertical-align:bottom}.pure-table td{background-color:transparent}.pure-table-odd td{background-color:#f2f2f2}.pure-table-striped tr:nth-child(2n-1) td{background-color:#f2f2f2}.pure-table-bordered td{border-bottom:1px solid #cbcbcb}.pure-table-bordered tbody>tr:last-child>td{border-bottom-width:0}.pure-table-horizontal td,.pure-table-horizontal th{border-width:0 0 1px;border-bottom:1px solid #cbcbcb}.pure-table-horizontal tbody>tr:last-child>td{border-bottom-width:0}</style><style type=text/css media=screen>/*!Pure v1.0.0
Copyright 2013 Yahoo!
Licensed under the BSD License.
https://github.com/yahoo/pure/blob/master/LICENSE.md*/@media screen and (min-width:35.5em){.pure-u-sm-1,.pure-u-sm-1-1,.pure-u-sm-1-12,.pure-u-sm-1-2,.pure-u-sm-1-24,.pure-u-sm-1-3,.pure-u-sm-1-4,.pure-u-sm-1-5,.pure-u-sm-1-6,.pure-u-sm-1-8,.pure-u-sm-10-24,.pure-u-sm-11-12,.pure-u-sm-11-24,.pure-u-sm-12-24,.pure-u-sm-13-24,.pure-u-sm-14-24,.pure-u-sm-15-24,.pure-u-sm-16-24,.pure-u-sm-17-24,.pure-u-sm-18-24,.pure-u-sm-19-24,.pure-u-sm-2-24,.pure-u-sm-2-3,.pure-u-sm-2-5,.pure-u-sm-20-24,.pure-u-sm-21-24,.pure-u-sm-22-24,.pure-u-sm-23-24,.pure-u-sm-24-24,.pure-u-sm-3-24,.pure-u-sm-3-4,.pure-u-sm-3-5,.pure-u-sm-3-8,.pure-u-sm-4-24,.pure-u-sm-4-5,.pure-u-sm-5-12,.pure-u-sm-5-24,.pure-u-sm-5-5,.pure-u-sm-5-6,.pure-u-sm-5-8,.pure-u-sm-6-24,.pure-u-sm-7-12,.pure-u-sm-7-24,.pure-u-sm-7-8,.pure-u-sm-8-24,.pure-u-sm-9-24{display:inline-block;zoom:1;letter-spacing:normal;word-spacing:normal;vertical-align:top;text-rendering:auto}.pure-u-sm-1-24{width:4.1667%}.pure-u-sm-1-12,.pure-u-sm-2-24{width:8.3333%}.pure-u-sm-1-8,.pure-u-sm-3-24{width:12.5%}.pure-u-sm-1-6,.pure-u-sm-4-24{width:16.6667%}.pure-u-sm-1-5{width:20%}.pure-u-sm-5-24{width:20.8333%}.pure-u-sm-1-4,.pure-u-sm-6-24{width:25%}.pure-u-sm-7-24{width:29.1667%}.pure-u-sm-1-3,.pure-u-sm-8-24{width:33.3333%}.pure-u-sm-3-8,.pure-u-sm-9-24{width:37.5%}.pure-u-sm-2-5{width:40%}.pure-u-sm-10-24,.pure-u-sm-5-12{width:41.6667%}.pure-u-sm-11-24{width:45.8333%}.pure-u-sm-1-2,.pure-u-sm-12-24{width:50%}.pure-u-sm-13-24{width:54.1667%}.pure-u-sm-14-24,.pure-u-sm-7-12{width:58.3333%}.pure-u-sm-3-5{width:60%}.pure-u-sm-15-24,.pure-u-sm-5-8{width:62.5%}.pure-u-sm-16-24,.pure-u-sm-2-3{width:66.6667%}.pure-u-sm-17-24{width:70.8333%}.pure-u-sm-18-24,.pure-u-sm-3-4{width:75%}.pure-u-sm-19-24{width:79.1667%}.pure-u-sm-4-5{width:80%}.pure-u-sm-20-24,.pure-u-sm-5-6{width:83.3333%}.pure-u-sm-21-24,.pure-u-sm-7-8{width:87.5%}.pure-u-sm-11-12,.pure-u-sm-22-24{width:91.6667%}.pure-u-sm-23-24{width:95.8333%}.pure-u-sm-1,.pure-u-sm-1-1,.pure-u-sm-24-24,.pure-u-sm-5-5{width:100%}}@media screen and (min-width:48em){.pure-u-md-1,.pure-u-md-1-1,.pure-u-md-1-12,.pure-u-md-1-2,.pure-u-md-1-24,.pure-u-md-1-3,.pure-u-md-1-4,.pure-u-md-1-5,.pure-u-md-1-6,.pure-u-md-1-8,.pure-u-md-10-24,.pure-u-md-11-12,.pure-u-md-11-24,.pure-u-md-12-24,.pure-u-md-13-24,.pure-u-md-14-24,.pure-u-md-15-24,.pure-u-md-16-24,.pure-u-md-17-24,.pure-u-md-18-24,.pure-u-md-19-24,.pure-u-md-2-24,.pure-u-md-2-3,.pure-u-md-2-5,.pure-u-md-20-24,.pure-u-md-21-24,.pure-u-md-22-24,.pure-u-md-23-24,.pure-u-md-24-24,.pure-u-md-3-24,.pure-u-md-3-4,.pure-u-md-3-5,.pure-u-md-3-8,.pure-u-md-4-24,.pure-u-md-4-5,.pure-u-md-5-12,.pure-u-md-5-24,.pure-u-md-5-5,.pure-u-md-5-6,.pure-u-md-5-8,.pure-u-md-6-24,.pure-u-md-7-12,.pure-u-md-7-24,.pure-u-md-7-8,.pure-u-md-8-24,.pure-u-md-9-24{display:inline-block;zoom:1;letter-spacing:normal;word-spacing:normal;vertical-align:top;text-rendering:auto}.pure-u-md-1-24{width:4.1667%}.pure-u-md-1-12,.pure-u-md-2-24{width:8.3333%}.pure-u-md-1-8,.pure-u-md-3-24{width:12.5%}.pure-u-md-1-6,.pure-u-md-4-24{width:16.6667%}.pure-u-md-1-5{width:20%}.pure-u-md-5-24{width:20.8333%}.pure-u-md-1-4,.pure-u-md-6-24{width:25%}.pure-u-md-7-24{width:29.1667%}.pure-u-md-1-3,.pure-u-md-8-24{width:33.3333%}.pure-u-md-3-8,.pure-u-md-9-24{width:37.5%}.pure-u-md-2-5{width:40%}.pure-u-md-10-24,.pure-u-md-5-12{width:41.6667%}.pure-u-md-11-24{width:45.8333%}.pure-u-md-1-2,.pure-u-md-12-24{width:50%}.pure-u-md-13-24{width:54.1667%}.pure-u-md-14-24,.pure-u-md-7-12{width:58.3333%}.pure-u-md-3-5{width:60%}.pure-u-md-15-24,.pure-u-md-5-8{width:62.5%}.pure-u-md-16-24,.pure-u-md-2-3{width:66.6667%}.pure-u-md-17-24{width:70.8333%}.pure-u-md-18-24,.pure-u-md-3-4{width:75%}.pure-u-md-19-24{width:79.1667%}.pure-u-md-4-5{width:80%}.pure-u-md-20-24,.pure-u-md-5-6{width:83.3333%}.pure-u-md-21-24,.pure-u-md-7-8{width:87.5%}.pure-u-md-11-12,.pure-u-md-22-24{width:91.6667%}.pure-u-md-23-24{width:95.8333%}.pure-u-md-1,.pure-u-md-1-1,.pure-u-md-24-24,.pure-u-md-5-5{width:100%}}@media screen and (min-width:64em){.pure-u-lg-1,.pure-u-lg-1-1,.pure-u-lg-1-12,.pure-u-lg-1-2,.pure-u-lg-1-24,.pure-u-lg-1-3,.pure-u-lg-1-4,.pure-u-lg-1-5,.pure-u-lg-1-6,.pure-u-lg-1-8,.pure-u-lg-10-24,.pure-u-lg-11-12,.pure-u-lg-11-24,.pure-u-lg-12-24,.pure-u-lg-13-24,.pure-u-lg-14-24,.pure-u-lg-15-24,.pure-u-lg-16-24,.pure-u-lg-17-24,.pure-u-lg-18-24,.pure-u-lg-19-24,.pure-u-lg-2-24,.pure-u-lg-2-3,.pure-u-lg-2-5,.pure-u-lg-20-24,.pure-u-lg-21-24,.pure-u-lg-22-24,.pure-u-lg-23-24,.pure-u-lg-24-24,.pure-u-lg-3-24,.pure-u-lg-3-4,.pure-u-lg-3-5,.pure-u-lg-3-8,.pure-u-lg-4-24,.pure-u-lg-4-5,.pure-u-lg-5-12,.pure-u-lg-5-24,.pure-u-lg-5-5,.pure-u-lg-5-6,.pure-u-lg-5-8,.pure-u-lg-6-24,.pure-u-lg-7-12,.pure-u-lg-7-24,.pure-u-lg-7-8,.pure-u-lg-8-24,.pure-u-lg-9-24{display:inline-block;zoom:1;letter-spacing:normal;word-spacing:normal;vertical-align:top;text-rendering:auto}.pure-u-lg-1-24{width:4.1667%}.pure-u-lg-1-12,.pure-u-lg-2-24{width:8.3333%}.pure-u-lg-1-8,.pure-u-lg-3-24{width:12.5%}.pure-u-lg-1-6,.pure-u-lg-4-24{width:16.6667%}.pure-u-lg-1-5{width:20%}.pure-u-lg-5-24{width:20.8333%}.pure-u-lg-1-4,.pure-u-lg-6-24{width:25%}.pure-u-lg-7-24{width:29.1667%}.pure-u-lg-1-3,.pure-u-lg-8-24{width:33.3333%}.pure-u-lg-3-8,.pure-u-lg-9-24{width:37.5%}.pure-u-lg-2-5{width:40%}.pure-u-lg-10-24,.pure-u-lg-5-12{width:41.6667%}.pure-u-lg-11-24{width:45.8333%}.pure-u-lg-1-2,.pure-u-lg-12-24{width:50%}.pure-u-lg-13-24{width:54.1667%}.pure-u-lg-14-24,.pure-u-lg-7-12{width:58.3333%}.pure-u-lg-3-5{width:60%}.pure-u-lg-15-24,.pure-u-lg-5-8{width:62.5%}.pure-u-lg-16-24,.pure-u-lg-2-3{width:66.6667%}.pure-u-lg-17-24{width:70.8333%}.pure-u-lg-18-24,.pure-u-lg-3-4{width:75%}.pure-u-lg-19-24{width:79.1667%}.pure-u-lg-4-5{width:80%}.pure-u-lg-20-24,.pure-u-lg-5-6{width:83.3333%}.pure-u-lg-21-24,.pure-u-lg-7-8{width:87.5%}.pure-u-lg-11-12,.pure-u-lg-22-24{width:91.6667%}.pure-u-lg-23-24{width:95.8333%}.pure-u-lg-1,.pure-u-lg-1-1,.pure-u-lg-24-24,.pure-u-lg-5-5{width:100%}}@media screen and (min-width:80em){.pure-u-xl-1,.pure-u-xl-1-1,.pure-u-xl-1-12,.pure-u-xl-1-2,.pure-u-xl-1-24,.pure-u-xl-1-3,.pure-u-xl-1-4,.pure-u-xl-1-5,.pure-u-xl-1-6,.pure-u-xl-1-8,.pure-u-xl-10-24,.pure-u-xl-11-12,.pure-u-xl-11-24,.pure-u-xl-12-24,.pure-u-xl-13-24,.pure-u-xl-14-24,.pure-u-xl-15-24,.pure-u-xl-16-24,.pure-u-xl-17-24,.pure-u-xl-18-24,.pure-u-xl-19-24,.pure-u-xl-2-24,.pure-u-xl-2-3,.pure-u-xl-2-5,.pure-u-xl-20-24,.pure-u-xl-21-24,.pure-u-xl-22-24,.pure-u-xl-23-24,.pure-u-xl-24-24,.pure-u-xl-3-24,.pure-u-xl-3-4,.pure-u-xl-3-5,.pure-u-xl-3-8,.pure-u-xl-4-24,.pure-u-xl-4-5,.pure-u-xl-5-12,.pure-u-xl-5-24,.pure-u-xl-5-5,.pure-u-xl-5-6,.pure-u-xl-5-8,.pure-u-xl-6-24,.pure-u-xl-7-12,.pure-u-xl-7-24,.pure-u-xl-7-8,.pure-u-xl-8-24,.pure-u-xl-9-24{display:inline-block;zoom:1;letter-spacing:normal;word-spacing:normal;vertical-align:top;text-rendering:auto}.pure-u-xl-1-24{width:4.1667%}.pure-u-xl-1-12,.pure-u-xl-2-24{width:8.3333%}.pure-u-xl-1-8,.pure-u-xl-3-24{width:12.5%}.pure-u-xl-1-6,.pure-u-xl-4-24{width:16.6667%}.pure-u-xl-1-5{width:20%}.pure-u-xl-5-24{width:20.8333%}.pure-u-xl-1-4,.pure-u-xl-6-24{width:25%}.pure-u-xl-7-24{width:29.1667%}.pure-u-xl-1-3,.pure-u-xl-8-24{width:33.3333%}.pure-u-xl-3-8,.pure-u-xl-9-24{width:37.5%}.pure-u-xl-2-5{width:40%}.pure-u-xl-10-24,.pure-u-xl-5-12{width:41.6667%}.pure-u-xl-11-24{width:45.8333%}.pure-u-xl-1-2,.pure-u-xl-12-24{width:50%}.pure-u-xl-13-24{width:54.1667%}.pure-u-xl-14-24,.pure-u-xl-7-12{width:58.3333%}.pure-u-xl-3-5{width:60%}.pure-u-xl-15-24,.pure-u-xl-5-8{width:62.5%}.pure-u-xl-16-24,.pure-u-xl-2-3{width:66.6667%}.pure-u-xl-17-24{width:70.8333%}.pure-u-xl-18-24,.pure-u-xl-3-4{width:75%}.pure-u-xl-19-24{width:79.1667%}.pure-u-xl-4-5{width:80%}.pure-u-xl-20-24,.pure-u-xl-5-6{width:83.3333%}.pure-u-xl-21-24,.pure-u-xl-7-8{width:87.5%}.pure-u-xl-11-12,.pure-u-xl-22-24{width:91.6667%}.pure-u-xl-23-24{width:95.8333%}.pure-u-xl-1,.pure-u-xl-1-1,.pure-u-xl-24-24,.pure-u-xl-5-5{width:100%}}</style><style type=text/css media=screen>:root{--color:#484848;--color-footnote:#575757;--color-footer-content:#bbb;--background-color:rgb(252, 252, 252);--background-color-code:rgb(240, 240, 240);--background-color-toggle-content:rgb(249, 249, 249);--link-color:#c05b4d;--link-color-hover:#a5473a;--list-link-color:#336699;--border-navbar-and-footer:#e3e3e3}</style><style type=text/css media=screen>html{min-height:100%;width:100%;position:relative}body{background-color:#fcfcfc;background-color:var(--background-color);color:#484848;color:var(--color)}a{text-decoration:none}kbd,pre,code,samp{background-color:#f0f0f0;background-color:var(--background-color-code)}.nav-menu{margin-top:5px;padding-bottom:5px;border-bottom-width:1px;border-bottom-style:solid;border-bottom-color:#e3e3e3;border-bottom-color:var(--border-navbar-and-footer)}.pure-menu-heading{text-transform:none;font-size:large}.pure-menu-link:hover{background-color:unset}.header{text-align:left;color:#484848;color:var(--color);margin-bottom:.5em}.header ul li{height:auto}.header ul li a{font-weight:700;color:#484848;color:var(--color);font-family:source sans pro,helveticaneue,helvetica neue,Helvetica,Arial,sans-serif}.header{font-weight:700;color:#484848;color:var(--color);font-family:source sans pro,helveticaneue,helvetica neue,Helvetica,Arial,sans-serif}.site-title{color:#484848;color:var(--color);text-transform:none;font-weight:400;font-family:source sans pro,helveticaneue,helvetica neue,Helvetica,Arial,sans-serif}.pull-right{float:right}.posts-name{text-transform:capitalize;font-weight:700;padding-left:1em;margin-top:1em;font-family:source sans pro,helveticaneue,helvetica neue,Helvetica,Arial,sans-serif}.posts{font-family:verdana,arial,helvetica,sans-serif;list-style-type:none;padding-left:1em}.posts li p{margin-top:0}.posts li{margin-bottom:1em}.posts li>a{color:#369;color:var(--list-link-color);text-decoration:none}.post-list{font-size:large}.footnote{font-family:verdana,arial,helvetica,sans-serif;color:#575757;color:var(--color-footnote);font-size:.75em;margin-bottom:0}.footnote a{color:#575757;color:var(--color-footnote)}.footnote a:hover{text-decoration:underline;color:#369;color:var(--list-link-color)}.footer{position:absolute;z-index:2;height:auto;width:100%;bottom:0}.footer-content{border-top-width:1px;border-top-style:solid;border-top-color:#e3e3e3;border-top:1px solid var(--border-navbar-and-footer);font-size:80%;color:#bbb;color:var(--color-footer-content)}.footer-content a{color:#575757;color:var(--color-footnote)}.footer-content ul{height:auto;margin-top:0;margin-bottom:0;display:inline-block;padding-left:0}#TableOfContents>ul{list-style:none;margin:0;padding:0}#gototop-btn{display:inline-block}#foot-name{color:#484848;color:var(--color);text-transform:none}#foot-copyright{padding-left:1em;padding-bottom:.5em;margin:0}.post{font-family:proxima-nova,helvetica neue,Helvetica,Roboto,Arial,sans-serif;color:#484848;color:var(--color);letter-spacing:normal;padding-left:.5em}.post h1,h2,h3,h4,h5,h6{font-weight:700;letter-spacing:normal}.post-content{z-index:9;overflow:auto;padding:0;padding-bottom:3em;font-size:16px;line-height:1.4}.post-content img{max-width:100%;height:auto}.post-content pre{padding:.5em}.post a{color:#c05b4d;color:var(--link-color);text-decoration:none}.post a:hover{color:#a5473a;color:var(--link-color-hover);text-decoration:underline}.post h1{font-size:28px}.post h2{font-size:25px}.post h3{font-size:23px}.post h4{font-size:21px}.post h5{font-size:19px}.post h6{font-size:18px}.post-title{margin-top:0;margin-bottom:1em}.post-title h1{font-weight:700;font-size:39px;line-height:40px;margin-top:0;margin-bottom:0}@media screen and (max-width:768px){.desktop{display:none}.mobile{display:block}#toggle-btn{display:inline-block;float:right;padding:.5em 1em;text-decoration:none;color:#484848;color:var(--color);font-weight:700}#toggle-content li{clear:both;height:auto;background-color:#f9f9f9;background-color:var(--background-color-toggle-content)}#toggle-home{display:inline-block}}@media screen and (min-width:769px){.mobile{display:none}.desktop{display:block}}</style><link rel="shortcut icon" href=/img/favicon.ico type=image/x-icon></head><body><div class="header pure-g"><div class="pure-u-1-24 pure-u-md-2-24 pure-u-lg-5-24"></div><div class="pure-u-11-12 pure-u-md-20-24 pure-u-lg-7-12"><div class="desktop pure-menu pure-menu-horizontal nav-menu"><a href=/ class="site-title pure-menu-heading">随记</a><ul class="pure-menu-list pull-right"><li class=pure-menu-item><a href=/categories/development/ class=pure-menu-link>Development</a></li><li class=pure-menu-item><a href=/categories/os/ class=pure-menu-link>OS</a></li><li class=pure-menu-item><a href=/categories/reading/ class=pure-menu-link>Reading</a></li><li class=pure-menu-item><a href=/about/ class=pure-menu-link>About</a></li></ul></div><div class="mobile pure-menu nav-menu"><a href=/ class="site-title pure-menu-heading" id=toggle-home>随记</a>
<a href=# id=toggle-btn>&#9776;</a><ul class=pure-menu-list id=toggle-content style=display:none><li class=pure-menu-item><a href=/categories/development/ class=pure-menu-link>Development</a></li><li class=pure-menu-item><a href=/categories/os/ class=pure-menu-link>OS</a></li><li class=pure-menu-item><a href=/categories/reading/ class=pure-menu-link>Reading</a></li><li class=pure-menu-item><a href=/about class=pure-menu-link>About</a></li></ul></div></div><div class="pure-u-1-24 pure-u-md-2-24 pure-u-lg-5-24"></div></div><div class=pure-g><div class="pure-u-1-24 pure-u-md-2-24 pure-u-lg-5-24"></div><div class="pure-u-11-12 pure-u-md-20-24 pure-u-lg-7-12"><div class=post><div class=post-title><p class=footnote><time datetime="2018-12-31 17:30:00 +0800 CST">2018-12-31
</time>|
tags: [ <a href=/tags/unicode>Unicode</a> ]
categories: [ <a href=/categories/development>Development</a> ]</p><h1>其实你并不懂 Unicode</h1></div><div class=post-content><nav id=TableOfContents><ul><li><a href=#导言>导言</a></li><li><a href=#第一坑surrogate-pair>第一坑：surrogate pair</a></li><li><a href=#第二坑grapheme-cluster>第二坑：grapheme cluster</a></li><li><a href=#第三坑combining-character>第三坑：combining character</a></li><li><a href=#结语>结语</a></li></ul></nav><h2 id=导言>导言</h2><p>古有 Babel 通天塔，今有 Unicode 字符集，很多编程语言支持 Unicode，甚至在语法层面直接支持，绝大部分程序员可能会因此觉得自己懂 Unicode 了，自己的代码不需要特别注意就能处理世界上所有语言的字符了，觉得 Unicode 高大上真善美，其实并非如此，下面讲述下作为一个程序员，你需要了解的几个关键概念，里面颇有几个大坑，看看各位知道几个😄</p><h2 id=第一坑surrogate-pair>第一坑：surrogate pair</h2><p>关于 Unicode、BMP、UCS-2、UCS-4、UTF-8、UTF-16、UTF-32 的概念就不再赘述了，网上有很多讲述极好的文章，这里面有两个很重要的术语：</p><ol><li>code point: 指 Unicode 标准里“字符”的编号，目前 Unicode 使用了 0 ~ 0x10FFFF 的编码范围。这里字符二字加了引号，是因为这个概念很混淆，后面会再讲述。</li><li>code unit: 指某种 Unicode 编码方式里编码一个 code point 需要的最少字节，比如 UTF-8 需要最少一个字节，UTF-16 最少两个字节，UCS-2 两个字节，UCS-4 和 UTF-32 四个字节，后面三个是定长编码。</li></ol><p>早期的时候，Unicode 只用到了 0~0xFFFF 范围的数字编码，这就是 BMP 字符集，UCS-2 编码，很多语言就用 2 bytes 来表示 wchar_t 或者 char，典型的例子是 C/C++/Java。但后来 Unicode 组织胡搞瞎搞居然用到了超过这个范围的数字，于是就出来 surrogate pair 的概念了。</p><p>Surrogate pair 是专门用于 UTF-16 的，以向后兼容 UCS-2，做法是取 UCS-2 范围里的 0xD800<del>0xDBFF(称为 high surrogates) 和 0xDC00</del>0xDFFF(称为 low surrogates) 的 code point，一个 high surrogate 接一个 low surrogate 拼成四个字节表示超出 BMP 的字符，两个 surrogate range 都是 1024 个 code point，所以 surrogate pair 可以表达 1024 x 1024 = 1048576 = 0x100000 个字符，这就是 Unicode 的字符集范围上限是 0x10FFFF 的原因，为了照顾 UTF-16 以及一大堆采用了 UTF-16 的语言、操作系统（比如 Windows），这个上限不能突破，哪怕 UTF-8 和 UTF-32 可以编码更大的范围，实在是历史悲剧！</p><p>采用 2 bytes 表示 wide char 的编程语言，比如 C/C++/Java，就有一个大坑：</p><ul><li>string 的长度并不是切分成 char 数组的长度；</li><li>翻转 string 并不是简单的把 string 切分成 char 数组然后翻转数组并拼接！</li></ul><p>Java 的 String 内部用的 UTF-16 编码，其 <a href=https://docs.oracle.com/javase/10/docs/api/java/lang/String.html#length()>String.length()</a> <strong>不处理 surrogate pair</strong>，它直接返回 code unit 的个数，也就是 Java 的 2 字节 char 的个数，<strong>坑死人不赔命！</strong></p><p>Java 的 <a href=https://docs.oracle.com/javase/10/docs/api/java/lang/StringBuilder.html#reverse()>StringBuilder.reverse()</a> 和 <a href=https://docs.oracle.com/javase/10/docs/api/java/lang/StringBuffer.html#reverse()>StringBuffer.reverse()</a> 则都对 surrogate pair 特殊处理，会把这个 pair 当成单个字符看待，可喜可贺，但是有可能会把非 surrogate 转成 surrogate pair，比如 0xDC00 0xD800 这个字符串，第一个字符在 low surrogate 范围，第二个字符在 high surrogate 范围，由于顺序不符合 surrogate pair 标准，所以这是两个独立字符，但翻转后成了 0xD800 0xDC00，这是一个合法的 surrogate pair，表示一个字符，也就是两个字符翻转成了一个字符，等价于 <a href=http://www.decodeunicode.org/en/u+10000>0x100000</a>，这是 surrogate pair 规则的根深蒂固问题，倒也不怪 Java。</p><p>到这里，大家有没有理解 UCS-2，UTF-16 以及 surrogate pair 多么龌龊了吧，没理解的同学请自觉重读。</p><p>新兴编程语言 Rust 的设计很好，其 String 是 UTF-8 编码，其 char 是 UCS-4 编码，并且 char 指的是 <a href=http://unicode.org/glossary/#unicode_scalar_value>unicode scalar value</a>，这个术语指去掉 high surrogate 和 low surrogate 这 2048 个 code points 后剩下的 code points，这个设计非常完美，完全避开了 surrogate pair—— surrogate pair 表达的字符就用 0x10000 ~ 0x100000 范围直接表达了。</p><p>然而，Rust 并没有做到极致，不能直接在语言里处理 grapheme cluster 概念，而是要借助外部库，非常可惜。 Grapheme cluster 概念就是 Unicode 的第二大坑，且听我道来。</p><h2 id=第二坑grapheme-cluster>第二坑：grapheme cluster</h2><p>倘若你很牛掰知道 surrogate pair，我猜你极大概率不知道 grapheme cluster 这玩意。如同 phoneme 这个单词是表示听觉上的音素、音位，表示听觉上可以分辨的最小单元，<a href=http://unicode.org/glossary/#grapheme>grapheme</a> 这个单词表示视觉上的字素、字位，也就是人们识别的、口头指称的“字符”，<a href=http://unicode.org/glossary/#grapheme_cluster>grapheme cluster</a> 实际就是指 grapheme，我没看懂 Unicode glossary 中这俩术语的区别。 大概是由于 <a href=https://unicode.org/reports/tr29/>Unicode Text Segmenation</a> 这个标准的缘故，现在大家用 grapheme cluster 这个称呼更多。</p><p>举两个例子，印地语天城文的 नमस्ते 是英语 hello 的意思：</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>&gt; jshell
</span></span><span style=display:flex><span>|  Welcome to JShell -- Version 11
</span></span><span style=display:flex><span>|  For an introduction type: /help intro
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>jshell&gt; var s = &#34;नमस्ते&#34;;
</span></span><span style=display:flex><span>s ==&gt; &#34;नमस्ते&#34;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>jshell&gt; s.length()
</span></span><span style=display:flex><span>$2 ==&gt; 6
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>jshell&gt; s.split(&#34;\\b{g}&#34;)
</span></span><span style=display:flex><span>$3 ==&gt; String[4] { &#34;न&#34;, &#34;म&#34;, &#34;स्&#34;, &#34;ते&#34; }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>jshell&gt; s.toCharArray()
</span></span><span style=display:flex><span>$4 ==&gt; char[6] { &#39;न&#39;, &#39;म&#39;, &#39;स&#39;, &#39;्&#39;, &#39;त&#39;, &#39;े&#39; }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>jshell&gt; for (var c : s.toCharArray()) System.out.printf(&#34;%c %X\n&#34;, c, (int)c)
</span></span><span style=display:flex><span>न 928
</span></span><span style=display:flex><span>म 92E
</span></span><span style=display:flex><span>स 938
</span></span><span style=display:flex><span> ् 94D
</span></span><span style=display:flex><span>त 924
</span></span><span style=display:flex><span> े 947
</span></span></code></pre></div><p>可以看到，这个天城文字符串包含了 6 个 UTF-16 code units，6 个 Unicode code points，并且不是 surrogate code point，所以它按理说是 6 个 &ldquo;Unicode character&rdquo;。 但其实它是 4 个 grapheme clusters，也就是说“人可以识别的 4 个字符”。这里 \b{g} 是 JDK 9 新加的正则表达式语法，表示 grapheme cluster 边界。JDK 8 还新增了 \X 表示一个 grapheme cluster(这是抄的 Perl 5 正则表达式语法）。</p><p>另一个取自 Python 库 <a href=https://pypi.org/project/grapheme/>grapheme</a> 的例子，这个诡异的下划线单词：u̲n̲d̲e̲r̲l̲i̲n̲e̲d̲，注意这并不是大家常见的那种下划线，这里的下划线是字符本身自带的。这个字符串是 10 个字符(grapheme clusters)，但它对应了 20 个 Unicode code points！</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>&gt; jshell
</span></span><span style=display:flex><span>|  Welcome to JShell -- Version 11
</span></span><span style=display:flex><span>|  For an introduction type: /help intro
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>jshell&gt; var s = &#34;u̲n̲d̲e̲r̲l̲i̲n̲e̲d̲&#34;;
</span></span><span style=display:flex><span>s ==&gt; &#34;u̲n̲d̲e̲r̲l̲i̲n̲e̲d̲&#34;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>jshell&gt; s.length()
</span></span><span style=display:flex><span>$2 ==&gt; 20
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>jshell&gt; s.split(&#34;\\b{g}&#34;)
</span></span><span style=display:flex><span>$3 ==&gt; String[10] { &#34;u̲&#34;, &#34;n̲&#34;, &#34;d̲&#34;, &#34;e̲&#34;, &#34;r̲&#34;, &#34;l̲&#34;, &#34;i̲&#34;, &#34;n̲&#34;, &#34;e̲&#34;, &#34;d̲&#34; }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>jshell&gt; s.toCharArray()
</span></span><span style=display:flex><span>$4 ==&gt; char[20] { &#39;u&#39;, &#39;̲&#39;, &#39;n&#39;, &#39;̲&#39;, &#39;d&#39;, &#39;̲&#39;, &#39;e&#39;, &#39;̲&#39;, &#39;r&#39;, &#39;̲&#39;, &#39;l&#39;, &#39;̲&#39;, &#39;i&#39;, &#39;̲&#39;, &#39;n&#39;, &#39;̲&#39;, &#39;e&#39;, &#39;̲&#39;, &#39;d&#39;, &#39;̲&#39; }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>jshell&gt; for (var c : s.toCharArray()) System.out.printf(&#34;%c %X\n&#34;, c, (int)c)
</span></span><span style=display:flex><span>u 75
</span></span><span style=display:flex><span> ̲ 332
</span></span><span style=display:flex><span>n 6E
</span></span><span style=display:flex><span> ̲ 332
</span></span><span style=display:flex><span>d 64
</span></span><span style=display:flex><span> ̲ 332
</span></span><span style=display:flex><span>e 65
</span></span><span style=display:flex><span> ̲ 332
</span></span><span style=display:flex><span>r 72
</span></span><span style=display:flex><span> ̲ 332
</span></span><span style=display:flex><span>l 6C
</span></span><span style=display:flex><span> ̲ 332
</span></span><span style=display:flex><span>i 69
</span></span><span style=display:flex><span> ̲ 332
</span></span><span style=display:flex><span>n 6E
</span></span><span style=display:flex><span> ̲ 332
</span></span><span style=display:flex><span>e 65
</span></span><span style=display:flex><span> ̲ 332
</span></span><span style=display:flex><span>d 64
</span></span><span style=display:flex><span> ̲ 332
</span></span></code></pre></div><p>这个字符串用 Java 的 new StringBuilder(s).reverse() 翻转，<strong>结果是错的</strong>，有兴趣的同学可以试验下。</p><p>好的，问题来了，要怎么正确的按照 grapheme cluster 来翻转这些奇特的字符串呢？我给两个例子，大家可以再发挥下各自喜爱的语言，看你喜爱的语言标准功能能否处理，是否要借助第三方库——要借用第三方库是比较矬的，而完全处理不了的语言则是最矬的！</p><p>第一个例子是 Perl 的，作为拥有史上最强、当今最强正则表达式引擎的编程语言，它同样是Unicode支持当今最强语言，没有之一！2002 年发布的 Perl 5.8.0 是第一个推荐使用的支持 Unicode 的版本，到 2017 年发布的 Perl 5.26.0，2018 年发布的 Perl 5.28.0，<strong>十六年</strong>的努力，Perl 在向后兼容的同时，在字符串、正则表达式、标准库上原生的完美支持最新 Unicode 标准，“你们 Python 粉啊，对 Perl 的力量一无所知！”</p><p>Perl 的手册页 <a href="https://perldoc.perl.org/perluniintro.html#Perl's-Unicode-Support">perluniintro</a>、<a href=https://perldoc.perl.org/perlunicook.html#%211e-32%3a-Reverse-string-by-grapheme>perlunicook</a>、<a href=https://perldoc.perl.org/perlunifaq.html>perlunifaq</a> 对其 Unicode 支持有极好的介绍，下面这段代码来自 perlunicook，核心代码是 reverse $s =~ /\X/g 这句，\X 表示匹配 grapheme cluster。</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>&gt; cat a.pl
</span></span><span style=display:flex><span>#!/usr/bin/perl
</span></span><span style=display:flex><span>use utf8;      # so literals and identifiers can be in UTF-8
</span></span><span style=display:flex><span>use v5.12;     # or later to get &#34;unicode_strings&#34; feature
</span></span><span style=display:flex><span>use strict;    # quote strings, declare variables
</span></span><span style=display:flex><span>use warnings;  # on by default
</span></span><span style=display:flex><span>use warnings  qw(FATAL utf8);    # fatalize encoding glitches
</span></span><span style=display:flex><span>use open      qw(:std :encoding(UTF-8)); # undeclared streams in UTF-8
</span></span><span style=display:flex><span>use charnames qw(:full :short);  # unneeded in v5.16
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>my $s =  &#34;नमस्ते&#34;;
</span></span><span style=display:flex><span>my @a = $s =~ /(\X)/g;
</span></span><span style=display:flex><span>print &#34;$s\n&#34;;
</span></span><span style=display:flex><span>print join(&#34; &#34;, @a), &#34;\n&#34;;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>my $str = join(&#34;&#34;, reverse $s =~ /\X/g);
</span></span><span style=display:flex><span>@a = $str =~ /(\X)/g;
</span></span><span style=display:flex><span>print &#34;$str\n&#34;;
</span></span><span style=display:flex><span>print join(&#34; &#34;, @a), &#34;\n&#34;;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>&gt; perl a.pl
</span></span><span style=display:flex><span>नमस्ते
</span></span><span style=display:flex><span>न म स् ते
</span></span><span style=display:flex><span>तेस्मन
</span></span><span style=display:flex><span>ते स् म न
</span></span></code></pre></div><p>Java >= 9 的支持也不错：</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>&gt; jshell
</span></span><span style=display:flex><span>|  Welcome to JShell -- Version 11
</span></span><span style=display:flex><span>|  For an introduction type: /help intro
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>jshell&gt; import java.util.*;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>jshell&gt; var s = &#34;नमस्ते&#34;;
</span></span><span style=display:flex><span>s ==&gt; &#34;नमस्ते&#34;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>jshell&gt; var a = Arrays.asList(s.split(&#34;\\b{g}&#34;))
</span></span><span style=display:flex><span>a ==&gt; [न, म, स्, ते]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>jshell&gt; Collections.reverse(a)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>jshell&gt; String.join(&#34;&#34;, a).split(&#34;\\b{g}&#34;)
</span></span><span style=display:flex><span>$5 ==&gt; String[4] { &#34;ते&#34;, &#34;स्&#34;, &#34;म&#34;, &#34;न&#34; }
</span></span></code></pre></div><p>除了用 \b{g}，也可以用 Java 8 的 \X 以及 java.util.regex.Pattern 类处理, 或者 java.text.BreakIterator:</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>&gt; jshell
</span></span><span style=display:flex><span>|  Welcome to JShell -- Version 11
</span></span><span style=display:flex><span>|  For an introduction type: /help intro
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>jshell&gt; import java.util.*;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>jshell&gt; import java.text.*;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>jshell&gt; var s = &#34;नमस्ते&#34;;
</span></span><span style=display:flex><span>s ==&gt; &#34;नमस्ते&#34;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>jshell&gt; var iter = BreakIterator.getCharacterInstance(Locale.US);
</span></span><span style=display:flex><span>iter ==&gt; [checksum=0xee8de505]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>jshell&gt; iter.setText(s);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>jshell&gt; var end = iter.last();
</span></span><span style=display:flex><span>end ==&gt; 4
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>jshell&gt; for (var start = iter.previous(); start != BreakIterator.DONE; end = start, start = iter.previous()) System.out.println(s.substring(start, end))
</span></span><span style=display:flex><span>ते
</span></span><span style=display:flex><span>स्
</span></span><span style=display:flex><span>म
</span></span><span style=display:flex><span>न
</span></span></code></pre></div><p>综上，<strong>一个 Unicode native 的编程语言，其 char 类型应该至少是 4 bytes，其字符串、正则表达式应该能以 grapheme cluster 为“字符”单位</strong>。</p><p>从古至今，编程语言层出不穷，但在 string 类型直接考虑 grapheme cluster 的凤毛麟角，这其中 <a href=http://erlang.org/doc/man/string.html>Erlang</a> 语言以及基于 Erlang 的 <a href=https://hexdocs.pm/elixir/String.html>Elixir</a> 语言就是这个凤毛麟角——“你们 Go 粉啊，对 Erlang 的力量一无所知！“</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>&gt; erl
</span></span><span style=display:flex><span>Erlang/OTP 20 [erts-9.1.5] [source] [64-bit] [smp:8:8] [ds:8:8:10] [async-threads:10] [hipe] [kernel-poll:false] [dtrace]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Eshell V9.1.5  (abort with ^G)
</span></span><span style=display:flex><span>1&gt; Reverse = string:reverse(&#34;नमस्ते&#34;).
</span></span><span style=display:flex><span>[[2340,2375],[2360,2381],2350,2344]
</span></span><span style=display:flex><span>2&gt; io:format(&#34;~ts~n&#34;,[Reverse]).
</span></span><span style=display:flex><span>तेस्मन
</span></span><span style=display:flex><span>ok
</span></span><span style=display:flex><span>3&gt;
</span></span></code></pre></div><p>在对待 grapheme cluster 上，macOS、Windows 都没能幸免，在 macOS Safari、notes、Chrome、MS Word 以及 Windows 上的 Notepad 试验后发现，它们对于 नमस्ते 的处理非常奇怪：</p><ul><li>主窗口的文本输入框里，从光标移动上看，它们把这个字符串认为是三个字符，在 Safari 和 Chrome 的地址栏输入框里，从光标移动上看，它俩认为这是四个字符；</li><li>从这个字符串末尾按 Delete(mac) or Backspace(Windows) 删除，需要按六次才能删完，也就是说按六个 code point 处理的；</li><li>从这个字符串开头按 Fn-Delete(mac) or Delete(Windows)删除，只需要按三次就能删完，不知道什么鬼；</li></ul><p>联系到 glyph 的渲染本身又是一大坑，有 ligature 这种奇葩玩意，我只能庆幸我没进入前端开发领域😄</p><p>OK, 到这里估计你们对 Unicode 已经累觉不爱了，不好意思，没完，咱再看 Unicode 第三坑。</p><h2 id=第三坑combining-character>第三坑：combining character</h2><p>从上面两坑我们学习到，有两个 surrogate code point 组成一个"字符"(unicode scalar value)，有多个 unicode scalar value 组成一个“字符”(grapheme cluster)，但其实还有一种情况：一个 Unicode 字符有多种表示形式，单个 code point 表示以及多个非 surrogate code points 的组合形式。</p><p>出现这种组合的原因主要是变音符号(diacritical marks)，这里面包含了重音符号(accent)，这是来自<a href=https://en.wikipedia.org/wiki/Combining_character>维基百科</a>的一张表：</p><p><img src=combining-diacritical-marks.jpg alt="Combining Diacritical Marks"></p><p>很多语言里都有这种带变音符号的字母，比如 <strong>He̊llö</strong> 里面很个性的 e 和 o，比如下面这张海报：</p><p><img src=i-wish-the-english-language-had-more-interesting-characters.jpg alt="I wish the English language had more interesting characters"></p><p>为什么要有组合字符呢？因为大家都想给某个字符加各种变音符号，如果给每个组合都申请一个 code point，那恐怕 Unicode 0x10FFFF 个 code point 没多久就用光了，大家也没机会吃饱了撑的往 Unicode 里加 emoji 字符了。。。据说韩国人很精明，他们给韩文的组合字符申请了单独的 code point，而印度人没太在意这事😄</p><p>更坑爹的是，拉丁字母里带变音符号的字符使用广泛，早已经单独收入 Unicode 里了，所以出现一个 Unicode 字符会有多种 code point 表示的情况，也就牵涉到Unicode 标准 <a href=http://unicode.org/reports/tr15/>Unicode normalization forms</a>，这就是 Perl 的内置标准模块 <a href=https://perldoc.perl.org/Unicode/Normalize.html>Unicode::Normalize</a> 的用途，只有 normalization 之后，在代码里才能用普通的 &ldquo;==&rdquo; 操作符或者 &ldquo;equals()&rdquo; 方法等可靠的判断 Unicode 字符、字符串的等价。</p><p>Unicode 定义了两种等价关系：canonical equivalence 和 compatibility equivalence，前者严格、保守，指组合前后的字符在显示上是相同的，后者则宽泛、激进，显示上不同但认为是等价字符，如下图所示。</p><p><img src=examples-of-canonical-equivalence.jpg alt="Examples of Canonical Equivalence"></p><p><img src=examples-of-compatibility-equivalence.jpg alt="Examples of Compatibility Equivalence"></p><p>两种等价方式带来四种 normalization form:</p><ul><li>Canonical Equivalence<ul><li>Normalization Form D (NFD): 把单 code point 表示的字符拆开(Decompose)成多个 code point 表示形式，并对一个字符的多个 code point 进行规范排序（比如一个字符上下各有一个点，那么总得有一个点对应的 code point 排在另一个点对应的 code point 前面）；</li><li>Normalization Form C(NFC)：把多个 code point 形式组合（compose）成单 code point 形式，如果没有单 code point 形式，则做一个正规排序</li></ul></li><li>Compatibility Equivalence<ul><li>Normalization Form KD(NFKD): 这里的 K 指 Compatibility。意义与 NFD 类似。</li><li>Normalization Form KC(NFKC): 意义与 NFC 类似。</li></ul></li></ul><p>这四种 normalization form 对应 Perl 标准模块 <a href=https://perldoc.perl.org/Unicode/Normalize.html>Unicode::Normalize</a> 里四个同名函数。用法是这样的：</p><ol><li>如果你的业务逻辑需要比较严的等价变换，那么对外部输入文本先做 NFD，这个意图是把 Å (A 上一个小圆圈）变成 A + 小圆圈，这样在排序等场合符合直觉，然后在处理完后 NFC，把组合字符尽可能变成单个 code point，以节约存储。</li><li>如果你的业务逻辑需要比较宽的等价变化，那么类似，输入经过 NFKD，业务处理，然后经过 NFKC，输出。</li></ol><p>这个用法在 perlunicook 的 <a href=https://perldoc.perl.org/perlunicook.html#%211e-1%3a-Generic-Unicode-savvy-filter>Generic Unicode-savvy filter</a>一节有讲到。</p><p>有个需要注意的点是，<strong>同一个 Unicode string，经过 NFD 再 NFC 后，其未必等于原始字符串</strong>，原因是有的同一个字符，在 Unicode 中有多个单 code point 表示，也许是规范制定过程中参与人员太多、字符太多、历时太长导致的失误或者兼容性考虑。下面是 <a href=http://unicode.org/reports/tr15/#Norm_Forms>Unicode Normalization Forms</a>标准中的一个例子：</p><p><img src=unicode-singletons.jpg alt="Unicode Singletons"></p><h2 id=结语>结语</h2><p>恭喜您看到这里，感谢您的耐心，您的 Unicode 技能水平打败全球 99.99% 的程序员了，从此以后，您可以底气十足的跟人说“你这语言 or 软件的 Unicode 支持很烂嘛，水平不行啊”！其实昨天之前我也不知道 surrogate pair 之后的坑，在阅读 The Rust Programming Language 一书时了解到 grapheme cluster 的概念，然后研究之下发现道道还挺多🤦‍♂️不过话说来，虽然 Unicode 细节坑死人，依然不妨碍它是人类信息技术历史上伟大的通天塔，功德无量！而随着 emoji 字符的盛行，跨文化交流的盛行，大家使用的、编写的软件还是会时不时遇到这些坑的，比如编辑器、终端模拟器里的字符对齐。</p><p>最后，安利下 Rust 语言，如今 Rust 1.31.1 已经发布，语法趋于成熟，“一百种指针的写法”时代已经成为过去（可怜 2015 年 Rust 1.0 发布，2017 年底才算语法趋于尘埃落定），这是一份深思熟虑了八年的 Better C++，在 C++ 一脉的零开销抽象上再上一层楼，同时提供极高的内存安全性，内存使用效率，运行效率，您可以入手开始轮了，祝愿 Rust 在小工具、高性能低延迟服务端、游戏、大数据、科学计算等等领域发光发热，也算 Mozilla 泉下瞑目了😄</p></div></div></div><div class="pure-u-1-24 pure-u-md-2-24 pure-u-lg-5-24"></div></div><div class="footer pure-g"><div class="pure-u-1-24 pure-u-md-2-24 pure-u-lg-5-24"></div><div class="pure-u-11-12 pure-u-md-20-24 pure-u-lg-7-12"><div class=footer-content><div class="pure-menu pure-menu-horizontal"><ul><li class=pure-menu-item id=foot-name>© Yubao Liu</li></ul><a href=# class="pure-menu-link pull-right" id=gototop-btn>↑↑</a></div></div></div><div class="pure-u-1-24 pure-u-md-2-24 pure-u-lg-5-24"></div></div><script type=text/javascript>go(),window.addEventListener("resize",go);function go(){var e=document.querySelector(".desktop");document.documentElement.clientWidth>768?e.style.display="":e.style.display="none"}</script><script type=text/javascript>var a=document.querySelector("#toggle-btn"),b=document.querySelector("#toggle-content");a.addEventListener("click",function(){""==b.style.display?(b.style.display="none",a.innerHTML="☰"):(b.style.display="",a.innerHTML="X")})</script></body></html>